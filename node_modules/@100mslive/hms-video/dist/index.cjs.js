var gr=Object.create;var Ne=Object.defineProperty,Sr=Object.defineProperties,vr=Object.getOwnPropertyDescriptor,Tr=Object.getOwnPropertyDescriptors,fr=Object.getOwnPropertyNames,Qe=Object.getOwnPropertySymbols,Er=Object.getPrototypeOf,Ct=Object.prototype.hasOwnProperty,Ti=Object.prototype.propertyIsEnumerable;var fi=(a,e,t)=>e in a?Ne(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,v=(a,e)=>{for(var t in e||(e={}))Ct.call(e,t)&&fi(a,t,e[t]);if(Qe)for(var t of Qe(e))Ti.call(e,t)&&fi(a,t,e[t]);return a},L=(a,e)=>Sr(a,Tr(e)),Ei=a=>Ne(a,"__esModule",{value:!0});var Rt=(a,e)=>{var t={};for(var i in a)Ct.call(a,i)&&e.indexOf(i)<0&&(t[i]=a[i]);if(a!=null&&Qe)for(var i of Qe(a))e.indexOf(i)<0&&Ti.call(a,i)&&(t[i]=a[i]);return t};var kr=(a,e)=>()=>(e||a((e={exports:{}}).exports,e),e.exports),yr=(a,e)=>{Ei(a);for(var t in e)Ne(a,t,{get:e[t],enumerable:!0})},Mr=(a,e,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of fr(e))!Ct.call(a,i)&&i!=="default"&&Ne(a,i,{get:()=>e[i],enumerable:!(t=vr(e,i))||t.enumerable});return a},J=a=>Mr(Ei(Ne(a!=null?gr(Er(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var c=(a,e,t)=>new Promise((i,r)=>{var s=l=>{try{d(t.next(l))}catch(h){r(h)}},n=l=>{try{d(t.throw(l))}catch(h){r(h)}},d=l=>l.done?i(l.value):Promise.resolve(l.value).then(s,n);d((t=t.apply(a,e)).next())});var bi=kr((ks,Cr)=>{Cr.exports={name:"@100mslive/hms-video",version:"0.7.4",license:"MIT",main:"dist/index.cjs.js",typings:"dist/index.d.ts",module:"dist/index.js",files:["dist","src"],engines:{node:">=10"},exports:{".":{require:"./dist/index.cjs.js",import:"./dist/index.js",default:"./dist/index.js"}},scripts:{prestart:"rm -rf dist && yarn types:build",start:'concurrently "yarn dev" "yarn types"',dev:"node ../../scripts/dev","build:only":"node ../../scripts/build",build:"yarn build:only && yarn types:build",types:"tsc -w","types:build":"tsc -p tsconfig.json",test:"jest --maxWorkers=1",lint:"eslint -c ../../.eslintrc .","lint:fix":"yarn lint --fix",prepare:"yarn build",size:"size-limit",analyze:"size-limit --why",format:"prettier --write src/**/*.ts"},author:"100ms <tech-common@100ms.live>",devDependencies:{"@types/sdp-transform":"^2.4.4","@types/ua-parser-js":"^0.7.36","@types/uuid":"^8.3.0","jest-canvas-mock":"^2.3.1",tslib:"^2.2.0"},dependencies:{eventemitter2:"^6.4.7","sdp-transform":"^2.14.1","ua-parser-js":"^1.0.1",uuid:"^8.3.2","webrtc-adapter":"^8.0.0"},gitHead:"36f8d865f05deffecd7a64fb7f3aba1070561584"}});yr(exports,{DeviceType:()=>Ot,ENV:()=>$,HMSAudioCodec:()=>Ue,HMSAudioContextHandler:()=>ne,HMSAudioPluginType:()=>st,HMSAudioPluginsManager:()=>Ge,HMSAudioTrack:()=>Re,HMSException:()=>T,HMSLocalAudioTrack:()=>fe,HMSLocalVideoTrack:()=>z,HMSLogLevel:()=>U,HMSPeerUpdate:()=>K,HMSPlaylistType:()=>b,HMSPluginUnsupportedTypes:()=>ie,HMSRemoteAudioTrack:()=>ct,HMSRemoteVideoTrack:()=>Se,HMSRoomUpdate:()=>ae,HMSSdk:()=>mr,HMSSimulcastLayer:()=>q,HMSTrack:()=>pe,HMSTrackType:()=>F,HMSTrackUpdate:()=>D,HMSVideoCodec:()=>Fe,HMSVideoPluginCanvasContextType:()=>He,HMSVideoPluginType:()=>Ee,HMSVideoPluginsManager:()=>Ve,HMSVideoTrack:()=>we,HMSWebrtcInternals:()=>Je,HMSWebrtcStats:()=>je,getAnalyticsDeviceId:()=>Ht,getLocalDevices:()=>Nr,getLocalScreen:()=>Dr,getLocalStream:()=>Ft,isBrowser:()=>X,isIOS:()=>Ye,isMobile:()=>wt,isNode:()=>ue,isPageHidden:()=>Lt,isSupported:()=>Pr,parsedUserAgent:()=>le,simulcastMapping:()=>tt,validateDeviceAV:()=>Kr});var vi=J(require("webrtc-adapter"));var yi=J(require("ua-parser-js")),Mi=J(require("uuid"));var re=class{constructor(e){this.key=e;this.storage=null}getStorage(){return X&&!this.storage&&(ki(),this.storage=window.localStorage),this.storage}get(){var i;let e=(i=this.getStorage())==null?void 0:i.getItem(this.key);return e?JSON.parse(e):void 0}set(e){var i;let t=JSON.stringify(e);(i=this.getStorage())==null||i.setItem(this.key,t)}clear(){var e;(e=this.getStorage())==null||e.removeItem(this.key)}};var le=new yi.UAParser,Ai,ue=typeof window=="undefined"&&!((Ai=le.getBrowser().name)==null?void 0:Ai.toLowerCase().includes("electron")),X=typeof window!="undefined",$;(function(i){i.PROD="prod",i.QA="qa",i.DEV="dev"})($||($={}));var Ar=()=>!ue,Pr=Ar(),wt=()=>le.getDevice().type==="mobile",Ht=()=>{let a,e=new re("hms-analytics-deviceId"),t=e.get();return t?a=t:(a=(0,Mi.v4)(),e.set(a)),a},Lt=()=>typeof document!="undefined"&&document.hidden,Ye=()=>{var a;return((a=le.getOS().name)==null?void 0:a.toLowerCase())==="ios"};var Pi=class{constructor(){this.valuesMap=new Map}getItem(e){return this.valuesMap.has(e)?String(this.valuesMap.get(e)):null}setItem(e,t){this.valuesMap.set(e,t)}removeItem(e){this.valuesMap.delete(e)}clear(){this.valuesMap.clear()}key(e){if(arguments.length===0)throw new TypeError("Failed to execute 'key' on 'Storage': 1 argument required, but only 0 present.");return Array.from(this.valuesMap.keys())[e]}get length(){return this.valuesMap.size}},ki=()=>{X&&!localStorage&&(window.localStorage=new Pi)};var U;(function(l){l[l.VERBOSE=0]="VERBOSE",l[l.DEBUG=1]="DEBUG",l[l.INFO=2]="INFO",l[l.WARN=3]="WARN",l[l.TIME=4]="TIME",l[l.TIMEEND=5]="TIMEEND",l[l.ERROR=6]="ERROR",l[l.NONE=7]="NONE"})(U||(U={}));var Ir=typeof window!="undefined"&&typeof window.expect!="undefined",o=class{static v(e,...t){this.log(0,e,...t)}static d(e,...t){this.log(1,e,...t)}static i(e,...t){this.log(2,e,...t)}static w(e,...t){this.log(3,e,...t)}static e(e,...t){this.log(6,e,...t)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanUp(){performance.clearMarks(),performance.clearMeasures()}static log(e,t,...i){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:{console.log(t,...i);break}case 1:{console.debug(t,...i);break}case 2:{console.info(t,...i);break}case 3:{console.warn(t,...i);break}case 6:{console.error(t,...i);break}case 4:{performance.mark(i[0]);break}case 5:{let r=i[0];try{let s=performance.measure(r,r);this.log(1,t,r,s==null?void 0:s.duration),performance.clearMarks(r),performance.clearMeasures(r)}catch(s){this.log(1,t,r,s)}break}}}};o.level=Ir?7:0;var Me=class{constructor({sender:e,message:t,type:i="chat",recipientPeer:r,recipientRoles:s,time:n}){this.sender=e,this.message=t,this.type=i,this.recipientPeer=r,this.recipientRoles=s,this.time=n}toSignalParams(){var r,s;let e=(r=this.recipientRoles)==null?void 0:r.map(n=>n.name),t=(s=this.recipientPeer)==null?void 0:s.peerId,i={info:{message:this.message,type:this.type}};return(e==null?void 0:e.length)&&(i.roles=e),t&&(i.peer_id=t),i}toString(){var e;return`{
      sender: ${this.sender};
      recipientPeer: ${this.recipientPeer};
      recipientRoles: ${(e=this.recipientRoles)==null?void 0:e.map(t=>t.name)};
      message: ${this.message};
      time: ${this.time};
      type: ${this.type};
    }`}};var ze=class{constructor(e,t){this.id=e;this.store=t;this.recording={server:{running:!1},browser:{running:!1},hls:{running:!1}};this.rtmp={running:!1};this.hls={running:!1,variants:[]}}get localPeer(){return this.store.getLocalPeer()}get peers(){return this.store.getPeers()}};var he=class{constructor({peerId:e,name:t,isLocal:i,customerUserId:r,metadata:s,role:n,joinedAt:d}){this.customerUserId="";this.metadata="";this.auxiliaryTracks=[];this.name=t,this.peerId=e,this.isLocal=i,this.customerUserId=r,this.metadata=s,this.joinedAt=d,n&&(this.role=n)}updateRole(e){this.role=e}updateName(e){this.name=e}updateMetadata(e){this.metadata=e}toString(){var e,t,i;return`{
      name: ${this.name};
      role: ${(e=this.role)==null?void 0:e.name};
      peerId: ${this.peerId};
      customerUserId: ${this.customerUserId};
      ${this.audioTrack?`audioTrack: ${(t=this.audioTrack)==null?void 0:t.trackId};`:""}
      ${this.videoTrack?`videoTrack: ${(i=this.videoTrack)==null?void 0:i.trackId};`:""}
    }`}};var Ii=J(require("uuid")),Oe=class{};Oe.makePeerId=()=>(0,Ii.v4)();var Ze=class extends he{constructor(e){super(L(v({},e),{peerId:Oe.makePeerId(),isLocal:!0}));this.isLocal=!0;this.auxiliaryTracks=[];this.asRole=e.asRole}isInPreview(){return!!this.asRole}toString(){var e,t,i;return`{
      name: ${this.name};
      role: ${(e=this.role)==null?void 0:e.name};
      peerId: ${this.peerId};
      customerUserId: ${this.customerUserId};
      ${this.asRole?`asRole: ${this.asRole.name};`:""}
      ${this.audioTrack?`audioTrack: ${(t=this.audioTrack)==null?void 0:t.trackId};`:""}
      ${this.videoTrack?`videoTrack: ${(i=this.videoTrack)==null?void 0:i.trackId};`:""}
    }`}};var Xe=class extends he{constructor(e){super(L(v({},e),{isLocal:!1}));this.isLocal=!1;this.auxiliaryTracks=[];this.fromRoomState=!1;this.fromRoomState=!!e.fromRoomState}};var ji=J(require("uuid"));var wi=J(require("uuid"));var se;(function(i){i.CUSTOM="CUSTOM",i.LOCAL="LOCAL",i.HMS="HMS"})(se||(se={}));function br(){if(X&&window){let a=window.location.hostname;return a==="localhost"||a==="127.0.0.1"?se.LOCAL:a.includes("app.100ms.live")?se.HMS:se.CUSTOM}return se.CUSTOM}var Ae=br();var Ci=bi().version;function xe(a=$.PROD,e){let t="web",i=Ae!==se.LOCAL&&a===$.PROD?"prod":"debug";if(ue)return Ri({os:"web_nodejs",os_version:process.version,sdk:t,sdk_version:Ci,env:i,domain:Ae,framework:"node",framework_version:process.version,framework_sdk_version:e==null?void 0:e.sdkVersion});let r=le.getOS(),s=le.getDevice(),n=le.getBrowser(),d=_t(`web_${r.name}`),l=r.version||"",h=_t(`${n.name}_${n.version}`),u=h;return s.type&&(u=`${_t(`${s.vendor}_${s.type}`)}/${h}`),Ri({os:d,os_version:l,sdk:t,sdk_version:Ci,device_model:u,env:i,domain:Ae,framework:e==null?void 0:e.type,framework_version:e==null?void 0:e.version,framework_sdk_version:e==null?void 0:e.sdkVersion})}function _t(a){return a.replace(/ /g,"_")}var Ri=(a,e=",")=>Object.keys(a).filter(t=>!!a[t]).map(t=>`${t}:${a[t]}`).join(e);var x=class{constructor({name:e,level:t,properties:i,includesPII:r,timestamp:s}){this.metadata={peer:{},userAgent:xe()};this.name=e,this.level=t,this.includesPII=r||!1,this.properties=i||{},this.timestamp=s||new Date().getTime(),this.event_id=(0,wi.v4)(),this.device_id=Ht()}toSignalParams(){return{name:this.name,info:L(v({},this.properties),{timestamp:this.timestamp,domain:Ae}),timestamp:new Date().getTime()}}};var et;(function(r){r[r.VERBOSE=0]="VERBOSE",r[r.INFO=1]="INFO",r[r.ERROR=2]="ERROR",r[r.OFF=3]="OFF"})(et||(et={}));var _;(function(r){r[r.VERBOSE=0]="VERBOSE",r[r.INFO=1]="INFO",r[r.ERROR=2]="ERROR",r[r.OFF=3]="OFF"})(_||(_={}));var T=class extends Error{constructor(e,t,i,r,s,n=!1){super(r);this.code=e;this.name=t;this.message=r;this.description=s;this.isTerminal=n;Object.setPrototypeOf(this,T.prototype),this.action=i.toString()}toAnalyticsProperties(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}}addNativeError(e){this.nativeError=e}toString(){var e;return`{
      code: ${this.code};
      name: ${this.name};
      action: ${this.action};
      message: ${this.message};
      description: ${this.description};
      isTerminal: ${this.isTerminal};
      nativeError: ${(e=this.nativeError)==null?void 0:e.message};
    }`}};var H=class{static connect(e,t,i=new Date,r=new Date,s){let n=this.eventNameFor("connect",e===void 0),d=e?_.ERROR:_.INFO,l=this.getPropertiesWithError(L(v({},t),{[this.KEY_REQUESTED_AT]:i==null?void 0:i.getTime(),[this.KEY_RESPONDED_AT]:r==null?void 0:r.getTime(),endpoint:s}),e);return new x({name:n,level:d,properties:l})}static disconnect(e,t){let i="disconnected",r=e?_.ERROR:_.INFO,s=this.getPropertiesWithError(t,e);return new x({name:i,level:r,properties:s})}static preview(i){var r=i,{error:e}=r,t=Rt(r,["error"]);let s=this.eventNameFor("preview",e===void 0),n=e?_.ERROR:_.INFO,d=this.getPropertiesWithError(t,e);return new x({name:s,level:n,properties:d})}static join(i){var r=i,{error:e}=r,t=Rt(r,["error"]);let s=this.eventNameFor("join",e===void 0),n=e?_.ERROR:_.INFO,d=this.getPropertiesWithError(L(v({},t),{is_preview_called:!!t.is_preview_called}),e);return new x({name:s,level:n,properties:d})}static publish({devices:e,settings:t,error:i}){let r=this.eventNameFor("publish",i===void 0),s=i?_.ERROR:_.INFO,n=this.getPropertiesWithError({devices:e,audio:t==null?void 0:t.audio,video:t==null?void 0:t.video},i);return new x({name:r,level:s,properties:n})}static subscribeFail(e){let t=this.eventNameFor("subscribe",!1),i=_.ERROR,r=this.getErrorProperties(e);return new x({name:t,level:i,properties:r})}static leave(){return new x({name:"leave",level:_.INFO})}static autoplayError(){return new x({name:"autoplayError",level:_.ERROR})}static audioPlaybackError(e){return new x({name:"audioPlaybackError",level:_.ERROR,properties:this.getErrorProperties(e)})}static deviceChange({selection:e,type:t,devices:i,error:r}){let s=this.eventNameFor(r?"publish":`device.${t}`,r===void 0),n=r?_.ERROR:_.INFO,d=this.getPropertiesWithError({selection:e,devices:i},r);return new x({name:s,level:n,properties:d})}static performance(e){let t="perf.stats",i=_.INFO,r=e.toAnalyticsProperties();return new x({name:t,level:i,properties:r})}static rtcStats(e){let t="rtc.stats",i=_.INFO,r=e.toAnalyticsProperties();return new x({name:t,level:i,properties:r})}static degradationStats(e,t){let i="video.degradation.stats",r=_.INFO,s={degradedAt:e.degradedAt,trackId:e.trackId};if(!t&&e.degradedAt instanceof Date){let n=new Date,d=n.valueOf()-e.degradedAt.valueOf();s=L(v({},s),{duration:d,restoredAt:n})}return new x({name:i,level:r,properties:s})}static audioDetectionFail(e,t){let i=this.getPropertiesWithError({device:t},e),r=_.ERROR,s="audiopresence.failed";return new x({name:s,level:r,properties:i})}static previewNetworkQuality(e){return new x({name:"perf.networkquality.preview",level:e.error?_.ERROR:_.INFO,properties:e})}static eventNameFor(e,t){return`${e}.${t?"success":"failed"}`}static getPropertiesWithError(e,t){let i=this.getErrorProperties(t);return e=v(v({},i),e),e}static getErrorProperties(e){return e?e instanceof T?e.toAnalyticsProperties():{error_name:e.name,error_message:e.message,error_description:e.cause}:{}}};H.KEY_REQUESTED_AT="requested_at",H.KEY_RESPONDED_AT="responded_at";var M;(function(u){u.INIT="init_response_time",u.WEBSOCKET_CONNECT="ws_connect_time",u.ON_POLICY_CHANGE="on_policy_change_time",u.LOCAL_AUDIO_TRACK="local_audio_track_time",u.LOCAL_VIDEO_TRACK="local_video_track_time",u.JOIN="join_time",u.PREVIEW="preview_time",u.PEER_LIST="peer_list_time",u.ROOM_STATE="room_state_time",u.JOIN_RESPONSE="join_response_time"})(M||(M={}));var Rr=[M.INIT,M.WEBSOCKET_CONNECT,M.ON_POLICY_CHANGE,M.LOCAL_AUDIO_TRACK,M.LOCAL_VIDEO_TRACK,M.PEER_LIST,M.ROOM_STATE],Dt=class{constructor(){this.eventPerformanceMeasures={}}start(e){performance.mark(e)}end(e){var t;try{this.eventPerformanceMeasures[e]=performance.measure(e,e),o.d("[HMSPerformanceTiming]",e,(t=this.eventPerformanceMeasures[e])==null?void 0:t.duration)}catch(i){o.w("[AnalyticsTimer]",`Error in measuring performance for event ${e}`,{error:i})}}getTimeTaken(e){var t;return(t=this.eventPerformanceMeasures[e])==null?void 0:t.duration}getTimes(...e){return[...Rr,...e].reduce((t,i)=>L(v({},t),{[i]:this.getTimeTaken(i)}),{})}cleanUp(){this.eventPerformanceMeasures={}}};var f={WebSocketConnectionErrors:{FAILED_TO_CONNECT:1e3,WEBSOCKET_CONNECTION_LOST:1003,ABNORMAL_CLOSE:1006},InitAPIErrors:{SERVER_ERRORS:2e3,INIT_CONFIG_NOT_AVAILABLE:2002,ENDPOINT_UNREACHABLE:2003,INVALID_TOKEN_FORMAT:2004},TracksErrors:{GENERIC_TRACK:3e3,CANT_ACCESS_CAPTURE_DEVICE:3001,DEVICE_NOT_AVAILABLE:3002,DEVICE_IN_USE:3003,DEVICE_LOST_MIDWAY:3008,NOTHING_TO_RETURN:3005,INVALID_VIDEO_SETTINGS:3006,CODEC_CHANGE_NOT_PERMITTED:3007,AUTOPLAY_ERROR:3008,OVER_CONSTRAINED:3009,NO_AUDIO_DETECTED:3010,SYSTEM_DENIED_PERMISSION:3011,CURRENT_TAB_NOT_SHARED:3012,AUDIO_PLAYBACK_ERROR:3013},WebrtcErrors:{CREATE_OFFER_FAILED:4001,CREATE_ANSWER_FAILED:4002,SET_LOCAL_DESCRIPTION_FAILED:4003,SET_REMOTE_DESCRIPTION_FAILED:4004,ICE_FAILURE:4005,ICE_DISCONNECTED:4006},WebsocketMethodErrors:{SERVER_ERRORS:5e3,ALREADY_JOINED:5001,CANNOT_JOIN_PREVIEW_IN_PROGRESS:5002},GenericErrors:{NOT_CONNECTED:6e3,SIGNALLING:6001,UNKNOWN:6002,NOT_READY:6003,JSON_PARSING_FAILED:6004,TRACK_METADATA_MISSING:6005,RTC_TRACK_MISSING:6006,PEER_METADATA_MISSING:6007,INVALID_ROLE:6008,PREVIEW_IN_PROGRESS:6009,MISSING_MEDIADEVICES:6010,MISSING_RTCPEERCONNECTION:6011},PlaylistErrors:{NO_ENTRY_TO_PLAY:8001,NO_ENTRY_IS_PLAYING:8002}};var p;(function(I){I.NONE="NONE",I.TRACK="TRACK",I.INIT="INIT",I.PUBLISH="PUBLISH",I.UNPUBLISH="UNPUBLISH",I.JOIN="JOIN",I.SUBSCRIBE="SUBSCRIBE",I.DATA_CHANNEL_SEND="DATA_CHANNEL_SEND",I.RESTART_ICE="RESTART_ICE",I.VIDEO_PLUGINS="VIDEO_PLUGINS",I.AUDIO_PLUGINS="AUDIO_PLUGINS",I.AUTOPLAY="AUTOPLAY",I.RECONNECT_SIGNAL="RECONNECT_SIGNAL",I.VALIDATION="VALIDATION",I.PLAYLIST="PLAYLIST",I.PREVIEW="PREVIEW"})(p||(p={}));var m={WebSocketConnectionErrors:{FailedToConnect(a,e=""){return new T(f.WebSocketConnectionErrors.FAILED_TO_CONNECT,"WebsocketFailedToConnect",a,`[WS]: ${e}`,`[WS]: ${e}`)},WebSocketConnectionLost(a,e=""){return new T(f.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,"WebSocketConnectionLost",a,"Network connection lost ",e)},AbnormalClose(a,e=""){return new T(f.WebSocketConnectionErrors.ABNORMAL_CLOSE,"WebSocketAbnormalClose",a,"Websocket closed abnormally",e)}},InitAPIErrors:{ServerErrors(a,e,t=""){return new T(a,"ServerErrors",e,`[INIT]: Server error ${t}`,t,!0)},EndpointUnreachable(a,e=""){return new T(f.InitAPIErrors.ENDPOINT_UNREACHABLE,"EndpointUnreachable",a,`Endpoint is not reachable - ${e}`,e)},InvalidTokenFormat(a,e=""){return new T(f.InitAPIErrors.INVALID_TOKEN_FORMAT,"InvalidTokenFormat",a,`Token is not in proper JWT format - ${e}`,e,!0)},InitConfigNotAvailable(a,e=""){return new T(f.InitAPIErrors.INIT_CONFIG_NOT_AVAILABLE,"InitError",a,`[INIT]: ${e}`,`[INIT]: ${e}`)}},TracksErrors:{GenericTrack(a,e=""){return new T(f.TracksErrors.GENERIC_TRACK,"GenericTrack",a,`[TRACK]: ${e}`,`[TRACK]: ${e}`)},CantAccessCaptureDevice(a,e,t=""){return new T(f.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,"CantAccessCaptureDevice",a,`User denied permission to access capture device - ${e}`,t)},DeviceNotAvailable(a,e,t=""){return new T(f.TracksErrors.DEVICE_NOT_AVAILABLE,"DeviceNotAvailable",a,`[TRACK]: Capture device is no longer available - ${e}`,t)},DeviceInUse(a,e,t=""){return new T(f.TracksErrors.DEVICE_IN_USE,"DeviceInUse",a,`[TRACK]: Capture device is in use by another application - ${e}`,t)},DeviceLostMidway(a,e,t=""){return new T(f.TracksErrors.DEVICE_LOST_MIDWAY,"DeviceLostMidway",a,`Lost access to capture device midway - ${e}`,t)},NothingToReturn(a,e="",t="There is no media to return. Please select either video or audio or both."){return new T(f.TracksErrors.NOTHING_TO_RETURN,"NothingToReturn",a,t,e)},InvalidVideoSettings(a,e=""){return new T(f.TracksErrors.INVALID_VIDEO_SETTINGS,"InvalidVideoSettings",a,"Cannot enable simulcast when no video settings are provided",e)},AutoplayBlocked(a,e=""){return new T(f.TracksErrors.AUTOPLAY_ERROR,"AutoplayBlocked",a,"Autoplay blocked because the user didn't interact with the document first",e)},CodecChangeNotPermitted(a,e=""){return new T(f.TracksErrors.CODEC_CHANGE_NOT_PERMITTED,"CodecChangeNotPermitted",a,"Codec can't be changed mid call.",e)},OverConstrained(a,e,t=""){return new T(f.TracksErrors.OVER_CONSTRAINED,"OverConstrained",a,`[TRACK]: Requested constraints cannot be satisfied with the device hardware - ${e}`,t)},NoAudioDetected(a,e="Please check the mic or use another audio input"){return new T(f.TracksErrors.NO_AUDIO_DETECTED,"NoAudioDetected",a,"No audio input detected from microphone",e)},SystemDeniedPermission(a,e,t=""){return new T(f.TracksErrors.SYSTEM_DENIED_PERMISSION,"SystemDeniedPermission",a,`Operating System denied permission to access capture device - ${e}`,t)},CurrentTabNotShared(){return new T(f.TracksErrors.CURRENT_TAB_NOT_SHARED,"CurrentTabNotShared",p.TRACK,"The app requires you to share the current tab","You must screen share the current tab in order to proceed")},AudioPlaybackError(a){return new T(f.TracksErrors.AUDIO_PLAYBACK_ERROR,"Audio playback error",p.TRACK,a,a)}},WebrtcErrors:{CreateOfferFailed(a,e=""){return new T(f.WebrtcErrors.CREATE_OFFER_FAILED,"CreateOfferFailed",a,`[${a.toString()}]: Failed to create offer. `,e)},CreateAnswerFailed(a,e=""){return new T(f.WebrtcErrors.CREATE_ANSWER_FAILED,"CreateAnswerFailed",a,`[${a.toString()}]: Failed to create answer. `,e)},SetLocalDescriptionFailed(a,e=""){return new T(f.WebrtcErrors.SET_LOCAL_DESCRIPTION_FAILED,"SetLocalDescriptionFailed",a,`[${a.toString()}]: Failed to set offer. `,e)},SetRemoteDescriptionFailed(a,e=""){return new T(f.WebrtcErrors.SET_REMOTE_DESCRIPTION_FAILED,"SetRemoteDescriptionFailed",a,`[${a.toString()}]: Failed to set answer. `,e,!0)},ICEFailure(a,e=""){return new T(f.WebrtcErrors.ICE_FAILURE,"ICEFailure",a,`[${a.toString()}]: Ice connection state FAILED`,e)},ICEDisconnected(a,e=""){return new T(f.WebrtcErrors.ICE_DISCONNECTED,"ICEDisconnected",a,`[${a.toString()}]: Ice connection state DISCONNECTED`,e)}},WebsocketMethodErrors:{ServerErrors(a,e,t){return new T(a,"ServerErrors",e,t,t,!0)},AlreadyJoined(a,e=""){return new T(f.WebsocketMethodErrors.ALREADY_JOINED,"AlreadyJoined",a,"[JOIN]: You have already joined this room.",e)},CannotJoinPreviewInProgress(a,e=""){return new T(f.WebsocketMethodErrors.CANNOT_JOIN_PREVIEW_IN_PROGRESS,"CannotJoinPreviewInProgress",a,"[JOIN]: Cannot join if preview is in progress",e)}},GenericErrors:{NotConnected(a,e=""){return new T(f.GenericErrors.NOT_CONNECTED,"NotConnected",a,"Client is not connected",e)},Signalling(a,e){return new T(f.GenericErrors.SIGNALLING,"Signalling",a,`Unknown signalling error: ${a.toString()} ${e} `,e)},Unknown(a,e){return new T(f.GenericErrors.UNKNOWN,"Unknown",a,`Unknown exception: ${e}`,e)},NotReady(a,e=""){return new T(f.GenericErrors.NOT_READY,"NotReady",a,e,e)},JsonParsingFailed(a,e,t=""){return new T(f.GenericErrors.JSON_PARSING_FAILED,"JsonParsingFailed",a,`Failed to parse JSON message - ${e}`,t)},TrackMetadataMissing(a,e=""){return new T(f.GenericErrors.TRACK_METADATA_MISSING,"TrackMetadataMissing",a,"Track Metadata Missing",e)},RTCTrackMissing(a,e=""){return new T(f.GenericErrors.RTC_TRACK_MISSING,"RTCTrackMissing",a,"RTC Track missing",e)},PeerMetadataMissing(a,e=""){return new T(f.GenericErrors.PEER_METADATA_MISSING,"PeerMetadataMissing",a,"Peer Metadata Missing",e)},ValidationFailed(a,e){return new T(f.GenericErrors.INVALID_ROLE,"ValidationFailed",p.VALIDATION,a,e?JSON.stringify(e):"")},InvalidRole(a,e){return new T(f.GenericErrors.INVALID_ROLE,"InvalidRole",a,"Invalid role. Join with valid role",e,!0)},PreviewAlreadyInProgress(a,e=""){return new T(f.GenericErrors.PREVIEW_IN_PROGRESS,"PreviewAlreadyInProgress",a,"[Preview]: Cannot join if preview is in progress",e)},MissingMediaDevices(){return new T(f.GenericErrors.MISSING_MEDIADEVICES,"MissingMediaDevices",p.JOIN,"navigator.mediaDevices is undefined. 100ms SDK won't work on this website as WebRTC is not supported on HTTP endpoints(missing navigator.mediaDevices). Please ensure you're using the SDK either on localhost or a valid HTTPS endpoint.","",!0)},MissingRTCPeerConnection(){return new T(f.GenericErrors.MISSING_RTCPEERCONNECTION,"MissingRTCPeerConnection",p.JOIN,"RTCPeerConnection which is a core requirement for WebRTC call was not found, this could be due to an unsupported browser or browser extensions blocking WebRTC","",!0)}},MediaPluginErrors:{PlatformNotSupported(a,e=""){return new T(7001,"PlatformNotSupported",a,"Check HMS Docs to see the list of supported platforms",e)},InitFailed(a,e=""){return new T(7002,"InitFailed",a,"Plugin init failed",e)},ProcessingFailed(a,e=""){return new T(7003,"ProcessingFailed",a,"Plugin processing failed",e)},AddAlreadyInProgress(a,e=""){return new T(7004,"AddAlreadyInProgress",a,"Plugin add already in progress",e)},DeviceNotSupported(a,e=""){return new T(7005,"DeviceNotSupported",a,"Check HMS Docs to see the list of supported devices",e)}},PlaylistErrors:{NoEntryToPlay(a,e){return new T(f.PlaylistErrors.NO_ENTRY_TO_PLAY,"NoEntryToPlay",a,"Reached end of playlist",e)},NoEntryPlaying(a,e){return new T(f.PlaylistErrors.NO_ENTRY_IS_PLAYING,"NoEntryIsPlaying",a,"No entry is playing at this time",e)}}};var Nt=J(require("webrtc-adapter"));var j;(function(s){s.UNKNOWN="unknown(video or audio)",s.AUDIO="audio",s.VIDEO="video",s.AV="audio, video",s.SCREEN="screen"})(j||(j={}));function wr(a,e){let t=a.toLowerCase();return t.includes("device not found")?m.TracksErrors.DeviceNotAvailable(p.TRACK,e,a):t.includes("permission denied")?m.TracksErrors.CantAccessCaptureDevice(p.TRACK,e,a):m.TracksErrors.GenericTrack(p.TRACK,a)}function Hr(a,e=""){if(Nt.default.browserDetails.browser==="chrome"&&a.name==="NotAllowedError"&&a.message.includes("denied by system"))return m.TracksErrors.SystemDeniedPermission(p.TRACK,e,a.message);if(Nt.default.browserDetails.browser==="firefox"&&a.name==="NotFoundError"){let i=m.TracksErrors.SystemDeniedPermission(p.TRACK,e,a.message);return i.description=`Capture device is either blocked at Operating System level or not available - ${e}`,i}switch(a.name){case"OverconstrainedError":return m.TracksErrors.OverConstrained(p.TRACK,e,a.constraint);case"NotAllowedError":return m.TracksErrors.CantAccessCaptureDevice(p.TRACK,e,a.message);case"NotFoundError":return m.TracksErrors.DeviceNotAvailable(p.TRACK,e,a.message);case"NotReadableError":return m.TracksErrors.DeviceInUse(p.TRACK,e,a.message);case"TypeError":return m.TracksErrors.NothingToReturn(p.TRACK,a.message);default:return wr(a.message,e)}}function te(a,e){let t=Hr(a,e);return t.addNativeError(a),t}var ae;(function(s){s.RECORDING_STATE_UPDATED="RECORDING_STATE_UPDATED",s.BROWSER_RECORDING_STATE_UPDATED="BROWSER_RECORDING_STATE_UPDATED",s.SERVER_RECORDING_STATE_UPDATED="SERVER_RECORDING_STATE_UPDATED",s.RTMP_STREAMING_STATE_UPDATED="RTMP_STREAMING_STATE_UPDATED",s.HLS_STREAMING_STATE_UPDATED="HLS_STREAMING_STATE_UPDATED"})(ae||(ae={}));var K;(function(g){g[g.PEER_JOINED=0]="PEER_JOINED",g[g.PEER_LEFT=1]="PEER_LEFT",g[g.AUDIO_TOGGLED=2]="AUDIO_TOGGLED",g[g.VIDEO_TOGGLED=3]="VIDEO_TOGGLED",g[g.BECAME_DOMINANT_SPEAKER=4]="BECAME_DOMINANT_SPEAKER",g[g.RESIGNED_DOMINANT_SPEAKER=5]="RESIGNED_DOMINANT_SPEAKER",g[g.STARTED_SPEAKING=6]="STARTED_SPEAKING",g[g.STOPPED_SPEAKING=7]="STOPPED_SPEAKING",g[g.ROLE_UPDATED=8]="ROLE_UPDATED",g[g.PEER_LIST=9]="PEER_LIST",g[g.NAME_UPDATED=10]="NAME_UPDATED",g[g.METADATA_UPDATED=11]="METADATA_UPDATED"})(K||(K={}));var D;(function(d){d[d.TRACK_ADDED=0]="TRACK_ADDED",d[d.TRACK_REMOVED=1]="TRACK_REMOVED",d[d.TRACK_MUTED=2]="TRACK_MUTED",d[d.TRACK_UNMUTED=3]="TRACK_UNMUTED",d[d.TRACK_DESCRIPTION_CHANGED=4]="TRACK_DESCRIPTION_CHANGED",d[d.TRACK_DEGRADED=5]="TRACK_DEGRADED",d[d.TRACK_RESTORED=6]="TRACK_RESTORED"})(D||(D={}));var q;(function(r){r.NONE="none",r.LOW="low",r.MEDIUM="medium",r.HIGH="high"})(q||(q={}));var tt={f:q.HIGH,h:q.MEDIUM,q:q.LOW};var Fe;(function(i){i.VP8="vp8",i.VP9="vp9",i.H264="h264"})(Fe||(Fe={}));var Ue;(function(e){e.OPUS="opus"})(Ue||(Ue={}));var Ot;(function(i){i.videoInput="videoInput",i.audioInput="audioInput",i.audioOutput="audioOutput"})(Ot||(Ot={}));var b;(function(t){t.audio="audio",t.video="video"})(b||(b={}));var ee=class{constructor(){this._volume=1;this._codec=Ue.OPUS;this._maxBitrate=32;this._deviceId="default";this._advanced=[{googEchoCancellation:{exact:!0}},{googExperimentalEchoCancellation:{exact:!0}},{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{googHighpassFilter:{exact:!0}},{googAudioMirroring:{exact:!0}}]}volume(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this}codec(e){return this._codec=e,this}maxBitrate(e){if(e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new Pe(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced)}},Pe=class{constructor(e,t,i,r,s){this.volume=e,this.codec=t,this.maxBitrate=i,this.deviceId=r,this.advanced=s}toConstraints(){return{deviceId:this.deviceId,advanced:this.advanced}}toAnalyticsProperties(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}}};var Q=class{constructor(){this._width=320;this._height=180;this._codec=Fe.VP8;this._maxFramerate=30;this._maxBitrate=150;this._advanced=[]}setWidth(e){return this._width=e,this}setHeight(e){return this._height=e,this}codec(e){return this._codec=e,this}maxFramerate(e){if(e&&e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this}maxBitrate(e,t=!0){if(typeof e=="number"&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new Ie(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate)}},Ie=class{constructor(e,t,i,r,s,n,d){this.width=e,this.height=t,this.codec=i,this.maxFramerate=r,this.maxBitrate=d,this.deviceId=s,this.advanced=n}toConstraints(e){let t="ideal";return e&&(t="max"),{width:{[t]:this.width},height:{[t]:this.height},frameRate:this.maxFramerate,deviceId:this.deviceId}}toAnalyticsProperties(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec}}};var it=class{constructor(){this._video=new Q().build();this._audio=new ee().build();this._screen=new Q().build();this._simulcast=!1}video(e){return this._video=e,this}audio(e){return this._audio=e,this}screen(e){return this._screen=e,this}simulcast(e){return this._simulcast=e,this}build(){if(this._audio===null&&this._video===null)throw m.TracksErrors.NothingToReturn(p.TRACK);if(this._video===null&&this._simulcast)throw m.TracksErrors.InvalidVideoSettings(p.TRACK,"Cannot enable simulcast when no video settings are provided");return new Be(this._video,this._audio,this._simulcast,this._screen||void 0)}},Be=class{constructor(e,t,i,r=null){this.video=e,this.audio=t,this.simulcast=i,this.screen=r}toAnalyticsProperties(){let e={audio_enabled:this.audio!==null,video_enabled:this.video!==null};return this.audio&&(e=v(v({},this.audio.toAnalyticsProperties()),e)),this.video&&(e=v(v({},this.video.toAnalyticsProperties()),e)),e}};var be=class{constructor(e){this.tracks=new Array;this.nativeStream=e,this.id=e.id}};var rt=a=>a?`{
    trackId: ${a.id};
    kind: ${a.kind};
    enabled: ${a.enabled};
    muted: ${a.muted};
    readyState: ${a.readyState};
  }`:"";var pe=class{constructor(e,t,i){this.logIdentifier="";this.stream=e,this.nativeTrack=t,this.source=i}get enabled(){return this.nativeTrack.enabled}get trackId(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}getMediaTrackSettings(){return this.nativeTrack.getSettings()}setEnabled(e){return c(this,null,function*(){this.nativeTrack.enabled=e})}setSdpTrackId(e){this.sdpTrackId=e}setFirstTrackId(e){this.firstTrackId=e}cleanup(){var e;o.d("[HMSTrack]","Stopping track",this.toString()),(e=this.nativeTrack)==null||e.stop()}toString(){return`{
      streamId: ${this.stream.id};
      peerId: ${this.peerId};
      trackId: ${this.trackId};
      logIdentifier: ${this.logIdentifier};
      source: ${this.source};
      enabled: ${this.enabled};
      nativeTrack: ${rt(this.nativeTrack)};
    }`}};var F;(function(t){t.AUDIO="audio",t.VIDEO="video"})(F||(F={}));var Ce=class extends be{constructor(e,t){super(e);this.audio=!0;this.video=q.NONE;this.connection=t}setAudio(e,t,i){return c(this,null,function*(){this.audio!==e&&(this.audio=e,o.d(`[Remote stream] ${i||""} ${this.id}`,`subscribing audio - ${this.audio}`),yield this.connection.sendOverApiDataChannelWithResponse({params:{subscribed:this.audio,track_id:t},method:"prefer-audio-track-state"}))})}setVideoLayerLocally(e,t,i){this.video=e,o.d(`[Remote stream] ${t} - ${this.id}`,`source: ${i} Setting layer field to - ${e}`)}setVideoLayer(e,t,i,r){return this.setVideoLayerLocally(e,i,r),o.d(`[Remote stream] ${i} - ${this.id}`,`request ${e} layer`),this.connection.sendOverApiDataChannelWithResponse({params:{max_spatial_layer:this.video,track_id:t},method:"prefer-video-track-state"})}getSimulcastLayer(){return this.video}getVideoLayer(){return this.video}isAudioSubscribed(){return this.audio}};var Re=class extends pe{constructor(e,t,i){super(e,t,i);this.type=F.AUDIO;this.audioElement=null;if(t.kind!=="audio")throw new Error("Expected 'track' kind = 'audio'")}getVolume(){return this.audioElement?this.audioElement.volume*100:null}setVolume(e){return c(this,null,function*(){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");yield this.subscribeToAudio(e===0?!1:this.enabled),this.audioElement&&(this.audioElement.volume=e/100)})}setAudioElement(e){this.audioElement=e}getAudioElement(){return this.audioElement}getOutputDevice(){return this.outputDevice}cleanup(){super.cleanup(),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)}setOutputDevice(e){return c(this,null,function*(){var t;if(!this.audioElement){o.d("audio-track","no audio element to set output");return}try{typeof this.audioElement.setSinkId=="function"&&(yield(t=this.audioElement)==null?void 0:t.setSinkId(e.deviceId),this.outputDevice=e)}catch(i){o.d("audio-track",i)}})}subscribeToAudio(e){return c(this,null,function*(){this.stream instanceof Ce&&(yield this.stream.setAudio(e,this.trackId,this.logIdentifier))})}};var Hi=class{constructor(){this.storage=new re("hms-device-selection");this.remember=!1;this.TAG="[HMSDeviceStorage]"}setDevices(e){this.devices=e}rememberDevices(e){this.remember=e}updateSelection(e,{deviceId:t,groupId:i}){if(!this.devices||!this.remember)return;let r=this.devices[e].find(n=>this.isSame({deviceId:t,groupId:i},n));if(!r){o.w(this.TAG,`Could not find device with deviceId: ${t}, groupId: ${i}`);return}let s=this.storage.get()||{};s[e]=r,this.storage.set(s)}getSelection(){if(!!this.remember)return this.storage.get()}cleanup(){this.remember=!1,this.devices=void 0}isSame(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)}},Y=new Hi;var st;(function(t){t.TRANSFORM="TRANSFORM",t.ANALYZE="ANALYZE"})(st||(st={}));var ie;(function(t){t.PLATFORM_NOT_SUPPORTED="PLATFORM_NOT_SUPPORTED",t.DEVICE_NOT_SUPPORTED="DEVICE_NOT_SUPPORTED"})(ie||(ie={}));var me=class{static failure(e,t){let i="mediaPlugin.failed",r=_.ERROR,s=v({plugin_name:e},t.toAnalyticsProperties());return new x({name:i,level:r,properties:s})}static audioPluginFailure(e,t,i){let r="mediaPlugin.failed",s=_.ERROR,n=v({plugin_name:e,sampleRate:t},i.toAnalyticsProperties());return new x({name:r,level:s,properties:n})}static audioPluginStats({pluginName:e,duration:t,loadTime:i,sampleRate:r}){let s="mediaPlugin.stats",n=_.INFO,d={plugin_name:e,duration:t,load_time:i,sampleRate:r};return new x({name:s,level:n,properties:d})}static stats({pluginName:e,duration:t,loadTime:i,avgPreProcessingTime:r,avgProcessingTime:s,inputFrameRate:n,pluginFrameRate:d}){let l="mediaPlugin.stats",h=_.INFO,u={plugin_name:e,duration:t,load_time:i,avg_preprocessing_time:r,avg_processing_time:s,input_frame_rate:n,plugin_frame_rate:d};return new x({name:l,level:h,properties:u})}};var xt=class{constructor(e){this.eventBus=e;this.TAG="[AudioPluginsAnalytics]";this.initTime={},this.addedTimestamps={},this.pluginAdded={},this.pluginSampleRate={}}added(e,t){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.pluginSampleRate[e]=t}removed(e){if(this.pluginAdded[e]){let t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],sampleRate:this.pluginSampleRate[e]};this.eventBus.analytics.publish(me.audioPluginStats(t)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(me.audioPluginFailure(e,this.pluginSampleRate[e],t)),this.clean(e))}initWithTime(e,t){return c(this,null,function*(){if(this.initTime[e]){o.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);return}let i;try{i=yield this.timeInMs(t),o.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(r){let s=m.MediaPluginErrors.InitFailed(p.AUDIO_PLUGINS,`failed during initialization of plugin${r.message||r}`);throw o.e(this.TAG,s),this.failure(e,s),s}i&&(this.initTime[e]=i)})}timeInMs(e){return c(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e],delete this.pluginSampleRate[e]}};var Lr=48e3,_r=()=>navigator.userAgent.indexOf("Firefox")!==-1,Ge=class{constructor(e,t){this.TAG="[AudioPluginsManager]";this.pluginAddInProgress=!1;this.hmsTrack=e,this.pluginsMap=new Map,this.analytics=new xt(t),this.createAudioContext()}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e){return c(this,null,function*(){var i;let t=(i=e.getName)==null?void 0:i.call(e);if(!t){o.w("no name provided by the plugin");return}if(this.pluginAddInProgress){let r=m.MediaPluginErrors.AddAlreadyInProgress(p.AUDIO_PLUGINS,"Add Plugin is already in Progress");throw this.analytics.added(t,this.audioContext.sampleRate),this.analytics.failure(t,r),o.w("can't add another plugin when previous add is in progress"),r}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e){return c(this,null,function*(){var i;let t=(i=e.getName)==null?void 0:i.call(e);if(this.pluginsMap.get(t)){o.w(this.TAG,`plugin - ${t} already added.`);return}yield this.validateAndThrow(t,e);try{this.pluginsMap.size===0?yield this.initAudioNodes():this.prevAudioNode&&this.prevAudioNode.disconnect(),this.analytics.added(t,this.audioContext.sampleRate),yield this.analytics.initWithTime(t,()=>c(this,null,function*(){return e.init()})),this.pluginsMap.set(t,e),yield this.processPlugin(e),yield this.connectToDestination()}catch(r){throw o.e(this.TAG,"failed to add plugin",r),r}})}validatePlugin(e){return e.checkSupport(this.audioContext)}validateAndThrow(e,t){return c(this,null,function*(){let i=this.validatePlugin(t);if(i.isSupported)o.i(this.TAG,`plugin is supported,- ${t.getName()}`);else if(this.analytics.added(e,this.audioContext.sampleRate),i.errType===ie.PLATFORM_NOT_SUPPORTED){let r=m.MediaPluginErrors.PlatformNotSupported(p.AUDIO_PLUGINS,"platform not supported, see docs");throw this.analytics.failure(e,r),yield this.cleanup(),r}else if(i.errType===ie.DEVICE_NOT_SUPPORTED){let r=m.MediaPluginErrors.DeviceNotSupported(p.AUDIO_PLUGINS,"audio device not supported, see docs");throw this.analytics.failure(e,r),yield this.cleanup(),r}})}removePlugin(e){return c(this,null,function*(){yield this.removePluginInternal(e),this.pluginsMap.size===0?(yield this.cleanup(),o.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.hmsTrack.setProcessedTrack(void 0)):yield this.reprocessPlugins()})}cleanup(){return c(this,null,function*(){var e,t,i;for(let r of this.pluginsMap.values())yield this.removePluginInternal(r);yield this.hmsTrack.setProcessedTrack(void 0),(e=this.sourceNode)==null||e.disconnect(),(t=this.prevAudioNode)==null||t.disconnect(),(i=this.outputTrack)==null||i.stop(),this.sourceNode=void 0,this.destinationNode=void 0,this.prevAudioNode=void 0,this.outputTrack=void 0})}closeContext(){return c(this,null,function*(){var e;(e=this.audioContext)==null||e.close(),this.audioContext=void 0})}reprocessPlugins(){return c(this,null,function*(){if(this.pluginsMap.size===0||!this.sourceNode)return;let e=Array.from(this.pluginsMap.values());yield this.cleanup(),yield this.initAudioNodes();for(let t of e)yield this.addPlugin(t)})}initAudioNodes(){return c(this,null,function*(){if(this.audioContext){if(!this.sourceNode){let e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e)}if(!this.destinationNode){this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0];try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw o.e(this.TAG,"error in setting processed track",e),e}}}})}processPlugin(e){return c(this,null,function*(){try{let t=yield e.processAudioTrack(this.audioContext,this.prevAudioNode||this.sourceNode);this.prevAudioNode&&this.prevAudioNode.connect(t),this.prevAudioNode=t}catch(t){let i=e.getName();o.e(this.TAG,`error in processing plugin ${i}`,t),yield this.removePluginInternal(e)}})}connectToDestination(){return c(this,null,function*(){try{this.prevAudioNode&&this.destinationNode&&this.prevAudioNode.context===this.destinationNode.context&&this.prevAudioNode.connect(this.destinationNode)}catch(e){o.e(this.TAG,"error in connecting to destination node",e)}})}removePluginInternal(e){return c(this,null,function*(){var i;let t=(i=e.getName)==null?void 0:i.call(e);if(!this.pluginsMap.get(t)){o.w(this.TAG,`plugin - ${t} not found to remove.`);return}o.i(this.TAG,`removing plugin ${t}`),this.pluginsMap.delete(t),e.stop(),this.analytics.removed(t)})}createAudioContext(){this.audioContext||(_r()?this.audioContext=new AudioContext:this.audioContext=new AudioContext({sampleRate:Lr}))}};function at(a){return c(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:a?a.toConstraints():!1})).getAudioTracks()[0]}catch(e){throw te(e,j.AUDIO)}})}function nt(a){return c(this,null,function*(){try{return(yield navigator.mediaDevices.getUserMedia({video:a?a.toConstraints():!1})).getVideoTracks()[0]}catch(e){throw te(e,j.VIDEO)}})}function ot(a){return"canvas"in a||a.label==="MediaStreamAudioDestinationNode"||a.label===""}function Ft(a){return c(this,null,function*(){try{return yield navigator.mediaDevices.getUserMedia(a)}catch(e){throw te(e,j.AV)}})}function Dr(a){return c(this,null,function*(){try{return yield navigator.mediaDevices.getDisplayMedia({video:a,audio:!1})}catch(e){throw te(e,j.SCREEN)}})}function Nr(){return c(this,null,function*(){try{let a=yield navigator.mediaDevices.enumerateDevices(),e={audioinput:[],audiooutput:[],videoinput:[]};return a.forEach(t=>e[t.kind].push(t)),e}catch(a){throw te(a,j.AV)}})}var ne={audioContext:null,getAudioContext(){return this.audioContext||(this.audioContext=new AudioContext),this.audioContext},resumeContext(){return c(this,null,function*(){try{return yield this.getAudioContext().resume()}catch(a){o.e("AudioContext",a)}})}};var Te=class{constructor(e=1/0){this.capacity=e;this.storage=[]}size(){return this.storage.length}toList(){return this.storage.slice(0)}enqueue(e){this.size()===this.capacity&&this.dequeue(),this.storage.push(e)}dequeue(){return this.storage.shift()}aggregate(e){return e(this.storage)}};function W(a){if(a<0)throw Error("`ms` should be a positive integer");return new Promise(e=>setTimeout(e,a))}function Li(a,e=300){let t;return function(...i){clearTimeout(t),t=void 0;let r=this;t=setTimeout(()=>{a.apply(r,i)},e)}}var Or=35,xr=5,Ut=class{constructor(e,t,i){this.track=e;this.audioLevelEvent=t;this.silenceEvent=i;this.TAG="[TrackAudioLevelMonitor]";this.audioLevel=0;this.isMonitored=!1;this.interval=100;this.historyInterval=700;this.history=new Te(this.historyInterval/this.interval);this.detectSilence=()=>c(this,null,function*(){let e=20,t=50,i=0;for(;this.isMonitored;){if(this.track.enabled)if(this.isSilentThisInstant()){if(i++,i>t){this.silenceEvent.publish({track:this.track});break}}else break;yield W(e)}});try{let r=new MediaStream([this.track.nativeTrack]);this.analyserNode=this.createAnalyserNodeForStream(r)}catch(r){o.w(this.TAG,"Unable to initialize AudioContext",r)}}start(){this.stop(),this.isMonitored=!0,o.d(this.TAG,"Starting track Monitor",`${this.track}`),this.loop().then(()=>o.d(this.TAG,"Stopping track Monitor",`${this.track}`))}stop(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}this.sendAudioLevel(0),this.isMonitored=!1}loop(){return c(this,null,function*(){for(;this.isMonitored;)this.sendAudioLevel(this.getMaxAudioLevelOverPeriod()),yield W(this.interval)})}sendAudioLevel(e=0){if(e=e>Or?e:0,Math.abs(this.audioLevel-e)>xr){this.audioLevel=e;let i={track:this.track,audioLevel:this.audioLevel};this.audioLevelEvent.publish(i)}}getMaxAudioLevelOverPeriod(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}let e=this.calculateAudioLevel();return e!==void 0&&this.history.enqueue(e),this.history.aggregate(t=>Math.max(...t))}calculateAudioLevel(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}let e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);let t=.009,i=t;for(let n of e)i=Math.max(i,(n-128)/128);let r=(Math.log(t)-Math.log(i))/Math.log(t);return Math.ceil(Math.min(Math.max(r*100,0),100))}isSilentThisInstant(){if(!this.analyserNode){o.d(this.TAG,"AudioContext not initialized");return}let e=new Uint8Array(this.analyserNode.fftSize);return this.analyserNode.getByteTimeDomainData(e),!e.some(t=>t!==128&&t!==0)}createAnalyserNodeForStream(e){let t=ne.getAudioContext(),i=t.createAnalyser();return t.createMediaStreamSource(e).connect(i),i}};function _i(a,e){return function(i){return i in a&&a[i]!==e[i]}}var fe=class extends Re{constructor(e,t,i,r,s=new ee().build()){super(e,t,i);this.eventBus=r;this.TAG="[HMSLocalAudioTrack]";this.isPublished=!1;this.handleVisibilityChange=()=>c(this,null,function*(){document.visibilityState==="visible"&&(yield this.replaceTrackWith(this.settings))});this.handleSettingsChange=e=>c(this,null,function*(){let t=this.stream,i=_i(e,this.settings);i("maxBitrate")&&e.maxBitrate&&(yield t.setMaxBitrateAndFramerate(this)),i("advanced")&&(yield this.replaceTrackWith(e))});this.handleDeviceChange=(e,t=!1)=>c(this,null,function*(){_i(e,this.settings)("deviceId")&&(yield this.replaceTrackWith(e),t||Y.updateSelection("audioInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId}))});e.tracks.push(this),this.settings=s,s.deviceId!==t.getSettings().deviceId&&!ot(t)&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new Ge(this,r),this.setFirstTrackId(t.id),Ye()&&X&&document.addEventListener("visibilitychange",this.handleVisibilityChange)}replaceTrackWith(e){return c(this,null,function*(){let t=this.nativeTrack,i=Boolean(this.audioLevelMonitor),r=yield at(e);t==null||t.stop(),r.enabled=this.enabled,o.d(this.TAG,"replaceTrack, Previous track stopped",t,"newTrack",r);let s=this.stream;yield s.replaceSenderTrack(t,this.processedTrack||r),yield s.replaceStreamTrack(t,r),this.nativeTrack=r,i&&this.initAudioLevelMonitor();try{yield this.pluginsManager.reprocessPlugins()}catch(n){this.eventBus.audioPluginFailed.publish(n)}})}setEnabled(e){var t=i=>super[i];return c(this,null,function*(){e!==this.enabled&&(e&&ot(this.nativeTrack)&&(yield this.replaceTrackWith(this.settings)),yield t("setEnabled").call(this,e),e&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),this.eventBus.localAudioEnabled.publish({enabled:e,track:this}),this.stream.trackUpdate(this))})}isPublishedTrackId(e){return this.publishedTrackId===e}setSettings(e,t=!1){return c(this,null,function*(){let i=this.buildNewSettings(e);if(ot(this.nativeTrack)){this.settings=i;return}yield this.handleDeviceChange(i,t),yield this.handleSettingsChange(i),this.settings=i})}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e){return c(this,null,function*(){return this.pluginsManager.addPlugin(e)})}removePlugin(e){return c(this,null,function*(){return this.pluginsManager.removePlugin(e)})}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}setProcessedTrack(e){return c(this,null,function*(){if(!e){this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0;return}e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)})}initAudioLevelMonitor(){this.audioLevelMonitor&&this.destroyAudioLevelMonitor(),o.d(this.TAG,"Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new Ut(this,this.eventBus.trackAudioLevelUpdate,this.eventBus.localAudioSilence),this.audioLevelMonitor.start(),this.audioLevelMonitor.detectSilence()}destroyAudioLevelMonitor(){var e;(e=this.audioLevelMonitor)==null||e.stop(),this.audioLevelMonitor=void 0}cleanup(){var e=t=>super[t];return c(this,null,function*(){var i;e("cleanup").call(this),yield this.pluginsManager.cleanup(),yield this.pluginsManager.closeContext(),(i=this.processedTrack)==null||i.stop(),this.isPublished=!1,this.destroyAudioLevelMonitor(),Ye()&&X&&document.removeEventListener("visibilitychange",this.handleVisibilityChange)})}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}buildNewSettings(e){let{volume:t,codec:i,maxBitrate:r,deviceId:s,advanced:n}=v(v({},this.settings),e);return new Pe(t,i,r,s,n)}};var ct=class extends Re{setEnabled(e){var t=i=>super[i];return c(this,null,function*(){e!==this.enabled&&(yield t("setEnabled").call(this,e),yield this.subscribeToAudio(e))})}};var we=class extends pe{constructor(e,t,i){super(e,t,i);this.type=F.VIDEO;this.sinkCount=0;if(t.kind!=="video")throw new Error("Expected 'track' kind = 'video'")}hasSinks(){return this.sinkCount>0}addSink(e){this.addSinkInternal(e,this.nativeTrack)}removeSink(e){e.srcObject!==null&&(e.srcObject=null,this.sinkCount>0&&this.sinkCount--)}addSinkInternal(e,t){var r;let i=e.srcObject;i!==null&&i instanceof MediaStream&&((r=i.getVideoTracks()[0])==null?void 0:r.id)===t.id||(e.srcObject=new MediaStream([t]),this.sinkCount++)}};var Ee;(function(t){t.TRANSFORM="TRANSFORM",t.ANALYZE="ANALYZE"})(Ee||(Ee={}));var He;(function(t){t["2D"]="2d",t.WEBGL="webgl",t.WEBGL2="webgl2"})(He||(He={}));var dt=class{constructor(){this.total=0;this.count=0}add(e){this.count++,this.total+=e}getAvg(){return Math.floor(this.total/this.count)}reset(){this.total=0,this.count=0}};var Bt=class{constructor(e){this.eventBus=e;this.TAG="[VideoPluginsAnalytics]";this.initTime={},this.preProcessingAvgs=new dt,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}added(e,t,i){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new dt,this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=i||t}removed(e){var t;if(this.pluginAdded[e]){let i={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:(t=this.processingAvgs[e])==null?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};this.eventBus.analytics.publish(me.stats(i)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(me.failure(e,t)),this.clean(e))}initWithTime(e,t){return c(this,null,function*(){if(this.initTime[e]){o.i(this.TAG,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);return}let i;try{i=yield this.timeInMs(t),o.i(this.TAG,`Time taken for Plugin ${e} initialization : ${i}`)}catch(r){let s=m.MediaPluginErrors.InitFailed(p.VIDEO_PLUGINS,`failed during initialization of plugin${r.message||r}`);throw o.e(this.TAG,s),this.failure(e,s),s}i&&(this.initTime[e]=i)})}preProcessWithTime(e){return c(this,null,function*(){let t=yield this.timeInMs(e);this.preProcessingAvgs.add(t)})}processWithTime(e,t){return c(this,null,function*(){var r;let i;try{i=yield this.timeInMs(t)}catch(s){let n=m.MediaPluginErrors.ProcessingFailed(p.VIDEO_PLUGINS,`Failed during processing of plugin${s.message||s}`);throw o.e(this.TAG,n),this.failure(e,n),n}i&&((r=this.processingAvgs[e])==null||r.add(i))})}timeInMs(e){return c(this,null,function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)})}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]}};var Di=24,Fr=320,Ur=240,Ve=class{constructor(e,t){this.TAG="[VideoPluginsManager]";this.pluginsLoopRunning=!1;this.pluginsLoopState="paused";this.pluginAddInProgress=!1;this.hmsTrack=e,this.pluginsMap=new Map,this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new Bt(t),this.canvases=new Array}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e,t){return c(this,null,function*(){var i;if(this.pluginAddInProgress){let r=(i=e.getName)==null?void 0:i.call(e);if(!r||r===""){o.w("no name provided by the plugin");return}let s=m.MediaPluginErrors.AddAlreadyInProgress(p.VIDEO_PLUGINS,"Add Plugin is already in Progress");throw this.analytics.failure(r,s),o.w("can't add another plugin when previous add is in progress"),s}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e,t)}finally{this.pluginAddInProgress=!1}})}addPluginInternal(e,t){return c(this,null,function*(){var n,d;let i=(n=e.getName)==null?void 0:n.call(e);if(!i||i===""){o.w("no name provided by the plugin");return}if(this.pluginsMap.has(i)){o.w(this.TAG,`plugin - ${e.getName()} already added.`);return}let r=this.hmsTrack.getMediaTrackSettings().frameRate||Di,s=0;t&&t>0?(o.i(this.TAG,`adding plugin ${e.getName()} with framerate ${t}`),t<r&&(s=Math.ceil(r/t)-1),this.analytics.added(i,r,t)):(o.i(this.TAG,`adding plugin ${e.getName()}`),this.analytics.added(i,r)),o.i(this.TAG,"numFrames to skip processing",s),this.pluginNumFramesToSkip[i]=s,this.pluginNumFramesSkipped[i]=s,this.validateAndThrow(i,e);try{if(yield this.analytics.initWithTime(i,()=>c(this,null,function*(){return yield e.init()})),this.pluginsMap.set(i,e),this.pluginsMap.size+1>this.canvases.length)for(let l=this.canvases.length;l<=this.pluginsMap.size;l++)this.canvases[l]=document.createElement("canvas");yield this.startPluginsLoop((d=e.getContextType)==null?void 0:d.call(e))}catch(l){throw o.e(this.TAG,"failed to add plugin",l),yield this.removePlugin(e),l}})}validatePlugin(e){return e.checkSupport()}validateAndThrow(e,t){let i=this.validatePlugin(t);if(i.isSupported)o.i(this.TAG,`plugin is supported,- ${t.getName()}`);else{let r;switch(i.errType){case ie.PLATFORM_NOT_SUPPORTED:throw r=m.MediaPluginErrors.PlatformNotSupported(p.VIDEO_PLUGINS,"platform not supported, see docs"),this.analytics.failure(e,r),r;case ie.DEVICE_NOT_SUPPORTED:throw r=m.MediaPluginErrors.DeviceNotSupported(p.VIDEO_PLUGINS,"video device not supported, see docs"),this.analytics.failure(e,r),r}}}removePlugin(e){return c(this,null,function*(){let t=e.getName();if(!this.pluginsMap.get(t)){o.w(this.TAG,`plugin - ${t} not found to remove.`);return}o.i(this.TAG,`removing plugin ${t}`),this.removePluginEntry(t),this.pluginsMap.size===0&&(o.i(this.TAG,"No plugins left, stopping plugins loop"),yield this.stopPluginsLoop()),e.stop(),this.analytics.removed(t)})}removePluginEntry(e){this.pluginsMap.delete(e),this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]}waitForRestart(){return c(this,null,function*(){if(!(!this.pluginsLoopRunning||this.pluginsLoopState==="running"))for(;this.pluginsLoopState==="paused";)yield W(100)})}cleanup(){return c(this,null,function*(){var e;for(let t of this.pluginsMap.values())yield this.removePlugin(t);(e=this.outputTrack)==null||e.stop()})}initElementsAndStream(e){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas=document.createElement("canvas"),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext(e||He["2D"]);let t=this.outputCanvas.captureStream();this.outputTrack=t.getVideoTracks()[0]}startPluginsLoop(e){return c(this,null,function*(){if(!this.pluginsLoopRunning){this.initElementsAndStream(e),this.pluginsLoopRunning=!0;try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(t){throw this.pluginsLoopRunning=!1,o.e(this.TAG,"error in setting processed track",t),t}this.pluginsLoop().then(()=>{o.d(this.TAG,"processLoop stopped")})}})}stopPluginsLoop(){return c(this,null,function*(){var e;this.pluginsLoopRunning=!1,yield this.hmsTrack.setProcessedTrack(void 0),this.resetCanvases(),(e=this.outputTrack)==null||e.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0)})}pluginsLoop(){return c(this,null,function*(){for(;this.pluginsLoopRunning;){let e=this.hmsTrack.getMediaTrackSettings().frameRate||Di,t=Math.floor(1e3/e);if(!this.hmsTrack.enabled||this.hmsTrack.nativeTrack.readyState==="ended"){this.pluginsLoopState==="running"&&this.resetCanvases(),this.pluginsLoopState="paused",yield W(t);continue}let i=0;try{yield this.analytics.preProcessWithTime(()=>c(this,null,function*(){return yield this.doPreProcessing()}));let r=Date.now();yield this.processFramesThroughPlugins(),i=Math.floor(Date.now()-r),i>t&&(i=t)}catch(r){o.e(this.TAG,"error in plugins loop",r)}this.pluginsLoopState="running",yield W(t-i)}})}doPreProcessing(){return c(this,null,function*(){yield this.addTrackToVideo(),yield this.updateInputCanvas()})}processFramesThroughPlugins(){return c(this,null,function*(){this.canvases[0]=this.inputCanvas;let e=0;for(let t of this.pluginsMap.values()){let i=t.getName();if(!!t){try{let r=this.checkIfSkipRequired(i);if(t.getPluginType()===Ee.TRANSFORM){let s=(n,d)=>c(this,null,function*(){try{yield t.processVideoFrame(n,d,r)}catch(l){o.e(this.TAG,`error in processing plugin ${i}`,l)}});if(r)e===this.pluginsMap.size-1?yield s(this.canvases[e],this.outputCanvas):yield s(this.canvases[e],this.canvases[e+1]);else{let n=this.canvases[e],d=this.canvases[e+1];e===this.pluginsMap.size-1?yield this.analytics.processWithTime(i,()=>c(this,null,function*(){return s(n,this.outputCanvas)})):yield this.analytics.processWithTime(i,()=>c(this,null,function*(){return s(n,d)}))}}else t.getPluginType()===Ee.ANALYZE&&!r&&(yield this.analytics.processWithTime(i,()=>c(this,null,function*(){return yield t.processVideoFrame(this.inputCanvas)})))}catch(r){o.e(this.TAG,`error in processing plugin ${i}`,r),yield this.removePlugin(t)}e++}}})}addTrackToVideo(){return c(this,null,function*(){var t;if(!this.inputVideo)return;let e=this.inputVideo.srcObject;e!==null&&e instanceof MediaStream&&((t=e.getVideoTracks()[0])==null?void 0:t.id)===this.hmsTrack.nativeTrack.id||(this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,this.inputVideo.playsInline=!0,yield this.inputVideo.play())})}updateInputCanvas(){return c(this,null,function*(){if(!this.inputCanvas||!this.inputVideo)return;let{width:e=Fr,height:t=Ur}=this.hmsTrack.getMediaTrackSettings();this.inputCanvas.height!==t&&(this.inputCanvas.height=t),this.inputCanvas.width!==e&&(this.inputCanvas.width=e),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,e,t)})}resetCanvases(){if(!this.outputCanvas||!this.inputCanvas)return;let e=this.inputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height)),this.canvases=[]}checkIfSkipRequired(e){let t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t}};function Ni(a,e){return function(i){return i in a&&a[i]!==e[i]}}var z=class extends we{constructor(e,t,i,r,s=new Q().build()){super(e,t,i);this.eventBus=r;this._layerDefinitions=[];this.TAG="[HMSLocalVideoTrack]";this.isCurrentTab=!1;this.isPublished=!1;this.buildNewSettings=e=>{let{width:t,height:i,codec:r,maxFramerate:s,maxBitrate:n,deviceId:d,advanced:l}=v(v({},this.settings),e);return new Ie(t,i,r,s,d,l,n)};this.handleSettingsChange=e=>c(this,null,function*(){let t=this.stream,i=Ni(e,this.settings);i("maxBitrate")&&e.maxBitrate&&(yield t.setMaxBitrateAndFramerate(this)),(i("width")||i("height")||i("advanced"))&&(yield this.nativeTrack.applyConstraints(e.toConstraints()))});this.handleDeviceChange=(e,t=!1)=>c(this,null,function*(){if(Ni(e,this.settings)("deviceId")&&this.source==="regular"){if(this.enabled){let r=yield this.replaceTrackWith(e);yield this.replaceSender(r,this.enabled),this.nativeTrack=r}t||Y.updateSelection("videoInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId})}});e.tracks.push(this),this.settings=s,s.deviceId!==t.getSettings().deviceId&&t.enabled&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new Ve(this,r),this.setFirstTrackId(this.trackId)}setSimulcastDefinitons(e){this._layerDefinitions=e}getSimulcastDefinitions(){return this._layerDefinitions}setEnabled(e){var t=i=>super[i];return c(this,null,function*(){var r;if(e!==this.enabled){if(this.source==="regular"){let s;e?s=yield this.replaceTrackWith(this.settings):s=yield this.replaceTrackWithBlank(),yield this.replaceSender(s,e),(r=this.nativeTrack)==null||r.stop(),this.nativeTrack=s,e&&(yield this.pluginsManager.waitForRestart(),this.settings=this.buildNewSettings({deviceId:s.getSettings().deviceId}))}yield t("setEnabled").call(this,e),this.eventBus.localVideoEnabled.publish({enabled:e,track:this}),this.stream.trackUpdate(this)}})}isPublishedTrackId(e){return this.publishedTrackId===e}addSink(e){this.addSinkInternal(e,this.processedTrack||this.nativeTrack)}setSettings(e,t=!1){return c(this,null,function*(){let i=this.buildNewSettings(e);if(yield this.handleDeviceChange(i,t),!this.enabled){this.settings=i;return}yield this.handleSettingsChange(i),this.settings=i})}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e,t){return c(this,null,function*(){return this.pluginsManager.addPlugin(e,t)})}removePlugin(e){return c(this,null,function*(){return this.pluginsManager.removePlugin(e)})}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}cleanup(){var e=t=>super[t];return c(this,null,function*(){var i;e("cleanup").call(this),yield this.pluginsManager.cleanup(),(i=this.processedTrack)==null||i.stop(),this.isPublished=!1})}cropTo(e){return c(this,null,function*(){if(!!e&&this.source==="screen")try{this.nativeTrack.cropTo&&(yield this.nativeTrack.cropTo(e))}catch(t){throw o.e(this.TAG,"failed to crop screenshare capture - ",t),m.TracksErrors.GenericTrack(p.TRACK,"failed to crop screenshare capture")}})}getCaptureHandle(){if(this.nativeTrack.getCaptureHandle)return this.nativeTrack.getCaptureHandle()}setProcessedTrack(e){return c(this,null,function*(){if(!this.nativeTrack.enabled){this.processedTrack=e;return}if(!e){this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),this.processedTrack=void 0;return}e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)})}getTrackIDBeingSent(){return this.getTrackBeingSent().id}getTrackBeingSent(){return this.enabled?this.processedTrack||this.nativeTrack:this.nativeTrack}replaceTrackWith(e){return c(this,null,function*(){let t=this.nativeTrack,i=yield nt(e);return t==null||t.stop(),o.d(this.TAG,"replaceTrack, Previous track stopped",t,"newTrack",i),this.settings.deviceId==="default"&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),i})}replaceTrackWithBlank(){return c(this,null,function*(){let e=this.nativeTrack,t=ge.getEmptyVideoTrack(e);return e==null||e.stop(),o.d(this.TAG,"replaceTrackWithBlank, Previous track stopped",e,"newTrack",t),t})}replaceSender(e,t){return c(this,null,function*(){let i=this.stream;t?yield i.replaceSenderTrack(this.nativeTrack,this.processedTrack||e):yield i.replaceSenderTrack(this.processedTrack||this.nativeTrack,e),yield i.replaceStreamTrack(this.nativeTrack,e)})}};var Le="renegotiation-callback-id",lt="ion-sfu",ut=100,$e=5,Oi=60,xi=12e3,Fi=1e3,Ui=5,_e="SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID",Bi=6e4,Gt=5e3,Gi=1e3,Vi=!1,$i="https://event.100ms.live/v2/client/report",Wi="https://event-nonprod.100ms.live/v2/client/report",Ki=100,V={DEVICE_CHANGE:"device-change",LOCAL_AUDIO_ENABLED:"local-audio-enabled",LOCAL_VIDEO_ENABLED:"local-video-enabled",STATS_UPDATE:"stats-update",RTC_STATS_UPDATE:"rtc-stats-update",TRACK_DEGRADED:"track-degraded",TRACK_RESTORED:"track-restored",TRACK_AUDIO_LEVEL_UPDATE:"track-audio-level-update",LOCAL_AUDIO_SILENCE:"local-audio-silence",ANALYTICS:"analytics",AUDIO_PLUGIN_FAILED:"audio-plugin-failed",POLICY_CHANGE:"policy-change",LOCAL_ROLE_UPDATE:"local-role-update",AUDIO_TRACK_UPDATE:"audio-track-update",AUDIO_TRACK_ADDED:"audio-track-added",AUDIO_TRACK_REMOVED:"audio-track-removed",AUTOPLAY_ERROR:"autoplay-error",LEAVE:"leave"};var Se=class extends we{constructor(){super(...arguments);this._degraded=!1;this._degradedAt=null;this._layerDefinitions=[];this.history=new qi;this.preferredLayer=q.HIGH}get degraded(){return this._degraded}get degradedAt(){return this._degradedAt}setEnabled(e){var t=i=>super[i];return c(this,null,function*(){e!==this.enabled&&(yield t("setEnabled").call(this,e))})}setPreferredLayer(e){return c(this,null,function*(){if(e===q.NONE){o.w(`layer ${q.NONE} will be ignored`);return}if(this.preferredLayer=e,!!this.shouldSendVideoLayer(e,"preferLayer")){if(!this.hasSinks()){o.d(`[Remote Track] ${this.logIdentifier}`,`Track does not have any sink, saving ${e}, source=${this.source}`);return}yield this.requestLayer(e,"preferLayer"),this.pushInHistory(`uiPreferLayer-${e}`)}})}getSimulcastLayer(){return this.stream.getSimulcastLayer()}getLayer(){return this.stream.getVideoLayer()}getPreferredLayer(){return this.preferredLayer}addSink(e){var t=i=>super[i];return c(this,null,function*(){t("addSink").call(this,e),yield this.updateLayer("addSink"),this.pushInHistory("uiSetLayer-high")})}removeSink(e){var t=i=>super[i];return c(this,null,function*(){t("removeSink").call(this,e),yield this.updateLayer("removeSink"),this._degraded=!1,this.pushInHistory("uiSetLayer-none")})}getSimulcastDefinitions(){return[...this._layerDefinitions]}setSimulcastDefinitons(e){this._layerDefinitions=e}setLayerFromServer(e){this._degraded=(e.publisher_degraded||e.subscriber_degraded)&&e.current_layer===q.NONE,this._degradedAt=this._degraded?new Date:this._degradedAt;let t=e.current_layer;return o.d(`[Remote Track] ${this.logIdentifier} ${this.stream.id} - layer update from sfu`,`currLayer=${e.current_layer}, preferredLayer=${e.expected_layer}`,`sub_degraded=${e.subscriber_degraded}`,`pub_degraded=${e.publisher_degraded}`,`isDegraded=${this._degraded}`),this.stream.setVideoLayerLocally(t,this.logIdentifier,"setLayerFromServer"),this.pushInHistory(`sfuLayerUpdate-${t}`),this._degraded}setDegradedFromSdk(e){this._degraded=e,this._degradedAt=e?new Date:this._degradedAt,this.updateLayer("sdkDegradation"),this.pushInHistory(e?"sdkDegraded-none":"sdkRecovered-high")}updateLayer(e){return c(this,null,function*(){let t=this.degraded||!this.hasSinks()?q.NONE:this.preferredLayer;!this.shouldSendVideoLayer(t,e)||(yield this.requestLayer(t,e))})}pushInHistory(e){Vi&&this.history.push({name:e,layer:this.getLayer(),degraded:this.degraded})}requestLayer(e,t){return c(this,null,function*(){try{let i=yield this.stream.setVideoLayer(e,this.trackId,this.logIdentifier,t);return o.d(`[Remote Track] ${this.logIdentifier}`,`Requested layer ${e}, source=${this.source}`),i}catch(i){throw o.d(`[Remote Track] ${this.logIdentifier}`,`Failed to set layer ${e}, source=${this.source}, ${i.message}`),i}})}shouldSendVideoLayer(e,t){let i=this.getLayer();return this.degraded&&e===q.NONE?!0:i===e?(o.d(`[Remote Track] ${this.logIdentifier}`,`Not sending update, already on layer ${e}, source=${t}`),!1):!0}},qi=class{constructor(){this.history=[]}push(e){e.time=new Date().toISOString().split("T")[1],this.history.push(e)}};var ke=class extends be{constructor(){super(...arguments);this.TAG="[HMSLocalStream]";this.connection=null}setConnection(e){this.connection=e}addTransceiver(e,t){let i=[];if(e instanceof z)if(t.length>0)o.v(this.TAG,"Simulcast enabled with layers",t),i.push(...t);else{let s={active:this.nativeStream.active};e.settings.maxBitrate&&!ue&&(s.maxBitrate=e.settings.maxBitrate),i.push(s)}let r=this.connection.addTransceiver(e.getTrackBeingSent(),{streams:[this.nativeStream],direction:"sendonly",sendEncodings:i});return this.setPreferredCodec(r,e.nativeTrack.kind),r}setMaxBitrateAndFramerate(e){return c(this,null,function*(){var t;yield(t=this.connection)==null?void 0:t.setMaxBitrateAndFramerate(e)})}setPreferredCodec(e,t){}replaceTrack(e,t){return c(this,null,function*(){yield this.replaceSenderTrack(e,t),e.stop(),this.replaceStreamTrack(e,t)})}replaceStreamTrack(e,t){this.nativeStream.addTrack(t),this.nativeStream.removeTrack(e)}replaceSenderTrack(e,t){return c(this,null,function*(){var r;let i=(r=this.connection)==null?void 0:r.getSenders().find(s=>s.track&&s.track.id===e.id);if(i===void 0){o.w(this.TAG,`No sender found for trackId=${e.id}`);return}yield i.replaceTrack(t)})}removeSender(e){var i;let t=0;(i=this.connection)==null||i.getSenders().forEach(r=>{var s,n;if(((s=r.track)==null?void 0:s.id)===e.trackId||((n=r.track)==null?void 0:n.id)===e.getTrackIDBeingSent()){this.connection.removeTrack(r),t+=1;let d=this.tracks.indexOf(e);d!==-1?this.tracks.splice(d,1):o.e(this.TAG,`Cannot find ${e.trackId} in locally stored tracks`)}}),t!==1&&o.e(this.TAG,`Removed ${t} sender's, expected to remove 1`)}hasSender(e){var t;return!!((t=this.connection)==null?void 0:t.getSenders().find(i=>{var r,s;return((r=i.track)==null?void 0:r.id)===e.trackId||((s=i.track)==null?void 0:s.id)===e.getTrackIDBeingSent()}))}trackUpdate(e){var t;(t=this.connection)==null||t.trackUpdate(e)}};var Ji={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},We,ge=class{constructor(e,t,i,r,s){this.store=e;this.observer=t;this.deviceManager=i;this.eventBus=r;this.analyticsTimer=s;this.TAG="[LocalTrackManager]";this.setScreenCaptureHandleConfig()}getTracksToPublish(e){return c(this,null,function*(){let t=this.getAVTrackSettings(e);if(!t)return[];let i=!!t.audio,r=!!t.video,s=[],{videoTrack:n,audioTrack:d}=yield this.updateCurrentLocalTrackSettings(t),l=(n==null?void 0:n.stream)||(d==null?void 0:d.stream),h=Boolean(n&&this.store.getTrackById(n.trackId)),u=Boolean(d&&this.store.getTrackById(d.trackId));if(h&&u)return[];let S={audio:i&&!d&&(e.isAudioMuted?"empty":!0),video:r&&!n&&(e.isVideoMuted?"empty":!0)};this.analyticsTimer.start(M.LOCAL_AUDIO_TRACK),this.analyticsTimer.start(M.LOCAL_VIDEO_TRACK);try{o.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:S}),s=yield this.getLocalTracks(S,t,l)}catch(g){s=yield this.retryGetLocalTracks(g,t,S,l)}return this.analyticsTimer.end(M.LOCAL_AUDIO_TRACK),this.analyticsTimer.end(M.LOCAL_VIDEO_TRACK),n&&r&&!h&&s.push(n),d&&i&&!u&&s.push(d),s})}getLocalTracks(){return c(this,arguments,function*(e={audio:!0,video:!0},t,i){try{let r=yield this.getNativeLocalTracks(e,t);return this.createHMSLocalTracks(r,t,i)}catch(r){throw this.eventBus.analytics.publish(H.publish({devices:this.deviceManager.getDevices(),error:r,settings:t})),r}})}getNativeLocalTracks(){return c(this,arguments,function*(e={audio:!1,video:!1},t){let i=new Be(e.video===!0?t.video:null,e.audio===!0?t.audio:null,t.simulcast),r=[];return(i.audio||i.video)&&r.push(...yield this.getAVTracks(i)),r.push(...this.getEmptyTracks(e)),r})}getLocalScreen(e){return c(this,null,function*(){var S;let t=yield this.getOrDefaultScreenshareConfig(e),i=this.getScreenshareSettings(t.videoOnly),r={video:L(v({},i==null?void 0:i.video.toConstraints(!0)),{displaySurface:t.displaySurface}),preferCurrentTab:t.preferCurrentTab,selfBrowserSurface:t.selfBrowserSurface,surfaceSwitching:t.surfaceSwitching,systemAudio:t.systemAudio};if(i==null?void 0:i.audio){let g=(S=i==null?void 0:i.audio)==null?void 0:S.toConstraints();delete g.advanced,r.audio=L(v({},g),{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})}let s;try{o.d("retrieving screenshare with ",{config:t},{constraints:r}),s=yield navigator.mediaDevices.getDisplayMedia(r)}catch(g){o.w(this.TAG,"error in getting screenshare - ",g);let E=te(g,j.SCREEN);throw this.eventBus.analytics.publish(H.publish({error:E,devices:this.deviceManager.getDevices(),settings:new Be(i==null?void 0:i.video,i==null?void 0:i.audio,!1)})),E}let n=[],d=new ke(s),l=s.getVideoTracks()[0],h=new z(d,l,"screen",this.eventBus,i==null?void 0:i.video);h.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"screen"));try{let g=this.validateCurrentTabCapture(h,t.forceCurrentTab);h.isCurrentTab=g,yield h.cropTo(t.cropTarget)}catch(g){throw s.getTracks().forEach(E=>E.stop()),g}n.push(h);let u=s.getAudioTracks()[0];if(u){let g=new fe(d,u,"screen",this.eventBus,i==null?void 0:i.audio);n.push(g)}return o.v(this.TAG,"getLocalScreen",n),n})}setScreenCaptureHandleConfig(e){var t;!((t=navigator.mediaDevices)==null?void 0:t.setCaptureHandleConfig)||this.isInIframe()||(e=e||{},Object.assign(e,{handle:(0,ji.v4)(),exposeOrigin:!1,permittedOrigins:[window.location.origin]}),o.d("setting capture handle - ",e.handle),navigator.mediaDevices.setCaptureHandleConfig(e),this.captureHandleIdentifier=e.handle)}validateCurrentTabCapture(e,t){let i=e.getCaptureHandle(),r=!!(this.captureHandleIdentifier&&(i==null?void 0:i.handle)===this.captureHandleIdentifier);if(t&&!r)throw o.e(this.TAG,"current tab was not shared with forceCurrentTab as true"),m.TracksErrors.CurrentTabNotShared();return r}requestPermissions(){return c(this,null,function*(){try{(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})).getTracks().forEach(t=>t.stop())}catch(e){o.e(this.TAG,e)}})}static getEmptyVideoTrack(e){var l,h,u;let t=((l=e==null?void 0:e.getSettings())==null?void 0:l.width)||320,i=((h=e==null?void 0:e.getSettings())==null?void 0:h.height)||240,r=10;We||(We=Object.assign(document.createElement("canvas"),{width:t,height:i}),(u=We.getContext("2d"))==null||u.fillRect(0,0,t,i));let n=We.captureStream(r).getVideoTracks()[0],d=setInterval(()=>{if(n.readyState==="ended"){clearInterval(d);return}let S=We.getContext("2d");if(S){let E=S.getImageData(0,0,1,1).data[0]===0?1:0;S.fillStyle=`rgb(${E}, 0, 0)`,S.fillRect(0,0,1,1)}},1e3/r);return n.onended=()=>{clearInterval(d)},n.enabled=!1,n}static getEmptyAudioTrack(){let e=ne.getAudioContext(),t=e.createOscillator(),i=e.createMediaStreamDestination();t.connect(i),t.start();let r=i.stream.getAudioTracks()[0];return r.enabled=!1,r}getAVTracks(e){return c(this,null,function*(){try{let t=yield navigator.mediaDevices.getUserMedia({audio:e.audio?e.audio.toConstraints():!1,video:e.video?e.video.toConstraints():!1});return t.getVideoTracks().concat(t.getAudioTracks())}catch(t){yield this.deviceManager.init();let i=!!(!this.deviceManager.hasWebcamPermission&&e.video),r=!!(!this.deviceManager.hasMicrophonePermission&&e.audio),s=this.getErrorType(i,r);throw te(t,s)}})}getAVTrackSettings(e){let t=this.getAudioSettings(e),i=this.getVideoSettings(e);return!t&&!i?null:new it().video(i).audio(t).build()}isInIframe(){try{return window.self!==window.top}catch(e){return!0}}retryGetLocalTracks(e,t,i,r){return c(this,null,function*(){if(e instanceof T&&e.action===p.TRACK){this.observer.onFailure(e);let s=e.code===f.TracksErrors.OVER_CONSTRAINED,n=e.message.includes("audio"),d=e.message.includes("video");if(s){let l=new it().video(new Ie).audio(new Pe).build();o.w(this.TAG,"Fetch AV Tracks failed with overconstrained error",{fetchTrackOptions:i},{error:e});try{return yield this.getLocalTracks(i,l,r)}catch(h){let u=h instanceof T?h.nativeError:h,S=h;if((u==null?void 0:u.name)==="OverconstrainedError"){let g=m.TracksErrors.GenericTrack(p.TRACK,"Overconstrained error after dropping all constraints");g.addNativeError(u),S=g}return yield this.retryGetLocalTracks(S,t,i,r)}}i.audio=n?"empty":i.audio,i.video=d?"empty":i.video,o.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:i},e);try{return yield this.getLocalTracks(i,t,r)}catch(l){return o.w(this.TAG,"Fetch empty tacks failed",l),i.audio=i.audio&&"empty",i.video=i.video&&"empty",this.observer.onFailure(l),yield this.getLocalTracks(i,t,r)}}else return o.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e),this.observer.onFailure(e),[]})}getErrorType(e,t){return e&&t?j.AV:e?j.VIDEO:t?j.AUDIO:j.UNKNOWN}getEmptyTracks(e){let t=[];return e.audio==="empty"&&t.push(ge.getEmptyAudioTrack()),e.video==="empty"&&t.push(ge.getEmptyVideoTrack()),t}updateCurrentLocalTrackSettings(e){return c(this,null,function*(){let t=this.store.getLocalPeerTracks(),i=t.find(s=>s.type===F.VIDEO&&s.source==="regular"),r=t.find(s=>s.type===F.AUDIO&&s.source==="regular");return(e==null?void 0:e.video)&&(yield i==null?void 0:i.setSettings(e.video)),(e==null?void 0:e.audio)&&(yield r==null?void 0:r.setSettings(e.audio)),{videoTrack:i,audioTrack:r}})}getAudioSettings(e){var n;let t=this.store.getPublishParams();if(!t||!((n=t.allowed)==null?void 0:n.includes("audio")))return null;let i=this.store.getLocalPeer(),r=i==null?void 0:i.audioTrack,s=(r==null?void 0:r.settings.deviceId)||e.audioInputDeviceId;return new ee().codec(t.audio.codec).maxBitrate(t.audio.bitRate).deviceId(s||Ji.audioInputDeviceId).build()}getVideoSettings(e){var d;let t=this.store.getPublishParams();if(!t||!((d=t.allowed)==null?void 0:d.includes("video")))return null;let i=this.store.getLocalPeer(),r=i==null?void 0:i.videoTrack,s=(r==null?void 0:r.settings.deviceId)||e.videoDeviceId,n=t.video;return new Q().codec(n.codec).maxBitrate(n.bitRate).maxFramerate(n.frameRate).setWidth(n.width).setHeight(n.height).deviceId(s||Ji.videoDeviceId).build()}getScreenshareSettings(e=!1){var r;let t=this.store.getPublishParams();if(!t||!((r=t.allowed)==null?void 0:r.includes("screen")))return null;let i=t.screen;return{video:new Q().maxBitrate(i.bitRate,!1).codec(i.codec).maxFramerate(i.frameRate).setWidth(i.width).setHeight(i.height).build(),audio:e?void 0:new ee().build()}}getOrDefaultScreenshareConfig(e){return c(this,null,function*(){var i;let t=Object.assign({videoOnly:!1,audioOnly:!1,forceCurrentTab:!1,preferCurrentTab:!1,selfBrowserSurface:"exclude",surfaceSwitching:"include",systemAudio:"exclude",displaySurface:"monitor"},e||{});return t.forceCurrentTab&&(t.videoOnly=!0,t.preferCurrentTab=!0,t.selfBrowserSurface="include",t.surfaceSwitching="exclude"),t.preferCurrentTab&&(t.selfBrowserSurface="include",t.displaySurface=void 0),t.cropElement&&((i=window.CropTarget)==null?void 0:i.fromElement)&&(t.cropTarget=yield window.CropTarget.fromElement(t.cropElement)),t})}createHMSLocalTracks(e,t,i){let r=e.find(d=>d.kind==="video"),s=e.find(d=>d.kind==="audio");i?e.forEach(d=>i==null?void 0:i.nativeStream.addTrack(d)):i=new ke(new MediaStream(e));let n=[];if(s&&(t==null?void 0:t.audio)){let d=new fe(i,s,"regular",this.eventBus,t.audio);n.push(d)}if(r&&(t==null?void 0:t.video)){let d=new z(i,r,"regular",this.eventBus,t.video);d.setSimulcastDefinitons(this.store.getSimulcastDefinitionsForPeer(this.store.getLocalPeer(),"regular")),n.push(d)}return n}};var Vt=class{constructor(e,t){this.eventBus=e;this.listener=t;this.TAG="[NetworkTestManager]";this.controller=new AbortController;this.start=e=>c(this,null,function*(){var h;if(!e)return;let{url:t,timeout:i,scoreMap:r}=e,s=this.controller.signal,n=Date.now(),d=0,l=W(i).then(()=>{this.controller.abort()});try{let S=(h=(yield fetch(`${t}?${Date.now()}`,{signal:s})).body)==null?void 0:h.getReader();if(!S)throw Error("unable to process request");let g=()=>c(this,null,function*(){if(!!S)try{let E=!1;for(;!E;){let{value:N,done:O}=yield S.read();E=O,N&&(d+=N.byteLength,this.sendScore({scoreMap:r,downloadedSize:d,startTime:n}))}}catch(E){E.name!=="AbortError"&&o.e(this.TAG,E)}});return Promise.race([g(),l]).then(()=>{this.sendScore({scoreMap:r,downloadedSize:d,startTime:n,finished:!0})}).catch(E=>{o.e(this.TAG,E),this.updateScoreToListener(0),this.eventBus.analytics.publish(H.previewNetworkQuality({error:E.message}))})}catch(u){u.name!=="AbortError"?(o.e(this.TAG,u),this.updateScoreToListener(0),this.eventBus.analytics.publish(H.previewNetworkQuality({error:u.message}))):o.d(this.TAG,u)}});this.stop=()=>{this.controller.signal.aborted||this.controller.abort()};this.sendScore=({scoreMap:e,downloadedSize:t,startTime:i,finished:r=!1})=>{let s=(Date.now()-i)/1e3,d=t/1024/s*8,l=-1;for(let h in e){let u=e[h];d>=u.low&&(!u.high||d<=u.high)&&(l=Number(h))}this.updateScoreToListener(l),r&&this.eventBus.analytics.publish(H.previewNetworkQuality({score:l,downLink:d.toFixed(2)}))}}updateScoreToListener(e){var t,i;e!==this.score&&(this.score=e,(i=(t=this.listener)==null?void 0:t.onNetworkQuality)==null||i.call(t,e))}};var ht=class{constructor(e,t,i,r,s){this.store=e;this.transport=t;this.publish=i;this.removeAuxiliaryTrack=r;this.listener=s;this.handleLocalPeerRoleUpdate=i=>c(this,[i],function*({oldRole:e,newRole:t}){var s;let r=this.store.getLocalPeer();!r||(yield this.diffRolesAndPublishTracks({oldRole:e,newRole:t}),(s=this.listener)==null||s.onPeerUpdate(K.ROLE_UPDATED,r))});this.diffRolesAndPublishTracks=i=>c(this,[i],function*({oldRole:e,newRole:t}){var g,E,N,O,I;let r=new Set(e.publishParams.allowed),s=new Set(t.publishParams.allowed),n=this.removeTrack(r,s,"video"),d=this.hasSimulcastDifference((g=e.publishParams.simulcast)==null?void 0:g.video,(E=t.publishParams.simulcast)==null?void 0:E.video),l=this.removeTrack(r,s,"audio"),h=this.removeTrack(r,s,"screen"),u=this.hasSimulcastDifference((N=e.publishParams.simulcast)==null?void 0:N.screen,(O=t.publishParams.simulcast)==null?void 0:O.screen);yield this.removeAudioTrack(l),yield this.removeVideoTracks(n||d),yield this.removeScreenTracks(h||u);let S=((I=this.store.getConfig())==null?void 0:I.settings)||{isAudioMuted:!0,isVideoMuted:!0,audioInputDeviceId:"default",videoDeviceId:"default",audioOutputDeviceId:"default"};yield this.publish(L(v({},S),{isAudioMuted:!0,isVideoMuted:!0}))})}removeVideoTracks(e){return c(this,null,function*(){var i;if(!e)return;let t=this.store.getLocalPeer();(t==null?void 0:t.videoTrack)&&(t.videoTrack.isPublished?yield this.transport.unpublish([t.videoTrack]):yield t.videoTrack.cleanup(),(i=this.listener)==null||i.onTrackUpdate(D.TRACK_REMOVED,t.videoTrack,t),t.videoTrack=void 0),yield this.removeAuxTracks(r=>r.source!=="screen"&&r.type==="video")})}removeAudioTrack(e){return c(this,null,function*(){var i;if(!e)return;let t=this.store.getLocalPeer();(t==null?void 0:t.audioTrack)&&(t.audioTrack.isPublished?yield this.transport.unpublish([t.audioTrack]):yield t.audioTrack.cleanup(),(i=this.listener)==null||i.onTrackUpdate(D.TRACK_REMOVED,t.audioTrack,t),t.audioTrack=void 0),yield this.removeAuxTracks(r=>r.source!=="screen"&&r.type==="audio")})}removeScreenTracks(e){return c(this,null,function*(){!e||(yield this.removeAuxTracks(t=>t.source==="screen"))})}removeAuxTracks(e){return c(this,null,function*(){let t=this.store.getLocalPeer();if(t==null?void 0:t.auxiliaryTracks){let i=[...t.auxiliaryTracks];for(let r of i)e(r)&&(yield this.removeAuxiliaryTrack(r.trackId))}})}removeTrack(e,t,i){return e.has(i)&&!t.has(i)}hasSimulcastDifference(e,t){var i,r;return!e&&!t?!1:((i=e==null?void 0:e.layers)==null?void 0:i.length)!==((r=t==null?void 0:t.layers)==null?void 0:r.length)}};var Qi=class{constructor(){this.TAG="[HTTPAnalyticsTransport]";this.failedEvents=new re("client-events");this.isConnected=!0;this.env=null;this.websocketURL=""}setEnv(e){this.env=e,this.flushFailedEvents()}setWebsocketEndpoint(e){this.websocketURL=e}sendEvent(e){if(!this.env||!this.websocketURL){this.addEventToStorage(e);return}let t={event:e.name,payload:e.properties,event_id:String(e.timestamp),peer:e.metadata.peer,timestamp:e.timestamp,device_id:e.device_id,cluster:{websocket_url:this.websocketURL}},i=this.env===$.PROD?$i:Wi;fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.metadata.token}`,user_agent_v2:e.metadata.userAgent},body:JSON.stringify(t)}).then(r=>{if(r.status===401){this.removeFromStorage(e);return}if(r.status!==200)throw Error(r.statusText);this.removeFromStorage(e)}).catch(r=>{o.v(this.TAG,"Failed to send event",r,e),this.addEventToStorage(e)})}flushFailedEvents(){let e=this.failedEvents.get();e==null||e.forEach(t=>this.sendEvent(t))}addEventToStorage(e){let t=this.failedEvents.get()||[];t.find(i=>i.timestamp===e.timestamp)||(t.length===Ki&&t.shift(),t.push(e),this.failedEvents.set(t))}removeFromStorage(e){let t=this.failedEvents.get()||[],i=t.findIndex(r=>r.timestamp===e.timestamp);i>-1&&(t.splice(i,1),this.failedEvents.set(t))}},oe=new Qi;var pt=class{constructor(){this.knownRoles={};this.peers={};this.tracks={};this.peerTrackStates={};this.speakers=[];this.roleDetailsArrived=!1;this.env=$.PROD;this.simulcastEnabled=!1;this.userAgent=xe(this.env)}getConfig(){return this.config}setSimulcastEnabled(e){this.simulcastEnabled=e}getEnv(){return this.env}getPublishParams(){let e=this.getLocalPeer(),t=(e==null?void 0:e.asRole)||(e==null?void 0:e.role);return t==null?void 0:t.publishParams}getRoom(){return this.room}getPolicyForRole(e){return this.knownRoles[e]}getKnownRoles(){return this.knownRoles}getLocalPeer(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]}getRemotePeers(){return Object.values(this.peers).filter(e=>!e.isLocal)}getPeers(){return Object.values(this.peers)}getPeerById(e){if(this.peers[e])return this.peers[e]}getTracksMap(){return this.tracks}getTracks(){return Object.values(this.tracks)}getVideoTracks(){return this.getTracks().filter(e=>e.type===F.VIDEO)}getRemoteVideoTracks(){return this.getTracks().filter(e=>e instanceof Se)}getAudioTracks(){return this.getTracks().filter(e=>e.type===F.AUDIO)}getPeerTracks(e){let t=e?this.peers[e]:void 0,i=[];return(t==null?void 0:t.videoTrack)&&i.push(t.videoTrack),(t==null?void 0:t.audioTrack)&&i.push(t.audioTrack),i.concat((t==null?void 0:t.auxiliaryTracks)||[])}getLocalPeerTracks(){return this.getPeerTracks(this.localPeerId)}getTrackById(e){var r,s;let t=this.tracks[e];if(t)return t;let i=this.getLocalPeer();if(i){if((r=i.audioTrack)==null?void 0:r.isPublishedTrackId(e))return i.audioTrack;if((s=i.videoTrack)==null?void 0:s.isPublishedTrackId(e))return i.videoTrack}}getPeerByTrackId(e){let t=this.tracks[e];return t.peerId?this.peers[t.peerId]:void 0}getSpeakers(){return this.speakers}getSpeakerPeers(){return this.speakers.map(e=>e.peer)}getUserAgent(){return this.userAgent}createAndSetUserAgent(e){this.userAgent=xe(this.env,e)}setRoom(e){this.room=e}setKnownRoles(e){var i,r;if(this.knownRoles=e.known_roles,this.roleDetailsArrived=!0,!this.simulcastEnabled)return;let t=(i=this.knownRoles[e.name])==null?void 0:i.publishParams;this.videoLayers=this.convertSimulcastLayers((r=t.simulcast)==null?void 0:r.video),this.updatePeersPolicy()}hasRoleDetailsArrived(){return this.roleDetailsArrived}setConfig(e){var t,i,r;if(Y.rememberDevices(Boolean(e.rememberDeviceSelection)),e.rememberDeviceSelection){let s=Y.getSelection();s&&(e.settings||(e.settings={}),((t=s.audioInput)==null?void 0:t.deviceId)&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||s.audioInput.deviceId),((i=s.audioOutput)==null?void 0:i.deviceId)&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||s.audioOutput.deviceId),((r=s.videoInput)==null?void 0:r.deviceId)&&(e.settings.videoDeviceId=e.settings.videoDeviceId||s.videoInput.deviceId))}this.config=e,this.setEnv()}addPeer(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)}addTrack(e){this.tracks[e.trackId]=e}getTrackState(e){return this.peerTrackStates[e]}setTrackState(e){this.peerTrackStates[e.trackInfo.track_id]=e}removePeer(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]}removeTrack(e){delete this.tracks[e]}updateSpeakers(e){this.speakers=e}updateAudioOutputVolume(e){return c(this,null,function*(){for(let t of this.getAudioTracks())yield t.setVolume(e)})}updateAudioOutputDevice(e){return c(this,null,function*(){let t=[];this.getAudioTracks().forEach(i=>{t.push(i.setOutputDevice(e))}),yield Promise.all(t)})}getSimulcastLayers(e){var t;return this.simulcastEnabled?e==="screen"?[]:((t=this.videoLayers)==null?void 0:t.layers)||[]:[]}convertSimulcastLayers(e){if(!!e)return L(v({},e),{layers:(e.layers||[]).map(t=>L(v({},t),{maxBitrate:t.maxBitrate*1e3}))})}getSimulcastDefinitionsForPeer(e,t){var d,l,h;if([!e||!e.role,t==="screen",!this.simulcastEnabled].some(u=>!!u))return[];let i=this.getPolicyForRole(e.role.name).publishParams,r,s,n;return t==="regular"?(r=(d=i.simulcast)==null?void 0:d.video,s=i.video.width,n=i.video.height):t==="screen"&&(r=(l=i.simulcast)==null?void 0:l.screen,s=i.screen.width,n=i.screen.height),((h=r==null?void 0:r.layers)==null?void 0:h.map(u=>{let S=tt[u.rid],g={width:s/u.scaleResolutionDownBy,height:n/u.scaleResolutionDownBy};return{layer:S,resolution:g}}))||[]}getErrorListener(){return this.errorListener}cleanUp(){let e=this.getTracks();for(let t of e)t.cleanup();this.room=void 0,this.config=void 0,this.localPeerId=void 0,this.roleDetailsArrived=!1}setErrorListener(e){this.errorListener=e}updatePeersPolicy(){this.getPeers().forEach(e=>{var t;if(!e.role){(t=this.errorListener)==null||t.onError(m.GenericErrors.InvalidRole(p.VALIDATION,""));return}e.role=this.getPolicyForRole(e.role.name)})}setEnv(){var r;let t=((r=this.config)==null?void 0:r.initEndpoint).split("https://")[1],i=$.PROD;t.startsWith($.PROD)?i=$.PROD:t.startsWith($.QA)?i=$.QA:t.startsWith($.DEV)&&(i=$.DEV),this.env=i,oe.setEnv(i)}};var $t=class{constructor(e){this.store=e;this.bufferSize=ut;this.TAG="[AnalyticsEventsService]";this.transport=null;this.pendingEvents=[];this.level=et.INFO}setTransport(e){this.transport=e}reset(){this.transport=null,this.pendingEvents=[]}queue(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){let t=this.pendingEvents.shift();o.d(this.TAG,"Max buffer size reached","Removed event to accommodate new events",t)}return this}flushFailedClientEvents(){oe.flushFailedEvents()}flush(){var e;try{for(;this.pendingEvents.length>0;){let t=this.pendingEvents.shift();t&&(t.metadata.peer.peer_id=(e=this.store.getLocalPeer())==null?void 0:e.peerId,t.metadata.userAgent=this.store.getUserAgent(),this.transport&&this.transport.transportProvider.isConnected?this.transport.sendEvent(t):this.sendClientEventOnHTTP(t))}}catch(t){o.w(this.TAG,"Flush Failed",t)}}sendClientEventOnHTTP(e){var r,s,n,d;let t=this.store.getRoom(),i=this.store.getLocalPeer();e.metadata.token=(r=this.store.getConfig())==null?void 0:r.authToken,e.metadata.peer={session_id:t.sessionId,room_id:t.id,room_name:t.name,template_id:t.templateId,joined_at:(s=t.joinedAt)==null?void 0:s.getTime(),session_started_at:(n=t.startedAt)==null?void 0:n.getTime(),role:(d=i==null?void 0:i.role)==null?void 0:d.name,user_name:i==null?void 0:i.name,user_data:i==null?void 0:i.metadata},oe.sendEvent(e)}};var Yi=J(require("uuid"));var zi={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},Br=3,mt=class{constructor(e,t,i){this.store=e;this.deviceManager=t;this.eventBus=i;this.autoPausedTracks=new Set;this.TAG="[AudioSinkManager]:";this.volume=100;this.state=v({},zi);this.retryCountMapping=new Map;this.handleAudioPaused=e=>c(this,null,function*(){var s;let i=(s=e.target.srcObject)==null?void 0:s.getAudioTracks()[0];if(!(i==null?void 0:i.enabled))return;o.d(this.TAG,"Audio Paused",e.target.id);let r=this.store.getTrackById(e.target.id);r&&(wt()?(yield W(500),this.playAudioFor(r)):this.autoPausedTracks.add(r))});this.handleTrackUpdate=({track:e})=>{o.d(this.TAG,"Track updated",`${e}`)};this.handleTrackAdd=r=>c(this,[r],function*({track:e,peer:t,callListener:i=!0}){var n,d,l;if((n=this.retryCountMapping.get(e.trackId))!=null?n:0>Br)return;let s=document.createElement("audio");s.style.display="none",s.id=e.trackId,s.addEventListener("pause",this.handleAudioPaused),s.onerror=()=>{var u,S;o.e(this.TAG,"error on audio element",s.error);let h=m.TracksErrors.AudioPlaybackError(`Audio playback error for track - ${e.trackId}`);this.eventBus.analytics.publish(H.audioPlaybackError(h)),((u=s==null?void 0:s.error)==null?void 0:u.code)===MediaError.MEDIA_ERR_DECODE&&(this.removeAudioElement(s,e),this.retryCountMapping.set(e.trackId,((S=this.retryCountMapping.get(e.trackId))!=null?S:0)+1),this.handleTrackAdd({track:e,peer:t,callListener:!1}))},e.setAudioElement(s),e.setVolume(this.volume),o.d(this.TAG,"Audio track added",`${e}`),yield this.init(),(d=this.audioSink)==null||d.append(s),this.outputDevice&&(yield e.setOutputDevice(this.outputDevice)),s.srcObject=new MediaStream([e.nativeTrack]),i&&((l=this.listener)==null||l.onTrackUpdate(D.TRACK_ADDED,e,t)),yield this.handleAutoplayError(e)});this.handleAutoplayError=e=>c(this,null,function*(){if(this.state.autoplayFailed===void 0&&(this.state.autoplayCheckPromise||(this.state.autoplayCheckPromise=new Promise(t=>{this.playAudioFor(e).then(t)})),yield this.state.autoplayCheckPromise),this.state.autoplayFailed){this.autoPausedTracks.add(e);return}yield this.playAudioFor(e)});this.handleAudioDeviceChange=e=>{e.error||!e.selection||e.type==="video"||this.unpauseAudioTracks()};this.handleTrackRemove=e=>{this.autoPausedTracks.delete(e);let t=document.getElementById(e.trackId);t&&this.removeAudioElement(t,e),this.audioSink&&this.audioSink.childElementCount===0&&(this.state.autoplayCheckPromise=void 0,this.state.autoplayFailed=void 0),o.d(this.TAG,"Audio track removed",`${e}`)};this.unpauseAudioTracks=()=>c(this,null,function*(){let e=[];this.autoPausedTracks.forEach(t=>{e.push(this.playAudioFor(t))}),yield Promise.all(e)});this.removeAudioElement=(e,t)=>{e&&(e.removeEventListener("pause",this.handleAudioPaused),e.srcObject=null,e.remove(),t.setAudioElement(null))};this.eventBus.audioTrackAdded.subscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.subscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.subscribe(this.handleTrackUpdate),this.eventBus.deviceChange.subscribe(this.handleAudioDeviceChange)}setListener(e){this.listener=e}get outputDevice(){return this.deviceManager.outputDevice}getVolume(){return this.volume}setVolume(e){return c(this,null,function*(){yield this.store.updateAudioOutputVolume(e),this.volume=e})}unblockAutoplay(){return c(this,null,function*(){this.autoPausedTracks.size>0&&this.unpauseAudioTracks()})}init(e){if(this.state.initialized)return;this.state.initialized=!0;let t=document.createElement("div");t.id=`HMS-SDK-audio-sink-${(0,Yi.v4)()}`,(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t}cleanUp(){var e;(e=this.audioSink)==null||e.remove(),this.audioSink=void 0,this.retryCountMapping.clear(),this.eventBus.audioTrackAdded.unsubscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.unsubscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.unsubscribe(this.handleTrackUpdate),this.eventBus.deviceChange.unsubscribe(this.handleAudioDeviceChange),this.autoPausedTracks=new Set,this.state=v({},zi)}playAudioFor(e){return c(this,null,function*(){let t=e.getAudioElement();if(!t){o.w(this.TAG,"No audio element found on track",e.trackId);return}try{yield t.play(),this.state.autoplayFailed=!1,this.autoPausedTracks.delete(e),o.d(this.TAG,"Played track",`${e}`)}catch(i){this.autoPausedTracks.add(e),o.e(this.TAG,"Failed to play track",`${e}`,i);let r=i;if(!this.state.autoplayFailed&&r.name==="NotAllowedError"){this.state.autoplayFailed=!0;let s=m.TracksErrors.AutoplayBlocked(p.AUTOPLAY,"");s.addNativeError(r),this.eventBus.analytics.publish(H.autoplayError()),this.eventBus.autoplayError.publish(s)}}})}};var gt=class{constructor(e,t){this.store=e;this.eventBus=t;this.audioInput=[];this.audioOutput=[];this.videoInput=[];this.hasWebcamPermission=!1;this.hasMicrophonePermission=!1;this.TAG="[Device Manager]:";this.initialized=!1;this.videoInputChanged=!1;this.audioInputChanged=!1;this.updateOutputDevice=e=>c(this,null,function*(){let t=this.audioOutput.find(i=>i.deviceId===e);return t&&(this.outputDevice=t,yield this.store.updateAudioOutputDevice(t),Y.updateSelection("audioOutput",{deviceId:t.deviceId,groupId:t.groupId})),t});this.getCurrentSelection=()=>{var n,d;let e=this.store.getLocalPeer(),t=this.createIdentifier((n=e==null?void 0:e.audioTrack)==null?void 0:n.getMediaTrackSettings()),i=this.createIdentifier((d=e==null?void 0:e.videoTrack)==null?void 0:d.getMediaTrackSettings()),r=this.audioInput.find(l=>this.createIdentifier(l)===t),s=this.videoInput.find(l=>this.createIdentifier(l)===i);return{audioInput:r,videoInput:s,audioOutput:this.outputDevice}};this.computeChange=(e,t)=>e.length!==t.length?!0:t.some(i=>!e.includes(this.createIdentifier(i)));this.enumerateDevices=()=>c(this,null,function*(){try{let e=yield navigator.mediaDevices.enumerateDevices(),t=this.videoInput.map(this.createIdentifier),i=this.audioInput.map(this.createIdentifier);this.audioInput=[],this.audioOutput=[],this.videoInput=[],e.forEach(r=>{r.kind==="audioinput"&&r.label?(this.hasMicrophonePermission=!0,this.audioInput.push(r)):r.kind==="audiooutput"?this.audioOutput.push(r):r.kind==="videoinput"&&r.label&&(this.hasWebcamPermission=!0,this.videoInput.push(r))}),this.videoInputChanged=this.computeChange(t,this.videoInput),this.audioInputChanged=this.computeChange(i,this.audioInput),Y.setDevices({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput]}),this.logDevices("Enumerate Devices")}catch(e){o.e(this.TAG,"Failed enumerating devices",e)}});this.handleDeviceChange=Li(()=>c(this,null,function*(){yield this.enumerateDevices(),this.logDevices("After Device Change");let e=this.store.getLocalPeer();yield this.setOutputDevice(!0),yield this.handleAudioInputDeviceChange(e==null?void 0:e.audioTrack),yield this.handleVideoInputDeviceChange(e==null?void 0:e.videoTrack),this.eventBus.analytics.publish(H.deviceChange({selection:this.getCurrentSelection(),type:"change",devices:this.getDevices()}))}),500).bind(this);this.handleAudioInputDeviceChange=e=>c(this,null,function*(){if(!e){o.d(this.TAG,"No Audio track on local peer");return}if(!this.audioInputChanged){o.d(this.TAG,"No Change in AudioInput Device");return}let t=this.getNewAudioInputDevice();if(!t||!t.deviceId){this.eventBus.analytics.publish(H.deviceChange({selection:{audioInput:t},error:new Error("Audio device not found"),devices:this.getDevices(),type:"audioInput"})),o.w(this.TAG,"Audio device not found");return}let{settings:i}=e,r=new ee().codec(i.codec).maxBitrate(i.maxBitrate).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"audioInput"}),this.logDevices("Audio Device Change Success")}catch(s){o.e(this.TAG,"[Audio Device Change]",s),this.eventBus.analytics.publish(H.deviceChange({selection:{audioInput:t},devices:this.getDevices(),type:"audioInput",error:s})),this.eventBus.deviceChange.publish({error:s,selection:t,type:"audioInput",devices:this.getDevices()})}});this.handleVideoInputDeviceChange=e=>c(this,null,function*(){if(!e){o.d(this.TAG,"No video track on local peer");return}if(!this.videoInputChanged){o.d(this.TAG,"No Change in VideoInput Device");return}let t=this.videoInput[0];if(!t||!t.deviceId){this.eventBus.analytics.publish(H.deviceChange({selection:{videoInput:t},error:new Error("Video device not found"),devices:this.getDevices(),type:"video"})),o.w(this.TAG,"Video device not found");return}let{settings:i}=e,r=new Q().codec(i.codec).maxBitrate(i.maxBitrate).maxFramerate(i.maxFramerate).setWidth(i.width).setHeight(i.height).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"video"}),this.logDevices("Video Device Change Success")}catch(s){o.e(this.TAG,"[Video Device Change]",s),this.eventBus.analytics.publish(H.deviceChange({selection:{videoInput:t},devices:this.getDevices(),type:"video",error:s})),this.eventBus.deviceChange.publish({error:s,type:"video",selection:t,devices:this.getDevices()})}});let i=({enabled:r,track:s})=>r&&s.source==="regular";this.eventBus.localVideoEnabled.waitFor(i).then(()=>c(this,null,function*(){yield this.enumerateDevices(),this.videoInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})})),this.eventBus.localAudioEnabled.waitFor(i).then(()=>c(this,null,function*(){yield this.enumerateDevices(),this.audioInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})}))}init(e=!1){return c(this,null,function*(){this.initialized&&!e||(!this.initialized&&navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),this.initialized=!0,yield this.enumerateDevices(),this.logDevices("Init"),yield this.setOutputDevice(),this.eventBus.deviceChange.publish({devices:this.getDevices()}),this.eventBus.analytics.publish(H.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})))})}getDevices(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}}cleanUp(){this.initialized=!1,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)}createIdentifier(e){return e?`${e.deviceId}${e.groupId}`:""}getNewAudioInputDevice(){let e=this.audioInput.find(t=>t.deviceId==="default");return e?this.audioInput.find(i=>i.deviceId!=="default"&&e.label.includes(i.label)):this.audioInput[0]}setOutputDevice(e=!1){return c(this,null,function*(){let t=this.getNewAudioInputDevice(),i=this.createIdentifier(this.outputDevice);this.outputDevice=this.getAudioOutputDeviceMatchingInput(t),this.outputDevice||(this.outputDevice=this.audioOutput.find(r=>this.createIdentifier(r)===i),this.outputDevice||(this.outputDevice=this.audioOutput.find(r=>r.deviceId==="default")||this.audioOutput[0])),yield this.store.updateAudioOutputDevice(this.outputDevice),e&&i!==this.createIdentifier(this.outputDevice)&&(this.eventBus.analytics.publish(H.deviceChange({selection:{audioOutput:this.outputDevice},devices:this.getDevices(),type:"audioOutput"})),this.eventBus.deviceChange.publish({selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()}))})}getAudioOutputDeviceMatchingInput(e){var r,s;let t=((s=(r=this.store.getConfig())==null?void 0:r.settings)==null?void 0:s.speakerAutoSelectionBlacklist)||[];if(t==="all")return;let i=(e==null?void 0:e.label.toLowerCase())||"";if(!t.some(n=>i.includes(n.toLowerCase()))&&(e==null?void 0:e.groupId))return this.audioOutput.find(n=>e.deviceId!=="default"&&n.label===e.label)}logDevices(e=""){o.d(this.TAG,e,JSON.stringify({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput],selected:this.getCurrentSelection()},null,4))}};var St=class{constructor(e,t){this.deviceManager=e;this.audioSinkManager=t}getVolume(){return this.audioSinkManager.getVolume()}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)}getDevice(){return this.deviceManager.outputDevice}setDevice(e){return this.deviceManager.updateOutputDevice(e)}unblockAutoplay(){return c(this,null,function*(){yield this.audioSinkManager.unblockAutoplay(),yield ne.resumeContext()})}};var Zi=J(require("eventemitter2"));var B=class{constructor(e,t){this.eventName=e;this.eventEmitter=t;this.publish=e=>{this.eventEmitter.emit(this.eventName,e)};this.subscribe=e=>{this.eventEmitter.on(this.eventName,e)};this.subscribeOnce=e=>{this.eventEmitter.once(this.eventName,e)};this.unsubscribe=e=>{this.eventEmitter.off(this.eventName,e)};this.waitFor=e=>this.eventEmitter.waitFor(this.eventName,{filter:e});this.removeAllListeners=()=>{this.eventEmitter.removeAllListeners(this.eventName)}}};var Wt=class{constructor(){this.eventEmitter=new Zi.EventEmitter2;this.deviceChange=new B(V.DEVICE_CHANGE,this.eventEmitter);this.localAudioEnabled=new B(V.LOCAL_AUDIO_ENABLED,this.eventEmitter);this.localVideoEnabled=new B(V.LOCAL_VIDEO_ENABLED,this.eventEmitter);this.statsUpdate=new B(V.STATS_UPDATE,this.eventEmitter);this.trackDegraded=new B(V.TRACK_DEGRADED,this.eventEmitter);this.trackRestored=new B(V.TRACK_RESTORED,this.eventEmitter);this.trackAudioLevelUpdate=new B(V.TRACK_AUDIO_LEVEL_UPDATE,this.eventEmitter);this.audioPluginFailed=new B(V.AUDIO_PLUGIN_FAILED,this.eventEmitter);this.localAudioSilence=new B(V.LOCAL_AUDIO_SILENCE,this.eventEmitter);this.analytics=new B(V.ANALYTICS,this.eventEmitter);this.policyChange=new B(V.POLICY_CHANGE,this.eventEmitter);this.localRoleUpdate=new B(V.LOCAL_ROLE_UPDATE,this.eventEmitter);this.audioTrackUpdate=new B(V.AUDIO_TRACK_UPDATE,this.eventEmitter);this.audioTrackAdded=new B(V.AUDIO_TRACK_ADDED,this.eventEmitter);this.audioTrackRemoved=new B(V.AUDIO_TRACK_REMOVED,this.eventEmitter);this.autoplayError=new B(V.AUTOPLAY_ERROR,this.eventEmitter);this.leave=new B(V.LEAVE,this.eventEmitter)}};var Kt=class{constructor(e,t,i){this.store=e;this.listener=t;this.audioListener=i}handleActiveSpeakers(e){var s,n,d;let t=e["speaker-list"],i=t.map(l=>({audioLevel:l.level,peer:this.store.getPeerById(l.peer_id),track:this.store.getTrackById(l.track_id)}));(s=this.audioListener)==null||s.onAudioLevelUpdate(i),this.store.updateSpeakers(i);let r=t[0];if(r){let l=this.store.getPeerById(r.peer_id);(n=this.listener)==null||n.onPeerUpdate(K.BECAME_DOMINANT_SPEAKER,l)}else(d=this.listener)==null||d.onPeerUpdate(K.RESIGNED_DOMINANT_SPEAKER,null)}};var A;(function(y){y.ROOM_STATE="room-state",y.PEER_JOIN="on-peer-join",y.PEER_LEAVE="on-peer-leave",y.PEER_LIST="peer-list",y.TRACK_METADATA_ADD="on-track-add",y.TRACK_UPDATE="on-track-update",y.CHANGE_TRACK_MUTE_STATE_UPDATE="on-change-track-mute-state-request",y.ACTIVE_SPEAKERS="active-speakers",y.CONNECTION_QUALITY="on-connection-quality-update",y.SFU_STATS="sfu-stats",y.ON_SFU_TRACK_LAYER_UPDATE="on-track-layer-update",y.BROADCAST="on-broadcast",y.ROLE_CHANGE="on-role-change",y.POLICY_CHANGE="on-policy-change",y.ROLE_CHANGE_REQUEST="on-role-change-request",y.TRACK_UPDATE_REQUEST="on-track-update-request",y.PEER_UPDATE="on-peer-update",y.PEER_LEAVE_REQUEST="on-peer-leave-request",y.UNSUPPORTED="unsupported",y.RTMP_START="on-rtmp-start",y.RTMP_STOP="on-rtmp-stop",y.RECORDING_START="on-record-start",y.RECORDING_STOP="on-record-stop",y.HLS_START="on-hls-start",y.HLS_STOP="on-hls-stop"})(A||(A={}));var qt=class{constructor(e,t){this.store=e;this.listener=t;this.TAG="[BroadcastManager]"}handleNotification(e,t){e===A.BROADCAST&&this.handleBroadcast(t)}handleBroadcast(e){var h;let t=e.peer,i=e.info,r=e.roles,s=this.getSender(t),n=e.private?this.store.getLocalPeer():void 0,d=[];if(r==null?void 0:r.length){let u=this.store.getKnownRoles();for(let S of r)u[S]&&d.push(u[S])}let l=new Me(L(v({},i),{sender:s,recipientRoles:d,recipientPeer:n,time:new Date(e.timestamp)}));o.d(this.TAG,`Received Message from sender=${t==null?void 0:t.peer_id}: ${l}`),(h=this.listener)==null||h.onMessageReceived(l)}getSender(e){let t=e?this.store.getPeerById(e.peer_id):void 0;return!t&&e&&(t=new he({peerId:e.peer_id,name:e.info.name,isLocal:!1,customerUserId:e.info.user_id,metadata:e.info.data})),t}};var jt=class{constructor(e){this.listener=e}handleQualityUpdate(e){var r;let i=e.peers.map(s=>({peerID:s.peer_id,downlinkQuality:s.downlink_score}));(r=this.listener)==null||r.onConnectionQualityUpdate(i)}};var Jt=class{constructor(e,t,i,r){this.store=e;this.peerManager=t;this.trackManager=i;this.listener=r;this.TAG="[PeerListManager]";this.handleInitialPeerList=e=>{let t=Object.values(e.peers);this.peerManager.handlePeerList(t)};this.handleReconnectPeerList=e=>{this.handleRepeatedPeerList(e.peers)};this.handlePreviewRoomState=e=>{if(!this.store.hasRoleDetailsArrived())return;let t=e.peers;if(t==null){e.peer_count===0&&this.handleRepeatedPeerList({});return}Object.keys(t).forEach(i=>{t[i].tracks={},t[i].is_from_room_state=!0}),this.handleRepeatedPeerList(t)};this.handleRepeatedPeerList=e=>{let t=this.store.getRemotePeers(),i=Object.values(e),r=t.filter(s=>!e[s.peerId]);r.length>0&&o.d(this.TAG,`${r}`),r.forEach(s=>{var d;let n={peer_id:s.peerId,role:((d=s.role)==null?void 0:d.name)||"",info:{name:s.name,data:s.metadata||"",user_id:s.customerUserId||""},tracks:{}};this.peerManager.handlePeerLeave(n)}),i.forEach(s=>{let n=this.store.getPeerById(s.peer_id),d=Object.values(s.tracks);n?(this.store.getPeerTracks(n.peerId).forEach(h=>{var u;s.tracks[h.trackId]||(this.removePeerTrack(n,h.trackId),(u=this.listener)==null||u.onTrackUpdate(D.TRACK_REMOVED,h,n))}),d.forEach(h=>{this.store.getTrackById(h.track_id)||this.store.setTrackState({peerId:n.peerId,trackInfo:h})}),this.trackManager.handleTrackUpdate({peer:{info:s.info,peer_id:s.peer_id},tracks:s.tracks}),this.peerManager.handlePeerUpdate(s)):this.peerManager.handlePeerJoin(s)})}}handleNotification(e,t,i){if(e===A.PEER_LIST){let r=t;i?(o.d(this.TAG,"RECONNECT_PEER_LIST event",JSON.stringify(r,null,2)),this.handleReconnectPeerList(r)):(o.d(this.TAG,"PEER_LIST event",JSON.stringify(r,null,2)),this.handleInitialPeerList(r))}else if(e===A.ROOM_STATE){let r=t;this.handlePreviewRoomState(r)}}removePeerTrack(e,t){var i,r;if(o.d(this.TAG,`removing track - ${t} from ${e}`),((i=e.audioTrack)==null?void 0:i.trackId)===t)e.audioTrack=void 0;else if(((r=e.videoTrack)==null?void 0:r.trackId)===t)e.videoTrack=void 0;else{let s=e.auxiliaryTracks.findIndex(n=>n.trackId===t);s>=0&&e.auxiliaryTracks.splice(s,1)}}};var Z=a=>a?new Date(a):void 0;var Qt=class{constructor(e,t,i){this.store=e;this.trackManager=t;this.listener=i;this.TAG="[PeerManager]";this.handlePeerList=e=>{var r,s;if(e.length===0){(r=this.listener)==null||r.onPeerUpdate(K.PEER_LIST,[]);return}let t=[],i=new Set(e.map(n=>n.peer_id));this.store.getRemotePeers().forEach(({peerId:n,fromRoomState:d})=>{!i.has(n)&&d&&this.store.removePeer(n)});for(let n of e)t.push(this.makePeer(n));(s=this.listener)==null||s.onPeerUpdate(K.PEER_LIST,t),this.trackManager.processPendingTracks()};this.handlePeerJoin=e=>{var i;let t=this.makePeer(e);(i=this.listener)==null||i.onPeerUpdate(K.PEER_JOINED,t),this.trackManager.processPendingTracks()};this.handlePeerLeave=e=>{var i,r,s,n;let t=this.store.getPeerById(e.peer_id);this.store.removePeer(e.peer_id),o.d(this.TAG,"PEER_LEAVE",e.peer_id,`remainingPeers=${this.store.getPeers().length}`),!!t&&(t.audioTrack&&((i=this.listener)==null||i.onTrackUpdate(D.TRACK_REMOVED,t.audioTrack,t)),t.videoTrack&&((r=this.listener)==null||r.onTrackUpdate(D.TRACK_REMOVED,t.videoTrack,t)),(s=t.auxiliaryTracks)==null||s.forEach(d=>{var l;(l=this.listener)==null||l.onTrackUpdate(D.TRACK_REMOVED,d,t)}),(n=this.listener)==null||n.onPeerUpdate(K.PEER_LEFT,t))}}handleNotification(e,t){switch(e){case A.PEER_JOIN:{let i=t;this.handlePeerJoin(i);break}case A.PEER_LEAVE:{let i=t;this.handlePeerLeave(i);break}case A.PEER_UPDATE:this.handlePeerUpdate(t);break;default:break}}handlePeerUpdate(e){var i;let t=this.store.getPeerById(e.peer_id);if(!!t){if(t.role&&t.role.name!==e.role){let r=this.store.getPolicyForRole(e.role);t.updateRole(r),(i=this.listener)==null||i.onPeerUpdate(K.ROLE_UPDATED,t)}this.handlePeerInfoUpdate(v({peer:t},e.info))}}handlePeerInfoUpdate({peer:e,name:t,data:i}){var r,s;!e||(t&&e.name!==t&&(e.updateName(t),(r=this.listener)==null||r.onPeerUpdate(K.NAME_UPDATED,e)),i&&e.metadata!==i&&(e.updateMetadata(i),(s=this.listener)==null||s.onPeerUpdate(K.METADATA_UPDATED,e)))}makePeer(e){let t=this.store.getPeerById(e.peer_id);t||(t=new Xe({peerId:e.peer_id,name:e.info.name,customerUserId:e.info.user_id,metadata:e.info.data,role:this.store.getPolicyForRole(e.role),joinedAt:Z(e.joined_at),fromRoomState:!!e.is_from_room_state}),this.store.addPeer(t),o.d(this.TAG,"adding to the peerList",`${t}`));for(let i in e.tracks)this.store.setTrackState({peerId:e.peer_id,trackInfo:e.tracks[i]});return t}};var Yt=class{constructor(e,t){this.store=e;this.eventBus=t}handlePolicyChange(e){let t=this.store.getLocalPeer();if(t&&!t.role){let i=e.known_roles[e.name];t.updateRole(i)}if(this.store.setKnownRoles(e),this.store.getRoom().templateId=e.template_id,(t==null?void 0:t.role)&&t.role.name!==e.name){let i=this.store.getPolicyForRole(e.name),r=t.role;t.updateRole(i),this.eventBus.localRoleUpdate.publish({oldRole:r,newRole:i})}this.eventBus.policyChange.publish(e)}};var zt=class{constructor(e,t){this.store=e;this.listener=t}handleNotification(e,t){switch(e){case A.ROLE_CHANGE_REQUEST:this.handleRoleChangeRequest(t);break;case A.TRACK_UPDATE_REQUEST:this.handleTrackUpdateRequest(t);break;case A.CHANGE_TRACK_MUTE_STATE_UPDATE:this.handleChangeTrackStateRequest(t);break;default:return}}handleRoleChangeRequest(e){var i;let t={requestedBy:e.requested_by?this.store.getPeerById(e.requested_by):void 0,role:this.store.getPolicyForRole(e.role),token:e.token};(i=this.listener)==null||i.onRoleChangeRequest(t)}handleTrackUpdateRequest(e){let{requested_by:t,track_id:i,mute:r}=e,s=t?this.store.getPeerById(t):void 0,n=this.store.getLocalPeerTracks().find(l=>l.publishedTrackId===i);if(!n)return;let d=()=>{var l;(l=this.listener)==null||l.onChangeTrackStateRequest({requestedBy:s,track:n,enabled:!r})};if(r){if(n.enabled===!r)return;n.setEnabled(!r).then(d)}else d()}handleChangeTrackStateRequest(e){var h;let{type:t,source:i,value:r,requested_by:s}=e,n=s?this.store.getPeerById(s):void 0,d=!r,l=this.getTracksToBeUpdated({type:t,source:i,enabled:d});if(l.length!==0)if(d)(h=this.listener)==null||h.onChangeMultiTrackStateRequest({requestedBy:n,tracks:l,type:t,source:i,enabled:!0});else{let u=[];for(let S of l)u.push(S.setEnabled(!1));Promise.all(u).then(()=>{var S;(S=this.listener)==null||S.onChangeMultiTrackStateRequest({requestedBy:n,tracks:l,enabled:!1})})}}getTracksToBeUpdated({type:e,source:t,enabled:i}){let s=this.store.getLocalPeerTracks();return e&&(s=s.filter(n=>n.type===e)),t&&(s=s.filter(n=>n.source===t)),s.filter(n=>n.enabled!==i)}};var Zt=class{constructor(e,t){this.store=e;this.listener=t;this.TAG="[RoomUpdateManager]"}handleNotification(e,t){switch(e){case A.PEER_LIST:this.onRoomState(t.room);break;case A.RTMP_START:this.onRTMPStart(t);break;case A.RTMP_STOP:this.onRTMPStop(t);break;case A.RECORDING_START:this.onRecordingStart(t);break;case A.RECORDING_STOP:this.onRecordingStop(t);break;case A.ROOM_STATE:this.handlePreviewRoomState(t);break;default:this.onHLS(e,t);break}}handlePreviewRoomState(e){let{room:t}=e;this.onRoomState(t,e.peer_count)}onRoomState(e,t){var h,u,S;let{recording:i,streaming:r,session_id:s,started_at:n,name:d}=e,l=this.store.getRoom();l.peerCount=t,l.name=d,l.recording.server.running=!!(i==null?void 0:i.sfu.enabled),l.recording.browser.running=!!(i==null?void 0:i.browser.enabled),l.rtmp.running=!!((h=r==null?void 0:r.rtmp)==null?void 0:h.enabled),l.rtmp.startedAt=Z((u=r==null?void 0:r.rtmp)==null?void 0:u.started_at),l.recording.server.startedAt=Z(i==null?void 0:i.sfu.started_at),l.recording.browser.startedAt=Z(i==null?void 0:i.browser.started_at),l.recording.hls=this.getPeerListHLSRecording(i),l.hls=this.convertHls(r==null?void 0:r.hls),l.sessionId=s,l.startedAt=Z(n),(S=this.listener)==null||S.onRoomUpdate(ae.RECORDING_STATE_UPDATED,l)}onRTMPStart(e){var t;this.setRTMPStatus(!((t=e.error)==null?void 0:t.code),e)}onRTMPStop(e){this.setRTMPStatus(!1,e)}onRecordingStart(e){var t;this.setRecordingStatus(!((t=e.error)==null?void 0:t.code),e)}onRecordingStop(e){this.setRecordingStatus(!1,e)}onHLS(e,t){var r,s;if(![A.HLS_START,A.HLS_STOP].includes(e))return;let i=this.store.getRoom();t.enabled=e===A.HLS_START&&!((r=t.error)==null?void 0:r.code),i.hls=this.convertHls(t),i.recording.hls=this.getHLSRecording(t),(s=this.listener)==null||s.onRoomUpdate(ae.HLS_STREAMING_STATE_UPDATED,i)}convertHls(e){var i;let t={running:!!(e==null?void 0:e.enabled),variants:[],error:this.toSdkError(e==null?void 0:e.error)};return(i=e==null?void 0:e.variants)==null||i.forEach(r=>{t.variants.push({meetingURL:r.meeting_url,url:r.url,metadata:r.metadata,startedAt:Z(r.started_at)})}),t}getHLSRecording(e){var i,r,s;let t={running:!1};return(e==null?void 0:e.hls_recording)&&(t={running:!!(e==null?void 0:e.enabled),singleFilePerLayer:!!((i=e.hls_recording)==null?void 0:i.single_file_per_layer),hlsVod:!!((r=e.hls_recording)==null?void 0:r.hls_vod),startedAt:Z((s=e==null?void 0:e.variants)==null?void 0:s[0].started_at),error:this.toSdkError(e.error)}),t}getPeerListHLSRecording(e){var i,r;let t=e==null?void 0:e.hls;return{running:!!(t==null?void 0:t.enabled),startedAt:Z(t==null?void 0:t.started_at),singleFilePerLayer:!!((i=t==null?void 0:t.config)==null?void 0:i.single_file_per_layer),hlsVod:!!((r=t==null?void 0:t.config)==null?void 0:r.hls_vod)}}setRecordingStatus(e,t){var s;let i=this.store.getRoom(),r;t.type==="sfu"?(i.recording.server={running:e,startedAt:e?Z(t.started_at):void 0,error:this.toSdkError(t.error)},r=ae.SERVER_RECORDING_STATE_UPDATED):(i.recording.browser={running:e,startedAt:e?Z(t.started_at):void 0,error:this.toSdkError(t.error)},r=ae.BROWSER_RECORDING_STATE_UPDATED),(s=this.listener)==null||s.onRoomUpdate(r,i)}setRTMPStatus(e,t){var r;let i=this.store.getRoom();i.rtmp={running:e,startedAt:e?Z(t.started_at):void 0,error:this.toSdkError(t.error)},(r=this.listener)==null||r.onRoomUpdate(ae.RTMP_STREAMING_STATE_UPDATED,i)}toSdkError(e){if(!(e==null?void 0:e.code))return;let t=e.message||"error in streaming/recording",i=new T(e.code,"ServerErrors",p.NONE,t,t);return o.e(this.TAG,"error in streaming/recording",i),i}};var Xt=class{constructor(e,t,i){this.store=e;this.eventBus=t;this.listener=i;this.TAG="[TrackManager]";this.tracksToProcess=new Map;this.handleTrackAdd=e=>{o.d(this.TAG,"ONTRACKADD",`${e}`),this.store.addTrack(e),this.tracksToProcess.set(e.trackId,e),this.processPendingTracks()};this.handleTrackRemove=e=>{var r;o.d(this.TAG,"ONTRACKREMOVE",`${e}`);let t=this.store.getTrackState(e.trackId);if(!t)return;e.type===F.AUDIO&&this.eventBus.audioTrackRemoved.publish(e),this.store.removeTrack(e.trackId);let i=this.store.getPeerById(t.peerId);!i||(this.removePeerTracks(i,e),(r=this.listener)==null||r.onTrackUpdate(D.TRACK_REMOVED,e,i))};this.handleTrackLayerUpdate=e=>{for(let t in e.tracks){let i=e.tracks[t],r=this.store.getTrackById(t);!r||!this.store.getPeerByTrackId(t)||r instanceof Se&&this.setLayer(r,i)}};this.handleTrackUpdate=e=>{var i,r;let t=this.store.getPeerById(e.peer.peer_id);if(!t){o.d(this.TAG,"Track Update ignored - Peer not added to store");return}for(let s in e.tracks){let n=Object.assign({},(i=this.store.getTrackState(s))==null?void 0:i.trackInfo),d=e.tracks[s],l=this.store.getTrackById(s);if(this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:v(v({},n),d)}),!l||this.tracksToProcess.has(s))this.processPendingTracks();else{l.setEnabled(!d.mute);let h=this.processTrackUpdate(l,n,d);h&&((r=this.listener)==null||r.onTrackUpdate(h,l,t))}}}}handleTrackMetadataAdd(e){o.d(this.TAG,"TRACK_METADATA_ADD",JSON.stringify(e,null,2));for(let t in e.tracks)this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:e.tracks[t]});this.processPendingTracks()}processPendingTracks(){new Map(this.tracksToProcess).forEach(t=>{var s;let i=this.store.getTrackState(t.trackId);if(!i){o.d(this.TAG,"TrackState not added to store",`peerId - ${t.peerId}`,`trackId -${t.trackId}`);return}let r=this.store.getPeerById(i.peerId);if(!r){o.d(this.TAG,"Peer not added to store, peerId",i.peerId);return}t.source=i.trackInfo.source,t.peerId=r.peerId,t.logIdentifier=r.name,t.setEnabled(!i.trackInfo.mute),this.addAudioTrack(r,t),this.addVideoTrack(r,t),t.type===F.AUDIO?this.eventBus.audioTrackAdded.publish({track:t,peer:r}):(s=this.listener)==null||s.onTrackUpdate(D.TRACK_ADDED,t,r),this.tracksToProcess.delete(t.trackId)})}setLayer(e,t){var s,n;let i=this.store.getPeerByTrackId(e.trackId);if(!i)return;e.setLayerFromServer(t)?(s=this.listener)==null||s.onTrackUpdate(D.TRACK_DEGRADED,e,i):(n=this.listener)==null||n.onTrackUpdate(D.TRACK_RESTORED,e,i)}removePeerTracks(e,t){var r,s;let i=e.auxiliaryTracks.indexOf(t);i>-1?e.auxiliaryTracks.splice(i,1):t.type===F.AUDIO&&((r=e.audioTrack)==null?void 0:r.trackId)===t.trackId?e.audioTrack=void 0:t.type===F.VIDEO&&((s=e.videoTrack)==null?void 0:s.trackId)===t.trackId&&(e.videoTrack=void 0)}addAudioTrack(e,t){t.type===F.AUDIO&&(!e.audioTrack&&t.source==="regular"?e.audioTrack=t:e.auxiliaryTracks.push(t))}addVideoTrack(e,t){if(t.type!==F.VIDEO)return;let i=t,r=this.store.getSimulcastDefinitionsForPeer(e,i.source);i.setSimulcastDefinitons(r),!e.videoTrack&&t.source==="regular"?e.videoTrack=i:e.auxiliaryTracks.push(i)}processTrackUpdate(e,t,i){let r;return t.mute!==i.mute?(r=i.mute?D.TRACK_MUTED:D.TRACK_UNMUTED,e.type===F.AUDIO&&this.eventBus.audioTrackUpdate.publish({track:e,enabled:!i.mute})):t.description!==i.description&&(r=D.TRACK_DESCRIPTION_CHANGED),r}};var vt=class{constructor(e,t,i,r,s){this.store=e;this.listener=i;this.audioListener=r;this.connectionQualityListener=s;this.TAG="[HMSNotificationManager]";this.hasConsistentRoomStateArrived=!1;this.ignoreNotification=e=>{if(e===A.PEER_LIST)this.hasConsistentRoomStateArrived=!0;else if(e===A.ROOM_STATE)return this.hasConsistentRoomStateArrived;return!1};this.handleTrackAdd=e=>{this.trackManager.handleTrackAdd(e)};this.handleTrackRemove=e=>{this.trackManager.handleTrackRemove(e)};this.updateLocalPeer=({name:e,metadata:t})=>{let i=this.store.getLocalPeer();this.peerManager.handlePeerInfoUpdate({peer:i,name:e,data:t})};this.trackManager=new Xt(this.store,t,this.listener),this.peerManager=new Qt(this.store,this.trackManager,this.listener),this.peerListManager=new Jt(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new qt(this.store,this.listener),this.policyChangeManager=new Yt(this.store,t),this.requestManager=new zt(this.store,this.listener),this.activeSpeakerManager=new Kt(this.store,this.listener,this.audioListener),this.connectionQualityManager=new jt(this.connectionQualityListener),this.roomUpdateManager=new Zt(this.store,this.listener)}setListener(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e}setAudioListener(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e}setConnectionQualityListener(e){this.connectionQualityListener=e,this.connectionQualityManager.listener=e}handleNotification(e,t=!1){var s,n;let i=e.method,r=e.params;[A.ACTIVE_SPEAKERS,A.SFU_STATS,A.CONNECTION_QUALITY,void 0].includes(i)||o.d(this.TAG,`Received notification - ${i}`,{notification:r}),i===A.SFU_STATS&&((s=window.HMS)==null?void 0:s.ON_SFU_STATS)&&typeof((n=window.HMS)==null?void 0:n.ON_SFU_STATS)=="function"&&window.HMS.ON_SFU_STATS(e.params),!this.ignoreNotification(i)&&(this.roomUpdateManager.handleNotification(i,r),this.peerManager.handleNotification(i,r),this.requestManager.handleNotification(i,r),this.peerListManager.handleNotification(i,r,t),this.broadcastManager.handleNotification(i,r),this.handleIsolatedMethods(i,r))}handleIsolatedMethods(e,t){switch(e){case A.TRACK_METADATA_ADD:{this.trackManager.handleTrackMetadataAdd(t);break}case A.TRACK_UPDATE:{this.trackManager.handleTrackUpdate(t);break}case A.ON_SFU_TRACK_LAYER_UPDATE:{this.trackManager.handleTrackLayerUpdate(t);break}case A.ACTIVE_SPEAKERS:this.activeSpeakerManager.handleActiveSpeakers(t);break;case A.CONNECTION_QUALITY:this.connectionQualityManager.handleQualityUpdate(t);break;case A.POLICY_CHANGE:this.policyChangeManager.handlePolicyChange(t);break;default:break}}};var Tt=class{constructor(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof pe?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)}};var Ke=class{constructor(e){this.TAG="[AudioContextManager]";this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}resumeContext(){this.audioContext.state==="suspended"&&(o.d(this.TAG,"AudioContext is resumed"),this.audioContext.resume())}getAudioTrack(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]}cleanup(){this.audioContext.state!=="closed"&&this.audioContext.close()}};var Xi=J(require("eventemitter2")),ye=class extends Xi.EventEmitter2{on(e,t){return super.on(e,t)}off(e,t){return super.off(e,t)}emit(e,t){return super.emit(e,t)}listeners(e){return super.listeners(e)}};var ei=class extends ye{constructor(){super(...arguments);this.audioElement=null;this.TAG="[PlaylistAudioManager]";this.seeked=!1}play(e){return c(this,null,function*(){return this.audioElement=this.getAudioElement(),new Promise((t,i)=>{this.audioElement=this.getAudioElement(),this.audioElement.src=e,this.seeked=!1,this.audioElement.onerror=()=>{let r=`Error loading ${e}`;o.e(this.TAG,r),this.stop(),i(r)},this.audioElement.oncanplaythrough=()=>c(this,null,function*(){try{if(!this.audioElement)return;if(this.audioContextManager.resumeContext(),this.track)this.seeked?this.seeked=!1:(yield this.audioElement.play(),t([this.track]));else{yield this.audioElement.play();let r=this.audioContextManager.getAudioTrack();this.track=r,t([r])}}catch(r){o.e(this.TAG,"Error playing audio",e,r.message),i(r)}}),this.audioElement.onseeked=()=>{this.seeked=!0}})})}getTracks(){return this.track?[this.track.id]:[]}getElement(){return this.audioElement}stop(){var e,t,i;(e=this.audioElement)==null||e.pause(),(t=this.audioElement)==null||t.removeAttribute("src"),this.audioElement=null,(i=this.audioContextManager)==null||i.cleanup(),this.track=void 0}getAudioElement(){if(this.audioElement)return this.audioElement;let e=document.createElement("audio");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",t=>this.emit("progress",t)),e.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new Ke(e),e}};var ti=class extends ye{constructor(){super(...arguments);this.TAG="[PlaylistVideoManager]";this.videoElement=null;this.canvasContext=null;this.tracks=[];this.DEFAUL_FPS=24;this.seeked=!1;this.drawImage=()=>{var e,t,i;this.videoElement&&!this.videoElement.paused&&!this.videoElement.ended&&((i=this.canvasContext)==null||i.drawImage(this.videoElement,0,0,(e=this.canvas)==null?void 0:e.width,(t=this.canvas)==null?void 0:t.height),this.timer=setTimeout(()=>{this.drawImage()},1e3/this.DEFAUL_FPS))}}play(e){return this.videoElement=this.getVideoElement(),this.createCanvas(),new Promise((t,i)=>{this.videoElement=this.getVideoElement(),this.videoElement.src=e,this.seeked=!1,this.videoElement.onerror=()=>{let r=`Error loading ${e}`;o.e(this.TAG,r),this.stop(),i(r)},this.videoElement.oncanplaythrough=()=>c(this,null,function*(){var r,s,n;try{if(!this.videoElement)return;if(this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,this.tracks.length===0){this.clearCanvasAndTracks();let d=this.canvas.captureStream();if(!d){o.e(this.TAG,"Browser does not support captureStream");return}this.videoElement.onplay=this.drawImage,this.audioContextManager.resumeContext(),yield this.videoElement.play();let l=this.audioContextManager.getAudioTrack();d.addTrack(l),d.getTracks().forEach(h=>{this.tracks.push(h)}),t(this.tracks)}else this.seeked?(this.seeked=!1,(n=this.canvasContext)==null||n.drawImage(this.videoElement,0,0,(r=this.canvas)==null?void 0:r.width,(s=this.canvas)==null?void 0:s.height)):(yield this.videoElement.play(),t(this.tracks))}catch(d){o.e(this.TAG,"Error playing video",e,d.message),i(d)}}),this.videoElement.onseeked=()=>{this.seeked=!0}})}getTracks(){return this.tracks.map(e=>e.id)}getElement(){return this.videoElement}stop(){var e,t,i;(e=this.videoElement)==null||e.pause(),(t=this.videoElement)==null||t.removeAttribute("src"),this.videoElement=null,(i=this.audioContextManager)==null||i.cleanup(),this.clearCanvasAndTracks()}clearCanvasAndTracks(){var e;this.tracks=[],(e=this.canvasContext)==null||e.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)}getVideoElement(){if(this.videoElement)return this.videoElement;let e=document.createElement("video");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",t=>this.emit("progress",t)),e.addEventListener("ended",()=>{this.emit("ended",null)}),this.audioContextManager=new Ke(e),e}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"))}};var ft={audio:{list:[],currentIndex:-1,isAutoplayOn:!0},video:{list:[],currentIndex:-1,isAutoplayOn:!0}},Et=class extends ye{constructor(e,t){super();this.sdk=e;this.eventBus=t;this.state={audio:v({},ft.audio),video:v({},ft.video)};this.TAG="[PlaylistManager]";this.handlePausePlaylist=i=>c(this,[i],function*({enabled:e,track:t}){var s;if(e)return;let r;t.source==="audioplaylist"&&(r=b.audio),t.source==="videoplaylist"&&(r=b.video),!!r&&((s=this.getElement(r))==null||s.pause())});this.addTrack=(e,t)=>c(this,null,function*(){yield this.sdk.addTrack(e,t),o.d(this.TAG,"Playlist track added",rt(e))});this.removeTrack=e=>c(this,null,function*(){yield this.sdk.removeTrack(e,!0),o.d(this.TAG,"Playlist track removed",e)});this.audioManager=new ei,this.videoManager=new ti,this.addListeners()}getList(e=b.audio){return this.state[e].list}setList(e){if(!e||e.length===0){o.w(this.TAG,"Please pass in a list of HMSPlaylistItem's");return}e.forEach(t=>{this.state[t.type].list.includes(t)||this.state[t.type].list.push(t)})}clearList(e){return c(this,null,function*(){this.isPlaying(e)&&(yield this.stop(e)),this.state[e].list=[]})}removeItem(e,t){return c(this,null,function*(){let{list:i,currentIndex:r}=this.state[t],s=i.findIndex(n=>e===n.id);return s>-1?(r===s&&this.isPlaying(t)&&(yield this.stop(t)),i.splice(s,1),!0):!1})}seek(e,t=b.audio){let{currentIndex:i}=this.state[t];if(i===-1)throw m.PlaylistErrors.NoEntryToPlay(p.PLAYLIST,"No item is currently playing");let r=this.getElement(t);if(r){let s=Math.max(r.currentTime+e,0);r.currentTime=Math.min(s,r.duration)}}seekTo(e,t=b.audio){let{currentIndex:i}=this.state[t];if(i===-1)throw m.PlaylistErrors.NoEntryToPlay(p.PLAYLIST,"No item is currently playing");if(e<0)throw Error("value cannot be negative");let r=this.getElement(t);r&&(r.currentTime=Math.min(e,r.duration))}setVolume(e,t=b.audio){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");let i=this.getElement(t);i&&(i.volume=e*.01)}getVolume(e=b.audio){let t=this.getElement(e);return t?t.volume*100:0}getCurrentTime(e=b.audio){let t=this.getElement(e);return(t==null?void 0:t.currentTime)||0}getCurrentIndex(e=b.audio){return this.state[e].currentIndex}getCurrentProgress(e=b.audio){var n;let{list:t,currentIndex:i}=this.state[e],r=(n=t[i])==null?void 0:n.url,s=this.getElement(e);return!r||!s?0:Math.floor(100*(s.currentTime/s.duration))}getCurrentSelection(e=b.audio){let{list:t,currentIndex:i}=this.state[e];if(i!==-1)return t[i]}isPlaying(e=b.audio){let t=this.getElement(e);return!!t&&!t.paused}setIsAutoplayOn(e=b.audio,t){this.state[e].isAutoplayOn=t}getPlaybackRate(e=b.audio){let t=this.getElement(e);return t?t.playbackRate:1}setPlaybackRate(e=b.audio,t){if(t<.25||t>2)throw Error("Please pass a value between 0.25 and 2.0");let i=this.getElement(e);i&&(i.playbackRate=t)}setEnabled(r,s){return c(this,arguments,function*(e,{id:t,type:i=b.audio}){let d=this.state[i].list.findIndex(h=>h.id===t);if(!t||d===-1){o.w(this.TAG,"Pass a valid id");return}let l=this.state[i].list[d].url;e?yield this.play(l,i):yield this.pause(l,i),this.state[i].currentIndex=d,this.setDuration(i)})}playNext(){return c(this,arguments,function*(e=b.audio){let{list:t,currentIndex:i}=this.state[e];if(i>=t.length-1)throw m.PlaylistErrors.NoEntryToPlay(p.PLAYLIST,"Reached end of playlist");yield this.play(t[i+1].url,e),this.state[e].currentIndex=i+1,this.setDuration(e)})}playPrevious(){return c(this,arguments,function*(e=b.audio){let{list:t,currentIndex:i}=this.state[e];if(i<=0)throw m.PlaylistErrors.NoEntryToPlay(p.PLAYLIST,"Reached start of playlist");yield this.play(t[i-1].url,e),this.state[e].currentIndex=i-1,this.setDuration(e)})}stop(){return c(this,arguments,function*(e=b.audio){var i;let t=e===b.audio?this.audioManager:this.videoManager;(i=t.getElement())==null||i.pause(),yield this.removeTracks(e),t.stop(),this.state[e].currentIndex=-1})}cleanup(){this.state={audio:v({},ft.audio),video:v({},ft.video)},this.eventBus.localAudioEnabled.unsubscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.unsubscribe(this.handlePausePlaylist),this.audioManager.stop(),this.videoManager.stop()}onProgress(e){this.videoManager.on("progress",()=>{try{e({type:b.video,progress:this.getCurrentProgress(b.video)})}catch(t){o.e(this.TAG,"Error in onProgress callback")}}),this.audioManager.on("progress",()=>{try{e({type:b.audio,progress:this.getCurrentProgress(b.audio)})}catch(t){o.e(this.TAG,"Error in onProgress callback")}})}onNewTrackStart(e){this.on("newTrackStart",e)}onPlaylistEnded(e){this.on("playlistEnded",e)}onCurrentTrackEnded(e){this.on("currentTrackEnded",e)}getElement(e=b.audio){return e===b.audio?this.audioManager.getElement():this.videoManager.getElement()}removeTracks(){return c(this,arguments,function*(e=b.audio){let i=(e===b.audio?this.audioManager:this.videoManager).getTracks();for(let r of i)yield this.removeTrack(r)})}play(i){return c(this,arguments,function*(e,t=b.audio){let r=t===b.audio?this.audioManager:this.videoManager,s=r.getElement();if(this.isItemCurrentlyPlaying(e,t)){o.w(this.TAG,`The ${t} is currently playing`);return}if(s==null?void 0:s.src.includes(e))yield s.play();else{s==null||s.pause();let n=yield r.play(e);for(let d of n)yield this.addTrack(d,t===b.audio?"audioplaylist":"videoplaylist")}})}isItemCurrentlyPlaying(e,t){let i=this.getElement(t);return!!(i&&!i.paused&&i.src.includes(e))}setDuration(e=b.audio){let t=this.getElement(e),{list:i,currentIndex:r}=this.state[e];i[r]&&(i[r].duration=(t==null?void 0:t.duration)||0),this.emit("newTrackStart",i[r])}pause(i){return c(this,arguments,function*(e,t=b.audio){let r=this.getElement(t);r&&!r.paused&&r.src.includes(e)?(r.pause(),o.d(this.TAG,"paused url",e)):o.w(this.TAG,"The passed in url is not currently playing")})}addListeners(){this.audioManager.on("ended",()=>this.handleEnded(b.audio)),this.videoManager.on("ended",()=>this.handleEnded(b.video)),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.subscribe(this.handlePausePlaylist)}handleEnded(){return c(this,arguments,function*(e=b.audio){let{list:t,currentIndex:i,isAutoplayOn:r}=this.state[e];i===t.length-1?(yield this.stop(e),this.emit("playlistEnded",e)):r?this.playNext(e):yield this.pause(t[i].url,e),this.emit("currentTrackEnded",t[i])})}};var ii=class{constructor(e,t,i="",r="",s="https://prod-init.100ms.live/init",n=!1){this.authToken=e;this.peerId=t;this.peerName=i;this.data=r;this.endpoint=s;this.autoSubscribeVideo=n}};var C;(function(s){s[s.ConnectFailed=0]="ConnectFailed",s[s.SignalDisconnect=1]="SignalDisconnect",s[s.JoinWSMessageFailed=2]="JoinWSMessageFailed",s[s.PublishIceConnectionFailed=3]="PublishIceConnectionFailed",s[s.SubscribeIceConnectionFailed=4]="SubscribeIceConnectionFailed"})(C||(C={}));var er={[0]:[],[1]:[],[2]:[1],[3]:[1],[4]:[1]};var R;(function(d){d.Disconnected="Disconnected",d.Connecting="Connecting",d.Joined="Joined",d.Preview="Preview",d.Failed="Failed",d.Reconnecting="Reconnecting",d.Leaving="Leaving"})(R||(R={}));var ri=class{constructor(e){this.promise=new Promise((t,i)=>{this.resolve=t,this.reject=i,e(t,i)})}};var si=class{constructor(e,t){this.onStateChange=e;this.sendEvent=t;this.TAG="[RetryScheduler]";this.inProgress=new Map;this.retryTaskIds=[]}schedule(d){return c(this,arguments,function*({category:e,error:t,task:i,originalState:r,maxFailedRetries:s=$e,changeState:n=!0}){yield this.scheduleTask({category:e,error:t,changeState:n,task:i,originalState:r,maxFailedRetries:s})})}reset(){this.retryTaskIds.forEach(e=>clearTimeout(e)),this.retryTaskIds=[],this.inProgress.clear()}isTaskInProgress(e){return!!this.inProgress.get(e)}scheduleTask(l){return c(this,arguments,function*({category:e,error:t,changeState:i,task:r,originalState:s,maxFailedRetries:n=$e,failedRetryCount:d=0}){if(o.d(this.TAG,"schedule: ",{category:C[e],error:t}),d===0){let E=this.inProgress.get(e);if(E){o.d(this.TAG,`schedule: Already a task for ${C[e]} scheduled, waiting for its completion`),yield E.promise;return}let N=new ri((O,I)=>{});this.inProgress.set(e,N),this.sendEvent(t,e)}let h=!1,u=er[e];for(let E in u){let N=u[parseInt(E)];try{let O=this.inProgress.get(N);O&&(o.d(this.TAG,`schedule: Suspending retry task of ${C[e]}, waiting for ${C[N]} to recover`),yield O.promise,o.d(this.TAG,`schedule: Resuming retry task ${C[e]} as it's dependency ${C[N]} is recovered`))}catch(O){o.d(this.TAG,`schedule: Stopping retry task of ${C[e]} as it's dependency ${C[N]} failed to recover`),h=!0;break}}if(d>=n||h){if(t.description+=`. [${C[e]}] Could not recover after ${d} tries`,h&&(t.description+=` Could not recover all of it's required dependencies - [${u.map(E=>C[E]).toString()}]`),t.isTerminal=!0,this.inProgress.delete(e),this.sendEvent(t,e),this.reset(),i)this.onStateChange(R.Failed,t);else throw t;return}i&&this.onStateChange(R.Reconnecting,t);let S=this.getDelayForRetryCount(e,d);o.i(this.TAG,`schedule: [${C[e]}] [failedRetryCount=${d}] Scheduling retry task in ${S}ms`);let g;try{g=yield this.setTimeoutPromise(r,S)}catch(E){g=!1,o.w(this.TAG,`[${C[e]}] Un-caught exception ${E.name} in retry-task, initiating retry`,E)}if(g){let E=this.inProgress.get(e);this.inProgress.delete(e),E==null||E.resolve(d),i&&this.inProgress.size===0&&this.onStateChange(s),o.i(this.TAG,`schedule: [${C[e]}] [failedRetryCount=${d}] Recovered \u267B\uFE0F`)}else yield this.scheduleTask({category:e,error:t,changeState:i,task:r,originalState:s,maxFailedRetries:n,failedRetryCount:d+1})})}getBaseDelayForTask(e,t){return e===C.JoinWSMessageFailed?2:Math.pow(2,t)}getDelayForRetryCount(e,t){let i=this.getBaseDelayForTask(e,t),r=e===C.JoinWSMessageFailed?Math.random()*2:Math.random();return Math.round(Math.min(i+r,Oi)*1e3)}setTimeoutPromise(e,t){return c(this,null,function*(){return new Promise((i,r)=>{let s=window.setTimeout(()=>c(this,null,function*(){try{let n=yield e();n&&this.retryTaskIds.splice(this.retryTaskIds.indexOf(s),1),i(n)}catch(n){r(n)}}),t);this.retryTaskIds.push(s)})})}};var ai=class extends Te{constructor(){super(ut);this.localStorage=new re("hms-analytics");this.localStorage.clear(),this.initLocalStorageQueue()}enqueue(e){super.enqueue(e),this.localStorage.set(this.storage)}dequeue(){let e=super.dequeue();return this.localStorage.set(this.storage),e}initLocalStorageQueue(){var e;(e=this.localStorage.get())==null||e.forEach(t=>{let i=new x(t);super.enqueue(i)})}};var ni=class{constructor(){this.TAG="[AnalyticsTransport]"}sendEvent(e){try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(t){o.w(this.TAG,"sendEvent failed",t)}}flushFailedEvents(e){var t;try{for(o.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){let i=this.failedEvents.dequeue();i&&(((t=i.metadata)==null?void 0:t.peer.peer_id)===e||!i.metadata.peer.peer_id?this.sendSingleEvent(i):oe.sendEvent(i))}}catch(i){o.w(this.TAG,"flushFailedEvents failed",i)}}sendSingleEvent(e){try{this.transportProvider.sendEvent(e),o.d(this.TAG,"Sent event",e.name,e)}catch(t){throw o.w(this.TAG,`${this.transportProvider.TAG}.sendEvent failed, adding to local storage events`,{event:e,error:t}),this.failedEvents.enqueue(e),t}}};var oi=class extends ni{constructor(e){super();this.transportProvider=e;this.failedEvents=new ai}};var G;(function(t){t[t.Publish=0]="Publish",t[t.Subscribe=1]="Subscribe"})(G||(G={}));var qe=J(require("sdp-transform"));var tr="[VALIDATIONS]";function ce(a){return a!=null}var ci=()=>{if(!ce(RTCPeerConnection)){let a=m.GenericErrors.MissingRTCPeerConnection();throw o.e(tr,a),a}},di=()=>{if(!ce(navigator.mediaDevices)){let a=m.GenericErrors.MissingMediaDevices();throw o.e(tr,a),a}};function ir(a,e){var r;let t=qe.parse(a.sdp);if(!((r=t.origin)==null?void 0:r.username.startsWith("mozilla")))return a;let i=e?Array.from(e.values()):[];return t.media.forEach(s=>{var l,h,u;let n=(l=s.msid)==null?void 0:l.split(" ")[0],d=(h=i.find(S=>S.type===s.type&&S.stream_id===n))==null?void 0:h.track_id;d&&(s.msid=(u=s.msid)==null?void 0:u.replace(/\s(.+)/,` ${d}`))}),{type:a.type,sdp:qe.write(t)}}function rr(a,e){var s;if(!(a==null?void 0:a.sdp)||!e)return;let i=qe.parse(a.sdp).media.find(n=>ce(n.mid)&&parseInt(n.mid)===parseInt(e));return(s=i==null?void 0:i.msid)==null?void 0:s.split(" ")[1]}function sr(a){return a.sdp.includes("usedtx=1")?a:{type:a.type,sdp:a.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")}}var ve="[HMSConnection]",De=class{constructor(e,t){this.candidates=new Array;this.role=e,this.signal=t}get iceConnectionState(){return this.nativeConnection.iceConnectionState}get connectionState(){return this.nativeConnection.connectionState}get action(){return this.role===G.Publish?p.PUBLISH:p.SUBSCRIBE}addTransceiver(e,t){return this.nativeConnection.addTransceiver(e,t)}createOffer(e,t){return c(this,null,function*(){try{let i=yield this.nativeConnection.createOffer(t);return o.d(ve,`[role=${this.role}] createOffer offer=${JSON.stringify(i,null,1)}`),sr(ir(i,e))}catch(i){throw m.WebrtcErrors.CreateOfferFailed(this.action,i.message)}})}createAnswer(e=void 0){return c(this,null,function*(){try{let t=yield this.nativeConnection.createAnswer(e);return o.d(ve,`[role=${this.role}] createAnswer answer=${JSON.stringify(t,null,1)}`),t}catch(t){throw m.WebrtcErrors.CreateAnswerFailed(this.action,t.message)}})}setLocalDescription(e){return c(this,null,function*(){try{o.d(ve,`[role=${this.role}] setLocalDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setLocalDescription(e)}catch(t){throw m.WebrtcErrors.SetLocalDescriptionFailed(this.action,t.message)}})}setRemoteDescription(e){return c(this,null,function*(){try{o.d(ve,`[role=${this.role}] setRemoteDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setRemoteDescription(e)}catch(t){throw m.WebrtcErrors.SetRemoteDescriptionFailed(this.action,t.message)}})}addIceCandidate(e){return c(this,null,function*(){o.d(ve,`[role=${this.role}] addIceCandidate candidate=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.addIceCandidate(e)})}get remoteDescription(){return this.nativeConnection.remoteDescription}getSenders(){return this.nativeConnection.getSenders()}logSelectedIceCandidatePairs(){try{(this.role===G.Publish?this.getSenders():this.getReceivers()).forEach(t=>{var r;let i=(r=t.track)==null?void 0:r.kind;if(t.transport){let s=t.transport.iceTransport,n=()=>{typeof s.getSelectedCandidatePair=="function"&&(this.selectedCandidatePair=s.getSelectedCandidatePair(),o.d(ve,`${G[this.role]} connection`,`selected ${i||"unknown"} candidate pair`,JSON.stringify(this.selectedCandidatePair,null,2)))};typeof s.onselectedcandidatepairchange=="function"&&(s.onselectedcandidatepairchange=n),n()}})}catch(e){o.w(ve,`Error in logging selected ice candidate pair for ${G[this.role]} connection`,e)}}removeTrack(e){this.nativeConnection.signalingState!=="closed"&&this.nativeConnection.removeTrack(e)}setMaxBitrateAndFramerate(e){return c(this,null,function*(){let t=e.settings.maxBitrate,i=e instanceof z&&e.settings.maxFramerate,r=this.getSenders().find(s=>{var n;return((n=s==null?void 0:s.track)==null?void 0:n.id)===e.getTrackIDBeingSent()});if(r){let s=r.getParameters();s.encodings.length>0&&(t&&(s.encodings[0].maxBitrate=t*1e3),i&&(s.encodings[0].maxFramerate=i)),yield r.setParameters(s)}else o.w(ve,`no sender found to setMaxBitrate for track - ${e.trackId}, sentTrackId - ${e.getTrackIDBeingSent()}`)})}getStats(){return c(this,null,function*(){return yield this.nativeConnection.getStats()})}close(){return c(this,null,function*(){this.nativeConnection.close()})}getReceivers(){return this.nativeConnection.getReceivers()}};var kt=class extends De{constructor(e,t,i,r){super(G.Publish,e);this.TAG="[HMSPublishConnection]";this.observer=i,this.transport=r,this.nativeConnection=new RTCPeerConnection(t),this.nativeConnection.createDataChannel(lt,{protocol:"SCTP"}),this.nativeConnection.onicecandidate=({candidate:s})=>{s&&e.trickle(this.role,s)},this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)}}initAfterJoin(){this.nativeConnection.onnegotiationneeded=()=>c(this,null,function*(){o.d(this.TAG,"onnegotiationneeded"),yield this.observer.onRenegotiationNeeded()})}trackUpdate(e){this.transport.trackUpdate(e)}};var ar=J(require("eventemitter2")),nr=J(require("uuid"));var yt=class{constructor(e,t,i=""){this.TAG="[HMSDataChannel]";this.nativeChannel=e,this.observer=t,this.metadata=i,e.onmessage=r=>{this.observer.onMessage(r.data)}}get id(){return this.nativeChannel.id}get label(){return this.nativeChannel.label}get readyState(){return this.nativeChannel.readyState}send(e){o.d(this.TAG,`[${this.metadata}] Sending [size=${e.length}] message=${e}`),this.nativeChannel.send(e)}close(){this.nativeChannel.close()}};var Mt=class extends De{constructor(e,t,i){super(G.Subscribe,e);this.TAG="[HMSSubscribeConnection]";this.remoteStreams=new Map;this.MAX_RETRIES=3;this.pendingMessageQueue=[];this.eventEmitter=new ar.default({maxListeners:15});this.handlePendingApiMessages=()=>{this.eventEmitter.emit("open",!0),this.pendingMessageQueue.length>0&&(o.d(this.TAG,"Found pending message queue, sending messages"),this.pendingMessageQueue.forEach(e=>this.sendOverApiDataChannel(e)),this.pendingMessageQueue.length=0)};this.sendMessage=(e,t)=>c(this,null,function*(){var r;((r=this.apiChannel)==null?void 0:r.readyState)!=="open"&&(yield this.eventEmitter.waitFor("open"));let i;for(let s=0;s<this.MAX_RETRIES;s++){this.apiChannel.send(e),i=yield this.waitForResponse(t);let n=i.error;if(n){if(n.code===404){o.d(this.TAG,`Track not found ${t}`,{request:e,try:s+1,error:n});break}if(o.e(this.TAG,`Failed sending ${t}`,{request:e,try:s+1,error:n}),!(n.code/100==5||n.code===429))throw Error(`code=${n.code}, message=${n.message}`);let l=(2+Math.random()*2)*1e3;yield W(l)}else break}return i});this.waitForResponse=e=>c(this,null,function*(){let t=yield this.eventEmitter.waitFor("message",function(r){return r.includes(e)}),i=JSON.parse(t[0]);return o.d(this.TAG,`response for ${e} -`,JSON.stringify(i,null,2)),i});this.observer=i,this.nativeConnection=new RTCPeerConnection(t),this.initNativeConnectionCallbacks()}initNativeConnectionCallbacks(){this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=e=>{e.channel.label===lt&&(this.apiChannel=new yt(e.channel,{onMessage:t=>{this.eventEmitter.emit("message",t),this.observer.onApiChannelMessage(t)}},`role=${this.role}`),e.channel.onopen=this.handlePendingApiMessages)},this.nativeConnection.onicecandidate=e=>{e.candidate!==null&&this.signal.trickle(this.role,e.candidate)},this.nativeConnection.ontrack=e=>{var l;let t=e.streams[0],i=t.id;if(!this.remoteStreams.has(i)){let h=new Ce(t,this);this.remoteStreams.set(i,h),t.onremovetrack=u=>{let S=h.tracks.findIndex(g=>g.nativeTrack.id===u.track.id);if(S>=0){let g=h.tracks[S];this.observer.onTrackRemove(g),h.tracks.splice(S,1),h.tracks.length===0&&this.remoteStreams.delete(i)}}}let r=this.remoteStreams.get(i),s=e.track.kind==="audio"?ct:Se,n=new s(r,e.track),d=rr(this.remoteDescription,(l=e.transceiver)==null?void 0:l.mid);d&&n.setSdpTrackId(d),r.tracks.push(n),this.observer.onTrackAdd(n)}}sendOverApiDataChannel(e){this.apiChannel&&this.apiChannel.readyState==="open"?this.apiChannel.send(e):(o.w(this.TAG,`API Data channel not ${this.apiChannel?"open":"present"}, queueing`,e),this.pendingMessageQueue.push(e))}sendOverApiDataChannelWithResponse(e,t){return c(this,null,function*(){let i=(0,nr.v4)(),r=JSON.stringify(v({id:t||i,jsonrpc:"2.0"},e));return this.sendMessage(r,i)})}close(){var e=t=>super[t];return c(this,null,function*(){var i;yield e("close").call(this),(i=this.apiChannel)==null||i.close()})}};var or=(a,e,t,i)=>c(void 0,null,function*(){var n;let r,s={};if(!!e.stream.hasSender(e)){try{r=yield(n=a.publish)==null?void 0:n.call(a,e.getTrackBeingSent());let d={},l={},h={};r==null||r.forEach(u=>{switch(u.type){case"outbound-rtp":l[u.id]=u;break;case"remote-inbound-rtp":h[u.ssrc]=u;break;case"codec":d[u.id]=u.mimeType;break;default:break}}),Object.keys(v({},l)).forEach(u=>{var I;let S=(I=l[u])==null?void 0:I.codecId,g=S?d[S]:void 0,E;g&&(E=g.substring(g.indexOf("/")+1));let N=l[u],O=h[N.ssrc];s[u]=L(v({},N),{bitrate:hi("bytesSent",N,i==null?void 0:i[u]),packetsLost:O==null?void 0:O.packetsLost,jitter:O==null?void 0:O.jitter,roundTripTime:O==null?void 0:O.roundTripTime,totalRoundTripTime:O==null?void 0:O.totalRoundTripTime,peerName:t,peerID:e.peerId,codec:E})})}catch(d){o.w("[HMSWebrtcStats]","Error in getting local track stats",e,d,d.name)}return s}}),cr=(a,e,t,i)=>c(void 0,null,function*(){var l;let r;try{r=yield(l=a.subscribe)==null?void 0:l.call(a,e.nativeTrack)}catch(h){o.w("[HMSWebrtcStats]","Error in getting remote track stats",e,h)}let s=Gr(r),n=hi("bytesReceived",s,i),d=pi("packetsLost",s,i);return(s==null?void 0:s.remote)&&Object.assign(s.remote,{packetsLostRate:pi("packetsLost",s.remote,i==null?void 0:i.remote)}),s&&Object.assign(s,{bitrate:n,packetsLostRate:d,peerId:e.peerId,peerName:t,codec:s.codec})}),Gr=a=>{let e,t,i={};a==null||a.forEach(n=>{switch(n.type){case"inbound-rtp":e=n;break;case"outbound-rtp":e=n;break;case"remote-inbound-rtp":t=n;break;case"codec":i[n.id]=n.mimeType;break;default:break}});let r=(e==null?void 0:e.codecId)?i[e.codecId]:void 0,s;return r&&(s=r.substring(r.indexOf("/")+1)),e&&Object.assign(e,{remote:t,codec:s})},li=(a,e,t)=>{let i=Vr(e),r=hi(a==="publish"?"bytesSent":"bytesReceived",i,t&&t[a]);return i&&Object.assign(i,{bitrate:r})},Vr=a=>{let e;return a.forEach(t=>{t.type==="transport"&&(e=a.get(t.selectedCandidatePairId))}),e||a.forEach(t=>{t.type==="candidate-pair"&&t.selected&&(e=t)}),e},dr=a=>{let e={packetsLost:0,jitter:0};return a==null||a.forEach(t=>{t.packetsLost&&(e.packetsLost+=t.packetsLost),t.jitter>e.jitter&&(e.jitter=t.jitter)}),e},ui=(a,e)=>Array.from(new Set(a.concat(e))),hi=(a,e,t)=>pi(a,e,t)*8,pi=(a,e,t)=>{let i=e&&e[a],r=t?t[a]:null;return[e,t,ce(i),ce(r)].every(n=>!!n)?mi(i,r,e==null?void 0:e.timestamp,t==null?void 0:t.timestamp)*1e3:0},mi=(a,e,t,i)=>ce(a)&&ce(e)&&t&&i?(a-e)/(t-i):0;var je=class{constructor(e,t){this.getStats=e;this.store=t;this.TAG="[HMSWebrtcStats]";this.peerStats={};this.remoteTrackStats={};this.localTrackStats={};var i;this.localPeerID=(i=this.store.getLocalPeer())==null?void 0:i.peerId}getLocalPeerStats(){return this.peerStats[this.localPeerID]}getRemoteTrackStats(e){return this.remoteTrackStats[e]}getLocalTrackStats(){return this.localTrackStats}updateStats(){return c(this,null,function*(){yield this.updateLocalPeerStats(),yield this.updateLocalTrackStats(),yield this.updateRemoteTrackStats()})}updateLocalPeerStats(){return c(this,null,function*(){var u,S,g,E,N,O;let e=this.getLocalPeerStats(),t;try{t=yield(S=(u=this.getStats).publish)==null?void 0:S.call(u)}catch(I){o.w(this.TAG,"Error in getting publish stats",I)}let i=t&&li("publish",t,e),r;try{r=yield(E=(g=this.getStats).subscribe)==null?void 0:E.call(g)}catch(I){o.w(this.TAG,"Error in getting subscribe stats",I)}let s=r&&li("subscribe",r,e),{packetsLost:n,jitter:d}=dr(r),l=mi(n,(N=e==null?void 0:e.subscribe)==null?void 0:N.packetsLost,s==null?void 0:s.timestamp,(O=e==null?void 0:e.subscribe)==null?void 0:O.timestamp),h=s&&Object.assign(s,{packetsLostRate:l,jitter:d,packetsLost:n});this.peerStats[this.localPeerID]={publish:i,subscribe:h}})}updateRemoteTrackStats(){return c(this,null,function*(){var i;let e=this.store.getTracksMap(),t=ui(Object.keys(this.remoteTrackStats),Object.keys(e)).filter(r=>e[r]&&e[r].peerId!==this.localPeerID);for(let r of t){let s=e[r];if(s){let n=s.peerId&&((i=this.store.getPeerById(s.peerId))==null?void 0:i.name),d=this.getRemoteTrackStats(s.trackId),l=yield cr(this.getStats,s,n,d);l&&(this.remoteTrackStats[r]=l)}else delete this.remoteTrackStats[r]}})}updateLocalTrackStats(){return c(this,null,function*(){var i;let e=this.store.getLocalPeerTracks().reduce((r,s)=>(r[s.getTrackIDBeingSent()]=s,r),{}),t=ui(Object.keys(this.localTrackStats),Object.keys(e));for(let r of t){let s=e[r];if(s){let n=(i=this.store.getLocalPeer())==null?void 0:i.name,d=yield or(this.getStats,s,n,this.localTrackStats[r]);d&&(this.localTrackStats[r]=d)}else delete this.localTrackStats[r]}})}};var Je=class{constructor(e,t,i,r){this.store=e;this.eventBus=t;this.publishConnection=i;this.subscribeConnection=r;this.TAG="[HMSWebrtcInternals]";this.interval=Gi;this.isMonitored=!1;this.handleStatsUpdate=()=>c(this,null,function*(){var e;yield(e=this.hmsStats)==null?void 0:e.updateStats(),this.eventBus.statsUpdate.publish(this.hmsStats)})}getPublishPeerConnection(){return this.publishConnection}getSubscribePeerConnection(){return this.subscribeConnection}getCurrentStats(){return this.hmsStats}onStatsChange(e){return this.eventBus.statsUpdate.subscribe(e),()=>{this.eventBus.statsUpdate.unsubscribe(e)}}setPeerConnections({publish:e,subscribe:t}){var i,r;this.publishConnection=e,this.subscribeConnection=t,this.hmsStats=new je({publish:(i=this.publishConnection)==null?void 0:i.getStats.bind(this.publishConnection),subscribe:(r=this.subscribeConnection)==null?void 0:r.getStats.bind(this.subscribeConnection)},this.store)}start(){return c(this,null,function*(){if(this.isMonitored){o.d(this.TAG,"Already started");return}this.stop(),this.isMonitored=!0,o.d(this.TAG,"Starting Webrtc Stats Monitor"),this.startLoop().then(()=>o.d(this.TAG,"Stopping Webrtc Stats Monitor")).catch(e=>o.e(this.TAG,e.message))})}stop(){this.isMonitored=!1}startLoop(){return c(this,null,function*(){for(;this.isMonitored;)yield this.handleStatsUpdate(),yield W(this.interval)})}cleanUp(){this.stop(),this.eventBus.statsUpdate.removeAllListeners()}};var gi="[InitService]",At=class{static handleError(e,t){switch(e.status){case 404:throw m.InitAPIErrors.EndpointUnreachable(p.INIT,t.message||e.statusText);case 200:break;default:throw m.InitAPIErrors.ServerErrors(t.code||e.status,p.INIT,t.message||(e==null?void 0:e.statusText))}}static fetchInitConfig(n){return c(this,arguments,function*({token:e,peerId:t,userAgent:i,initEndpoint:r="https://prod-init.100ms.live",region:s=""}){o.d(gi,`fetchInitConfig: initEndpoint=${r} token=${e} peerId=${t} region=${s} `);let d=$r(r,t,i,s);try{let l=yield fetch(d,{headers:{Authorization:`Bearer ${e}`}}),h=yield l.json();return this.handleError(l,h),o.d(gi,`config is ${JSON.stringify(h,null,2)}`),Wr(h)}catch(l){let h=l;throw["Failed to fetch","NetworkError"].some(u=>h.message.includes(u))?m.InitAPIErrors.EndpointUnreachable(p.INIT,h.message):h}})}};function $r(a,e,t,i){try{let r=new URL("/init",a);return i&&i.trim().length>0&&r.searchParams.set("region",i.trim()),r.searchParams.set("peer_id",e),r.searchParams.set("user_agent_v2",t),r.toString()}catch(r){let s=r;throw o.e(gi,s.name,s.message),s}}function Wr(a){var e;return L(v({},a),{rtcConfiguration:L(v({},a.rtcConfiguration),{iceServers:(e=a.rtcConfiguration)==null?void 0:e.ice_servers})})}var de;(function(i){i.FLAG_SERVER_SUB_DEGRADATION="subscribeDegradation",i.FLAG_SERVER_SIMULCAST="simulcast",i.FLAG_NON_WEBRTC_DISABLE_OFFER="nonWebRTCDisableOffer"})(de||(de={}));var lr=J(require("uuid"));var w;(function(k){k.JOIN="join",k.OFFER="offer",k.ANSWER="answer",k.TRICKLE="trickle",k.TRACK_UPDATE="track-update",k.BROADCAST="broadcast",k.ANALYTICS="analytics",k.SERVER_ERROR="on-error",k.SERVER_WARNING="on-warning",k.SDK_NOTIFICATION="sdk-notification",k.LEAVE="leave",k.END_ROOM="end-room",k.PING="ping",k.ROLE_CHANGE_REQUEST="role-change-request",k.ROLE_CHANGE="role-change",k.TRACK_UPDATE_REQUEST="track-update-request",k.PEER_LEAVE_REQUEST="peer-leave-request",k.CHANGE_TRACK_MUTE_STATE_REQUEST="change-track-mute-state-request",k.START_RTMP_OR_RECORDING_REQUEST="rtmp-start",k.STOP_RTMP_AND_RECORDING_REQUEST="rtmp-stop",k.UPDATE_PEER_METADATA="peer-update",k.START_HLS_STREAMING="hls-start",k.STOP_HLS_STREAMING="hls-stop",k.HLS_TIMED_METADATA="hls-timed-metadata",k.SET_METADATA="set-metadata",k.GET_METADATA="get-metadata"})(w||(w={}));function Si(a){switch(a){case w.JOIN:return p.JOIN;case w.OFFER:return p.PUBLISH;case w.ANSWER:return p.SUBSCRIBE;case w.TRACK_UPDATE:return p.TRACK;default:return p.NONE}}var Pt=class{constructor(e){this.TAG="[SIGNAL]: ";this.pongResponseTimes=new Te(Ui);this.isJoinCompleted=!1;this.pendingTrickle=[];this.socket=null;this.callbacks=new Map;this._isConnected=!1;this.id=0;this.onCloseHandler=()=>{};this.offlineListener=()=>{o.d(this.TAG,"Window network offline"),this.setIsConnected(!1,"Window network offline")};this.onlineListener=()=>{o.d(this.TAG,"Window network online"),this.observer.onNetworkOnline()};this.observer=e,window.addEventListener("offline",this.offlineListener),window.addEventListener("online",this.onlineListener),this.onMessageHandler=this.onMessageHandler.bind(this)}get isConnected(){return this._isConnected}setIsConnected(e,t=""){o.d(this.TAG,`isConnected set id: ${this.id}, oldValue: ${this._isConnected}, newValue: ${e}`),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.rejectPendingCalls(t),this.observer.onOffline(t)):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}getPongResponseTimes(){return this.pongResponseTimes.toList()}internalCall(e,t){return c(this,null,function*(){var s;let i=(0,lr.v4)(),r={method:e,params:t,id:i,jsonrpc:"2.0"};(s=this.socket)==null||s.send(JSON.stringify(r));try{return yield new Promise((d,l)=>{this.callbacks.set(i,{resolve:d,reject:l,metadata:{method:e}})})}catch(n){if(n instanceof T)throw n;let d=n;throw m.WebsocketMethodErrors.ServerErrors(Number(d.code),Si(e),d.message)}})}notify(e,t){var r,s;let i={method:e,params:t};((r=this.socket)==null?void 0:r.readyState)===WebSocket.OPEN&&((s=this.socket)==null||s.send(JSON.stringify(i)))}open(e){return new Promise((t,i)=>{let r=!1;this.socket&&(this.socket.close(),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)),this.socket=new WebSocket(e);let s=d=>{o.e(this.TAG,"Error from websocket",d),r=!0,i(m.WebSocketConnectionErrors.FailedToConnect(p.JOIN,`Error opening websocket connection - ${d}`))};this.onCloseHandler=d=>{o.e(`Websocket closed code=${d.code}`),r?this.setIsConnected(!1,`code: ${d.code}${d.code!==1e3?", unexpected websocket close":""}`):(r=!0,i(m.WebSocketConnectionErrors.AbnormalClose(p.JOIN,`Error opening websocket connection - websocket closed unexpectedly with code=${d.code}`)))},this.socket.addEventListener("error",s);let n=()=>{var d,l;r=!0,t(),this.setIsConnected(!0),this.id++,(d=this.socket)==null||d.removeEventListener("open",n),(l=this.socket)==null||l.removeEventListener("error",s),this.pingPongLoop(this.id)};this.socket.addEventListener("open",n),this.socket.addEventListener("close",this.onCloseHandler),this.socket.addEventListener("message",this.onMessageHandler)})}close(){return c(this,null,function*(){window.removeEventListener("offline",this.offlineListener),window.removeEventListener("online",this.onlineListener),this.socket?(this.socket.close(1e3,"Normal Close"),this.setIsConnected(!1,"code: 1000, normal websocket close"),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)):this.setIsConnected(!1,"websocket not connected yet")})}join(e,t,i,r,s,n){return c(this,null,function*(){if(!this.isConnected)throw m.WebSocketConnectionErrors.WebSocketConnectionLost(p.JOIN,"Failed to send join over WS connection");let d={name:e,disableVidAutoSub:i,data:t,offer:n,server_sub_degrade:r,simulcast:s},l=yield this.internalCall(w.JOIN,d);return this.isJoinCompleted=!0,this.pendingTrickle.forEach(({target:h,candidate:u})=>this.trickle(h,u)),this.pendingTrickle.length=0,o.d(this.TAG,`join: response=${JSON.stringify(l,null,1)}`),l})}trickle(e,t){this.isJoinCompleted?this.notify(w.TRICKLE,{target:e,candidate:t}):this.pendingTrickle.push({target:e,candidate:t})}offer(e,t){return c(this,null,function*(){return yield this.call(w.OFFER,{desc:e,tracks:Object.fromEntries(t)})})}answer(e){this.notify(w.ANSWER,{desc:e})}trackUpdate(e){this.notify(w.TRACK_UPDATE,{version:"1.0",tracks:Object.fromEntries(e)})}broadcast(e){return c(this,null,function*(){return yield this.call(w.BROADCAST,v({version:"1.0"},e.toSignalParams()))})}leave(){this.notify(w.LEAVE,{version:"1.0"})}endRoom(e,t){return c(this,null,function*(){yield this.call(w.END_ROOM,{lock:e,reason:t})})}sendEvent(e){if(!this.isConnected)throw Error(`${this.TAG} not connected. Could not send event ${e}`);this.notify(w.ANALYTICS,e.toSignalParams())}ping(e){let t=Date.now(),i=new Promise(s=>{setTimeout(()=>{s(Date.now()-t)},e+1)}),r=this.internalCall(w.PING,{timestamp:t}).then(()=>Date.now()-t).catch(()=>Date.now()-t);return Promise.race([i,r])}requestRoleChange(e){return c(this,null,function*(){yield this.call(w.ROLE_CHANGE_REQUEST,e)})}requestBulkRoleChange(e){return c(this,null,function*(){yield this.call(w.ROLE_CHANGE_REQUEST,e)})}acceptRoleChangeRequest(e){return c(this,null,function*(){yield this.call(w.ROLE_CHANGE,e)})}requestTrackStateChange(e){return c(this,null,function*(){yield this.call(w.TRACK_UPDATE_REQUEST,e)})}requestMultiTrackStateChange(e){return c(this,null,function*(){yield this.call(w.CHANGE_TRACK_MUTE_STATE_REQUEST,e)})}removePeer(e){return c(this,null,function*(){yield this.call(w.PEER_LEAVE_REQUEST,e)})}startRTMPOrRecording(e){return c(this,null,function*(){yield this.call(w.START_RTMP_OR_RECORDING_REQUEST,v({version:"1.0"},e))})}stopRTMPAndRecording(){return c(this,null,function*(){yield this.call(w.STOP_RTMP_AND_RECORDING_REQUEST,{version:"1.0"})})}startHLSStreaming(e){return c(this,null,function*(){yield this.call(w.START_HLS_STREAMING,v({version:"1.0"},e))})}stopHLSStreaming(e){return c(this,null,function*(){yield this.call(w.STOP_HLS_STREAMING,v({version:"1.0"},e))})}sendHLSTimedMetadata(e){return c(this,null,function*(){yield this.call(w.HLS_TIMED_METADATA,v({version:"1.0"},e))})}updatePeer(e){return c(this,null,function*(){yield this.call(w.UPDATE_PEER_METADATA,v({version:"1.0"},e))})}setSessionMetadata(e){return c(this,null,function*(){yield this.call(w.SET_METADATA,v({version:"1.0"},e))})}getSessionMetadata(){return this.call(w.GET_METADATA,{version:"1.0"})}onMessageHandler(e){let t=e.data,i=JSON.parse(t);if(i.id)this.handleResponseWithId(i);else if(i.method)this.handleResponseWithMethod(i);else throw Error(`WebSocket message has no 'method' or 'id' field, message=${i}`)}handleResponseWithId(e){let t=e,i=t.id;if(this.callbacks.has(i)){let r=this.callbacks.get(i);this.callbacks.delete(i),t.result?r.resolve(t.result):r.reject(t.error)}else this.observer.onNotification(t)}handleResponseWithMethod(e){switch(e.method){case w.OFFER:this.observer.onOffer(e.params);break;case w.TRICKLE:this.observer.onTrickle(e.params);break;case w.SERVER_ERROR:this.observer.onServerError(m.WebsocketMethodErrors.ServerErrors(Number(e.params.code),p.NONE,e.params.message));break;case w.SERVER_WARNING:o.w(this.TAG,e.params);break;default:this.observer.onNotification(e);break}}rejectPendingCalls(e=""){this.callbacks.forEach((t,i)=>{var r,s,n,d;((r=t.metadata)==null?void 0:r.method)!==w.PING&&(o.e(this.TAG,`rejecting pending callback ${(s=t.metadata)==null?void 0:s.method}, id=${i}`),t.reject(m.WebSocketConnectionErrors.WebSocketConnectionLost(((n=t.metadata)==null?void 0:n.method)?Si((d=t.metadata)==null?void 0:d.method):p.RECONNECT_SIGNAL,e)),this.callbacks.delete(i))})}pingPongLoop(e){return c(this,null,function*(){var i,r;let t=((i=window.HMS)==null?void 0:i.PING_TIMEOUT)||xi;if(this.isConnected){let s=yield this.ping(t);this.pongResponseTimes.enqueue(s),s>t?(o.d(this.TAG,`Pong timeout ${e}, pageHidden=${Lt()}`),this.id===e&&this.setIsConnected(!1,"ping pong failure")):setTimeout(()=>this.pingPongLoop(e),((r=window.HMS)==null?void 0:r.PING_INTERVAL)||Fi)}})}call(e,t){return c(this,null,function*(){let i=3,r=m.WebsocketMethodErrors.ServerErrors(500,e,`Default ${e} error`);for(let s=0;s<i;s++)try{return o.d(this.TAG,`Try number ${s+1} sending ${e}`,t),yield this.internalCall(e,t)}catch(n){if(r=n,o.e(this.TAG,`Failed sending ${e}`,{method:e,try:s+1,params:t,error:r}),!(parseInt(`${r.code/100}`)===5||r.code===429))break;let l=(2+Math.random()*2)*1e3;yield W(l)}throw o.e(`Sending ${e} over WS failed after ${i} retries`,{method:e,params:t,error:r}),r})}};var ur=()=>{if(!X||typeof navigator.connection=="undefined")return;let a=navigator.connection;return{downlink:a.downlink,downlinkMax:a.downlinkMax,effectiveType:a.effectiveType,rtt:a.rtt,saveData:a.saveData,type:a.type}};var P="[HMSTransport]:",It=class{constructor(e,t,i,r,s,n){this.observer=e;this.deviceManager=t;this.store=i;this.eventBus=r;this.analyticsEventsService=s;this.analyticsTimer=n;this.state=R.Disconnected;this.trackStates=new Map;this.publishConnection=null;this.subscribeConnection=null;this.maxSubscribeBitrate=0;this.joinRetryCount=0;this.callbacks=new Map;this.signalObserver={onOffer:e=>c(this,null,function*(){try{if(!this.subscribeConnection)return;yield this.subscribeConnection.setRemoteDescription(e),o.d(P,`[SUBSCRIBE] Adding ${this.subscribeConnection.candidates.length} ice-candidates`,this.subscribeConnection.candidates);for(let i of this.subscribeConnection.candidates)yield this.subscribeConnection.addIceCandidate(i);this.subscribeConnection.candidates.length=0;let t=yield this.subscribeConnection.createAnswer();yield this.subscribeConnection.setLocalDescription(t),this.signal.answer(t),o.d(P,"[role=SUBSCRIBE] onOffer renegotiation DONE \u2705")}catch(t){o.d(P,"[role=SUBSCRIBE] onOffer renegotiation FAILED \u274C",t),this.state=R.Failed;let i;t instanceof T?i=t:i=m.GenericErrors.Unknown(p.PUBLISH,t.message),this.observer.onFailure(i),this.eventBus.analytics.publish(H.subscribeFail(i))}}),onTrickle:e=>c(this,null,function*(){let t=e.target===G.Publish?this.publishConnection:this.subscribeConnection;(t==null?void 0:t.remoteDescription)?yield t.addIceCandidate(e.candidate):t==null||t.candidates.push(e.candidate)}),onNotification:e=>this.observer.onNotification(e),onServerError:e=>c(this,null,function*(){yield this.observer.onStateChange(R.Failed,e)}),onFailure:e=>{this.joinParameters&&this.retryScheduler.schedule({category:C.SignalDisconnect,error:e,task:this.retrySignalDisconnectTask,originalState:this.state})},onOffline:e=>c(this,null,function*(){o.d(P,"socket offline",R[this.state]);try{this.state!==R.Leaving&&this.joinParameters&&this.retryScheduler.schedule({category:C.SignalDisconnect,error:m.WebSocketConnectionErrors.WebSocketConnectionLost(p.RECONNECT_SIGNAL,e),task:this.retrySignalDisconnectTask,originalState:this.state})}catch(t){console.error(t)}}),onOnline:()=>{var e;o.d(P,"socket online",R[this.state]),this.analyticsSignalTransport.flushFailedEvents((e=this.store.getLocalPeer())==null?void 0:e.peerId)},onNetworkOnline:()=>{this.analyticsEventsService.flushFailedClientEvents()}};this.signal=new Pt(this.signalObserver);this.analyticsSignalTransport=new oi(this.signal);this.publishConnectionObserver={onRenegotiationNeeded:()=>c(this,null,function*(){yield this.performPublishRenegotiation()}),onIceConnectionChange:e=>c(this,null,function*(){(e==="disconnected"?o.w.bind(o):o.d.bind(o))(P,`Publish ice connection state change: ${e}`)}),onConnectionStateChange:e=>c(this,null,function*(){var i,r,s,n,d;(e==="disconnected"?o.w.bind(o):o.d.bind(o))(P,`Publish connection state change: ${e}`),e==="connected"&&((i=this.publishConnection)==null||i.logSelectedIceCandidatePairs()),e==="disconnected"&&setTimeout(()=>{var l,h,u,S,g;((l=this.publishConnection)==null?void 0:l.connectionState)==="disconnected"&&this.handleIceConnectionFailure(G.Publish,m.WebrtcErrors.ICEDisconnected(p.PUBLISH,`local candidate - ${(u=(h=this.publishConnection)==null?void 0:h.selectedCandidatePair)==null?void 0:u.local.candidate}; remote candidate - ${(g=(S=this.publishConnection)==null?void 0:S.selectedCandidatePair)==null?void 0:g.remote.candidate}`))},Gt),e==="failed"&&(yield this.handleIceConnectionFailure(G.Publish,m.WebrtcErrors.ICEFailure(p.PUBLISH,`local candidate - ${(s=(r=this.publishConnection)==null?void 0:r.selectedCandidatePair)==null?void 0:s.local.candidate}; remote candidate - ${(d=(n=this.publishConnection)==null?void 0:n.selectedCandidatePair)==null?void 0:d.remote.candidate}`)))})};this.subscribeConnectionObserver={onApiChannelMessage:e=>{this.observer.onNotification(JSON.parse(e))},onTrackAdd:e=>{o.d(P,"[Subscribe] onTrackAdd",`${e}`),this.observer.onTrackAdd(e)},onTrackRemove:e=>{o.d(P,"[Subscribe] onTrackRemove",`${e}`),this.observer.onTrackRemove(e)},onIceConnectionChange:e=>c(this,null,function*(){if((e==="disconnected"?o.w.bind(o):o.d.bind(o))(P,`Subscribe ice connection state change: ${e}`),e==="connected"){let i=this.callbacks.get(_e);this.callbacks.delete(_e),i&&i.promise.resolve(!0)}}),onConnectionStateChange:e=>c(this,null,function*(){var i,r,s,n;(e==="disconnected"?o.w.bind(o):o.d.bind(o))(P,`Subscribe connection state change: ${e}`),e==="failed"&&(yield this.handleIceConnectionFailure(G.Subscribe,m.WebrtcErrors.ICEFailure(p.SUBSCRIBE,`local candidate - ${(r=(i=this.subscribeConnection)==null?void 0:i.selectedCandidatePair)==null?void 0:r.local.candidate}; remote candidate - ${(n=(s=this.subscribeConnection)==null?void 0:s.selectedCandidatePair)==null?void 0:n.remote.candidate}`))),e==="disconnected"&&setTimeout(()=>{var d,l,h,u,S;((d=this.subscribeConnection)==null?void 0:d.connectionState)==="disconnected"&&this.handleIceConnectionFailure(G.Subscribe,m.WebrtcErrors.ICEDisconnected(p.SUBSCRIBE,`local candidate - ${(h=(l=this.subscribeConnection)==null?void 0:l.selectedCandidatePair)==null?void 0:h.local.candidate}; remote candidate - ${(S=(u=this.subscribeConnection)==null?void 0:u.selectedCandidatePair)==null?void 0:S.remote.candidate}`))},Gt),e==="connected"&&this.handleSubscribeConnectionConnected()})};this.handleLocalRoleUpdate=i=>c(this,[i],function*({oldRole:e,newRole:t}){!(!this.doesRoleNeedWebRTC(e)&&this.doesRoleNeedWebRTC(t))||(o.i(P,"Local peer role updated to webrtc role, creating PeerConnections and performing inital publish negotiation \u23F3"),this.createPeerConnections(),yield this.negotiateOnFirstPublish())});this.retryPublishIceFailedTask=()=>c(this,null,function*(){if(this.publishConnection){let e=new Promise((t,i)=>{this.callbacks.set(Le,{promise:{resolve:t,reject:i},action:p.RESTART_ICE,extra:{}})});yield this.performPublishRenegotiation({iceRestart:this.publishConnection.connectionState!=="connected"}),yield e}return!0});this.retrySubscribeIceFailedTask=()=>c(this,null,function*(){if(this.subscribeConnection&&this.subscribeConnection.connectionState!=="connected"){let e=new Promise((i,r)=>{this.callbacks.set(_e,{promise:{resolve:i,reject:r},action:p.RESTART_ICE,extra:{}})}),t=new Promise(i=>{setTimeout(i,Bi,!1)});return Promise.race([e,t])}return!0});this.retrySignalDisconnectTask=()=>c(this,null,function*(){if(o.d(P,"retrySignalDisconnectTask",{signalConnected:this.signal.isConnected}),!this.signal.isConnected)try{yield this.internalConnect(this.joinParameters.authToken,this.joinParameters.endpoint,this.joinParameters.peerId)}catch(t){}let e=this.store.getRoom().joinedAt?this.signal.isConnected&&(yield this.retryPublishIceFailedTask()):this.signal.isConnected;return this.signal.trackUpdate(this.trackStates),e});var l,h;this.webrtcInternals=new Je(this.store,this.eventBus,(l=this.publishConnection)==null?void 0:l.nativeConnection,(h=this.subscribeConnection)==null?void 0:h.nativeConnection);let d=(u,S)=>c(this,null,function*(){u!==this.state&&(this.state=u,yield this.observer.onStateChange(this.state,S))});this.retryScheduler=new si(d,this.sendErrorAnalyticsEvent.bind(this)),this.eventBus.statsUpdate.subscribe(u=>{var g,E;let S=((E=(g=u.getLocalPeerStats())==null?void 0:g.subscribe)==null?void 0:E.bitrate)||0;this.maxSubscribeBitrate=Math.max(this.maxSubscribeBitrate,S)})}getWebrtcInternals(){return this.webrtcInternals}isFlagEnabled(e){var r;let t=(r=this.initConfig)==null?void 0:r.config;return((t==null?void 0:t.enabledFlags)||[]).includes(e)}preview(e,t,i,r,s=!1){return c(this,null,function*(){let n=yield this.connect(e,t,i,r,s);return this.state=R.Preview,this.observer.onStateChange(this.state),n})}join(e,t,i,r,s=!1){return c(this,null,function*(){o.d(P,"join: started \u23F0");try{(!this.signal.isConnected||!this.initConfig)&&(yield this.connect(e,r,t,i,s)),this.validateNotDisconnected("connect"),this.initConfig&&(yield this.waitForLocalRoleAvailability(),yield this.createConnectionsAndNegotiateJoin(i,s),yield this.initRtcStatsMonitor(),o.d(P,"\u2705 join: Negotiated over PUBLISH connection"))}catch(n){o.e(P,`join: failed \u274C [token=${e}]`,n),this.state=R.Failed;let d=n;throw d.isTerminal=d.isTerminal||d.code===500,yield this.observer.onStateChange(this.state,d),d}o.i(P,"\u2705 join: successful"),this.state=R.Joined,this.observer.onStateChange(this.state)})}connect(e,t,i,r,s=!1){return c(this,null,function*(){this.setTransportStateForConnect(),this.joinParameters=new ii(e,i,r.name,r.metaData,t,s);try{return yield this.internalConnect(e,t,i)}catch(n){if(n instanceof T&&([f.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,f.WebSocketConnectionErrors.FAILED_TO_CONNECT,f.WebSocketConnectionErrors.ABNORMAL_CLOSE,f.InitAPIErrors.ENDPOINT_UNREACHABLE].includes(n.code)||n.code.toString().startsWith("5")||n.code.toString().startsWith("429"))){let l=()=>c(this,null,function*(){return yield this.internalConnect(e,t,i),Boolean(this.initConfig&&this.initConfig.endpoint)});yield this.retryScheduler.schedule({category:C.ConnectFailed,error:n,task:l,originalState:this.state,maxFailedRetries:$e,changeState:!1})}else throw n}})}leave(e){return c(this,null,function*(){var t,i,r;this.retryScheduler.reset(),this.joinParameters=void 0,o.d(P,"leaving in transport");try{if(this.state=R.Leaving,(t=this.webrtcInternals)==null||t.cleanUp(),yield(i=this.publishConnection)==null?void 0:i.close(),yield(r=this.subscribeConnection)==null?void 0:r.close(),e)try{this.signal.leave(),o.d(P,"signal leave done")}catch(s){o.w(P,"failed to send leave on websocket to server",s)}this.analyticsEventsService.flushFailedClientEvents(),this.analyticsEventsService.reset(),yield this.signal.close()}catch(s){this.eventBus.analytics.publish(H.disconnect(s)),o.e(P,"leave: FAILED \u274C",s)}finally{this.state=R.Disconnected,this.observer.onStateChange(this.state)}})}publish(e){return c(this,null,function*(){for(let t of e)try{yield this.publishTrack(t)}catch(i){this.eventBus.analytics.publish(H.publish({devices:this.deviceManager.getDevices(),error:i}))}})}unpublish(e){return c(this,null,function*(){for(let t of e)yield this.unpublishTrack(t)})}sendMessage(e){return c(this,null,function*(){return yield this.signal.broadcast(e)})}trackUpdate(e){let i=Array.from(this.trackStates.values()).find(r=>e.type===r.type&&e.source===r.source);if(i){let r=new Tt(L(v({},i),{mute:!e.enabled}));this.trackStates.set(i.track_id,r),o.d(P,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[i.track_id,r]]))}}changeRole(e,t,i=!1){return c(this,null,function*(){yield this.signal.requestRoleChange({requested_for:e.peerId,role:t,force:i})})}changeRoleOfPeer(e,t,i){return c(this,null,function*(){yield this.signal.requestRoleChange({requested_for:e.peerId,role:t,force:i})})}changeRoleOfPeersWithRoles(e,t){return c(this,null,function*(){yield this.signal.requestBulkRoleChange({roles:e.map(i=>i.name),role:t,force:!0})})}acceptRoleChange(e){return c(this,null,function*(){var t;yield this.signal.acceptRoleChangeRequest({requested_by:(t=e.requestedBy)==null?void 0:t.peerId,role:e.role.name,token:e.token})})}endRoom(e,t){return c(this,null,function*(){yield this.signal.endRoom(e,t)})}removePeer(e,t){return c(this,null,function*(){yield this.signal.removePeer({requested_for:e,reason:t})})}startRTMPOrRecording(e){return c(this,null,function*(){var i;let t={meeting_url:e.meetingURL,record:e.record};((i=e.rtmpURLs)==null?void 0:i.length)&&(t.rtmp_urls=e.rtmpURLs),e.resolution&&(t.resolution=e.resolution),yield this.signal.startRTMPOrRecording(t)})}stopRTMPOrRecording(){return c(this,null,function*(){yield this.signal.stopRTMPAndRecording()})}startHLSStreaming(e){return c(this,null,function*(){let t={};e&&e.variants&&e.variants.length>0&&(t.variants=e.variants.map(i=>{let r={meeting_url:i.meetingURL};return i.metadata&&(r.metadata=i.metadata),r})),(e==null?void 0:e.recording)&&(t.hls_recording={single_file_per_layer:e.recording.singleFilePerLayer,hls_vod:e.recording.hlsVod}),yield this.signal.startHLSStreaming(t)})}stopHLSStreaming(e){return c(this,null,function*(){var t;if(e){let i={variants:(t=e==null?void 0:e.variants)==null?void 0:t.map(r=>{let s={meeting_url:r.meetingURL};return r.metadata&&(s.metadata=r.metadata),s})};yield this.signal.stopHLSStreaming(i)}yield this.signal.stopHLSStreaming()})}sendHLSTimedMetadata(e){return c(this,null,function*(){if(e.length>0){let t={metadata_objs:e};yield this.signal.sendHLSTimedMetadata(t)}})}changeName(e){return c(this,null,function*(){let t=this.store.getLocalPeer();t&&t.name!==e&&(yield this.signal.updatePeer({name:e}))})}changeMetadata(e){return c(this,null,function*(){yield this.signal.updatePeer({data:e})})}getSessionMetadata(){return this.signal.getSessionMetadata()}setSessionMetadata(e){return c(this,null,function*(){yield this.signal.setSessionMetadata({data:e})})}changeTrackState(e){return c(this,null,function*(){yield this.signal.requestTrackStateChange(e)})}changeMultiTrackState(e){return c(this,null,function*(){yield this.signal.requestMultiTrackStateChange(e)})}publishTrack(e){return c(this,null,function*(){e.publishedTrackId=e.getTrackIDBeingSent(),o.d(P,`\u23F3 publishTrack: trackId=${e.trackId}, toPublishTrackId=${e.publishedTrackId}`,`${e}`),this.trackStates.set(e.publishedTrackId,new Tt(e));let t=new Promise((s,n)=>{this.callbacks.set(Le,{promise:{resolve:s,reject:n},action:p.PUBLISH,extra:{}})}),i=e.stream;i.setConnection(this.publishConnection);let r=this.store.getSimulcastLayers(e.source);i.addTransceiver(e,r),o.time(`publish-${e.trackId}-${e.type}`),yield t,o.timeEnd(`publish-${e.trackId}-${e.type}`),this.store.addTrack(e),yield i.setMaxBitrateAndFramerate(e).then(()=>{o.d(P,`Setting maxBitrate=${e.settings.maxBitrate} kpbs${e instanceof z?` and maxFramerate=${e.settings.maxFramerate}`:""} for ${e.source} ${e.type} ${e.trackId}`)}).catch(s=>o.w(P,"Failed setting maxBitrate and maxFramerate",s)),e.isPublished=!0,o.d(P,`\u2705 publishTrack: trackId=${e.trackId}`,`${e}`,this.callbacks)})}unpublishTrack(e){return c(this,null,function*(){if(o.d(P,`\u23F3 unpublishTrack: trackId=${e.trackId}`,`${e}`),e.publishedTrackId&&this.trackStates.has(e.publishedTrackId))this.trackStates.delete(e.publishedTrackId);else{let s=Array.from(this.trackStates.values()).find(n=>e.type===n.type&&e.source===n.source);s&&this.trackStates.delete(s.track_id)}let t=new Promise((r,s)=>{this.callbacks.set(Le,{promise:{resolve:r,reject:s},action:p.UNPUBLISH,extra:{}})});e.stream.removeSender(e),yield t,yield e.cleanup(),this.store.removeTrack(e.trackId),o.d(P,`\u2705 unpublishTrack: trackId=${e.trackId}`,this.callbacks)})}waitForLocalRoleAvailability(){if(!this.store.hasRoleDetailsArrived())return new Promise(e=>{this.eventBus.policyChange.subscribeOnce(()=>e())})}createConnectionsAndNegotiateJoin(e,t=!1){return c(this,null,function*(){let i=this.doesLocalPeerNeedWebRTC();i&&this.createPeerConnections(),this.analyticsTimer.start(M.JOIN_RESPONSE),yield this.negotiateJoinWithRetry({name:e.name,data:e.metaData,autoSubscribeVideo:t,isWebRTC:i}),this.analyticsTimer.end(M.JOIN_RESPONSE)})}createPeerConnections(){this.initConfig&&(this.publishConnection||(this.publishConnection=new kt(this.signal,this.initConfig.rtcConfiguration,this.publishConnectionObserver,this)),this.subscribeConnection||(this.subscribeConnection=new Mt(this.signal,this.initConfig.rtcConfiguration,this.subscribeConnectionObserver)))}negotiateJoinWithRetry(s){return c(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r=!0}){try{yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r})}catch(n){o.e(P,"Join negotiation failed \u274C",n);let d=n instanceof T?n:m.WebsocketMethodErrors.ServerErrors(500,p.JOIN,`Websocket join error - ${n.message}`);if(parseInt(`${d.code/100}`)===5||[f.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,429].includes(d.code)){this.joinRetryCount=0,d.isTerminal=!1;let h=()=>c(this,null,function*(){return this.joinRetryCount++,yield this.negotiateJoin({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r})});yield this.retryScheduler.schedule({category:C.JoinWSMessageFailed,error:d,task:h,originalState:R.Joined,maxFailedRetries:3,changeState:!1})}else throw n}})}negotiateJoin(s){return c(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i,isWebRTC:r=!0}){return r?yield this.negotiateJoinWebRTC({name:e,data:t,autoSubscribeVideo:i}):yield this.negotiateJoinNonWebRTC({name:e,data:t,autoSubscribeVideo:i})})}negotiateJoinWebRTC(r){return c(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i}){if(o.d(P,"\u23F3 join: Negotiating over PUBLISH connection"),!this.publishConnection)return o.e(P,"Publish peer connection not found, cannot negotiate"),!1;let s=yield this.publishConnection.createOffer();yield this.publishConnection.setLocalDescription(s);let n=this.isFlagEnabled(de.FLAG_SERVER_SUB_DEGRADATION),d=this.isFlagEnabled(de.FLAG_SERVER_SIMULCAST),l=yield this.signal.join(e,t,!i,n,d,s);yield this.publishConnection.setRemoteDescription(l);for(let h of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(h);return this.publishConnection.initAfterJoin(),!!l})}negotiateJoinNonWebRTC(r){return c(this,arguments,function*({name:e,data:t,autoSubscribeVideo:i}){o.d(P,"\u23F3 join: Negotiating Non-WebRTC");let s=this.isFlagEnabled(de.FLAG_SERVER_SUB_DEGRADATION),n=this.isFlagEnabled(de.FLAG_SERVER_SIMULCAST);return!!(yield this.signal.join(e,t,!i,s,n))})}negotiateOnFirstPublish(){return c(this,null,function*(){if(o.d(P,"\u23F3 Negotiating offer over PUBLISH connection"),!this.publishConnection)return o.e(P,"Publish peer connection not found, cannot negotiate"),!1;let e=yield this.publishConnection.createOffer(this.trackStates);yield this.publishConnection.setLocalDescription(e);let t=yield this.signal.offer(e,this.trackStates);yield this.publishConnection.setRemoteDescription(t);for(let i of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(i);return this.publishConnection.initAfterJoin(),!!t})}performPublishRenegotiation(e){return c(this,null,function*(){o.d(P,"\u23F3 [role=PUBLISH] onRenegotiationNeeded START",this.trackStates);let t=this.callbacks.get(Le);if(!!t){if(!this.publishConnection){o.e(P,"Publish peer connection not found, cannot renegotiate");return}try{let i=yield this.publishConnection.createOffer(this.trackStates,e);yield this.publishConnection.setLocalDescription(i),o.time("renegotiation-offer-exchange");let r=yield this.signal.offer(i,this.trackStates);this.callbacks.delete(Le),o.timeEnd("renegotiation-offer-exchange"),yield this.publishConnection.setRemoteDescription(r),t.promise.resolve(!0),o.d(P,"[role=PUBLISH] onRenegotiationNeeded DONE \u2705")}catch(i){let r;i instanceof T?r=i:r=m.GenericErrors.Unknown(p.PUBLISH,i.message),t.promise.reject(r),o.d(P,"[role=PUBLISH] onRenegotiationNeeded FAILED \u274C")}}})}handleIceConnectionFailure(e,t){return c(this,null,function*(){this.retryScheduler.isTaskInProgress(G.Publish?C.PublishIceConnectionFailed:C.SubscribeIceConnectionFailed)||(e===G.Publish?this.retryScheduler.schedule({category:C.PublishIceConnectionFailed,error:t,task:this.retryPublishIceFailedTask,originalState:R.Joined}):this.retryScheduler.schedule({category:C.SubscribeIceConnectionFailed,error:t,task:this.retrySubscribeIceFailedTask,originalState:R.Joined,maxFailedRetries:1}))})}internalConnect(e,t,i){return c(this,null,function*(){o.d(P,"connect: started \u23F0");let r=new Date;try{return this.analyticsTimer.start(M.INIT),this.initConfig=yield At.fetchInitConfig({token:e,peerId:i,userAgent:this.store.getUserAgent(),initEndpoint:t}),this.analyticsTimer.end(M.INIT),oe.setWebsocketEndpoint(this.initConfig.endpoint),this.validateNotDisconnected("post init"),yield this.openSignal(e,i),this.store.setSimulcastEnabled(this.isFlagEnabled(de.FLAG_SERVER_SIMULCAST)),o.d(P,"Adding Analytics Transport: JsonRpcSignal"),this.analyticsEventsService.setTransport(this.analyticsSignalTransport),this.analyticsEventsService.flush(),this.initConfig}catch(s){throw this.state!==R.Reconnecting&&this.eventBus.analytics.publish(H.connect(s,this.getAdditionalAnalyticsProperties(),r,new Date,t)),o.d(P,"\u274C internal connect: failed",s),s}})}validateNotDisconnected(e){if(this.state===R.Disconnected)throw o.w(P,"aborting join as transport state is disconnected"),m.GenericErrors.ValidationFailed(`leave called before join could complete - stage=${e}`)}openSignal(e,t){return c(this,null,function*(){if(!this.initConfig)throw m.InitAPIErrors.InitConfigNotAvailable(p.INIT,"Init Config not found");o.d(P,"\u23F3 internal connect: connecting to ws endpoint",this.initConfig.endpoint);let i=new URL(this.initConfig.endpoint);i.searchParams.set("peer",t),i.searchParams.set("token",e),i.searchParams.set("user_agent_v2",this.store.getUserAgent()),this.endpoint=i.toString(),this.analyticsTimer.start(M.WEBSOCKET_CONNECT),yield this.signal.open(this.endpoint),this.analyticsTimer.end(M.WEBSOCKET_CONNECT),this.analyticsTimer.start(M.ON_POLICY_CHANGE),this.analyticsTimer.start(M.ROOM_STATE),o.d(P,"\u2705 internal connect: connected to ws endpoint")})}initRtcStatsMonitor(){return c(this,null,function*(){var e,t,i;(i=this.webrtcInternals)==null||i.setPeerConnections({publish:(e=this.publishConnection)==null?void 0:e.nativeConnection,subscribe:(t=this.subscribeConnection)==null?void 0:t.nativeConnection})})}doesRoleNeedWebRTC(e){var r,s;if(!this.isFlagEnabled(de.FLAG_NON_WEBRTC_DISABLE_OFFER))return!0;let t=Boolean(e.publishParams.allowed&&((r=e.publishParams.allowed)==null?void 0:r.length)>0),i=Boolean(e.subscribeParams.subscribeToRoles&&((s=e.subscribeParams.subscribeToRoles)==null?void 0:s.length)>0);return t||i}doesLocalPeerNeedWebRTC(){var t;let e=(t=this.store.getLocalPeer())==null?void 0:t.role;return e?this.doesRoleNeedWebRTC(e):!0}handleSubscribeConnectionConnected(){var t;(t=this.subscribeConnection)==null||t.logSelectedIceCandidatePairs();let e=this.callbacks.get(_e);this.callbacks.delete(_e),e&&e.promise.resolve(!0)}setTransportStateForConnect(){if(this.state===R.Failed&&(this.state=R.Disconnected),this.state!==R.Disconnected&&this.state!==R.Reconnecting)throw m.WebsocketMethodErrors.AlreadyJoined(p.JOIN,`Cannot join a meeting in ${this.state} state`);this.state===R.Disconnected&&(this.state=R.Connecting,this.observer.onStateChange(this.state))}sendErrorAnalyticsEvent(e,t){let i=this.getAdditionalAnalyticsProperties(),r;switch(t){case C.ConnectFailed:r=H.connect(e,i);break;case C.SignalDisconnect:r=H.disconnect(e,i);break;case C.JoinWSMessageFailed:r=H.join({error:e,time:this.analyticsTimer.getTimeTaken(M.JOIN),init_response_time:this.analyticsTimer.getTimeTaken(M.INIT),ws_connect_time:this.analyticsTimer.getTimeTaken(M.WEBSOCKET_CONNECT),on_policy_change_time:this.analyticsTimer.getTimeTaken(M.ON_POLICY_CHANGE),local_audio_track_time:this.analyticsTimer.getTimeTaken(M.LOCAL_AUDIO_TRACK),local_video_track_time:this.analyticsTimer.getTimeTaken(M.LOCAL_VIDEO_TRACK),retries_join:this.joinRetryCount});break;case C.PublishIceConnectionFailed:r=H.publish({error:e});break;case C.SubscribeIceConnectionFailed:r=H.subscribeFail(e);break}this.eventBus.analytics.publish(r)}getAdditionalAnalyticsProperties(){var n,d,l,h,u,S,g,E;let e=ur(),t=typeof document!="undefined"&&document.hidden,i=this.store.getRemoteVideoTracks().filter(N=>N.degraded).length,r=(h=(l=(d=(n=this.getWebrtcInternals())==null?void 0:n.getCurrentStats())==null?void 0:d.getLocalPeerStats())==null?void 0:l.publish)==null?void 0:h.bitrate,s=(E=(g=(S=(u=this.getWebrtcInternals())==null?void 0:u.getCurrentStats())==null?void 0:S.getLocalPeerStats())==null?void 0:g.subscribe)==null?void 0:E.bitrate;return{network_info:e,document_hidden:t,num_degraded_tracks:i,bitrate:{publish:r,subscribe:s},max_sub_bitrate:this.maxSubscribeBitrate,recent_pong_response_times:this.signal.getPongResponseTimes(),transport_state:this.state}}};function bt(a){if(!a||a.length===0)throw m.InitAPIErrors.InvalidTokenFormat(p.INIT,"Token cannot be an empty string or undefined or null");let e=a.split(".");if(e.length!==3)throw m.InitAPIErrors.InvalidTokenFormat(p.INIT,"Expected 3 '.' separate fields - header, payload and signature respectively");let t=atob(e[1]);try{let i=JSON.parse(t);return{roomId:i.room_id,userId:i.user_id,role:i.role}}catch(i){throw m.InitAPIErrors.InvalidTokenFormat(p.INIT,`couldn't parse to json - ${i.message}`)}}var hr={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},pr={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,isJoinInProgress:!1,deviceManagersInitialised:!1},mr=class{constructor(){this.TAG="[HMSSdk]:";this.transportState=R.Disconnected;this.analyticsTimer=new Dt;this.sdkState=v({},pr);this.handleAutoplayError=e=>{var t,i;(i=(t=this.errorListener)==null?void 0:t.onError)==null||i.call(t,e)};this.observer={onNotification:e=>{if(e.method===A.PEER_LEAVE_REQUEST){this.handlePeerLeaveRequest(e.params);return}switch(e.method){case A.POLICY_CHANGE:this.analyticsTimer.end(M.ON_POLICY_CHANGE);break;case A.PEER_LIST:this.analyticsTimer.end(M.PEER_LIST);break;case A.ROOM_STATE:this.analyticsTimer.end(M.ROOM_STATE);break;default:}this.notificationManager.handleNotification(e,this.sdkState.isReconnecting)},onTrackAdd:e=>{this.notificationManager.handleTrackAdd(e)},onTrackRemove:e=>{this.notificationManager.handleTrackRemove(e)},onFailure:e=>{var t;(t=this.errorListener)==null||t.onError(e)},onStateChange:(e,t)=>c(this,null,function*(){var r,s;let i=n=>c(this,null,function*(){var d,l;yield this.internalLeave(!0,n),!this.sdkState.isPreviewInProgress&&!this.sdkState.isJoinInProgress&&((l=(d=this.errorListener)==null?void 0:d.onError)==null||l.call(d,n)),this.sdkState.isReconnecting=!1});switch(e){case R.Preview:case R.Joined:this.transportState===R.Reconnecting&&((r=this.listener)==null||r.onReconnected());break;case R.Failed:yield i(t);break;case R.Reconnecting:this.sdkState.isReconnecting=!0,(s=this.listener)==null||s.onReconnecting(t);break}this.transportState=e,o.d(this.TAG,"Transport State Change",this.transportState)})};this.handlePeerLeaveRequest=e=>{var r;let t=e.requested_by?this.store.getPeerById(e.requested_by):void 0,i={roomEnded:e.room_end,reason:e.reason,requestedBy:t};(r=this.listener)==null||r.onRemovedFromRoom(i),this.internalLeave(!1)};this.handleDeviceChange=e=>{var t,i,r,s,n,d;if(o.d(this.TAG,"Device Change event",e),(i=(t=this.deviceChangeListener)==null?void 0:t.onDeviceChange)==null||i.call(t,e),e.error&&e.type){let l=e.type.includes("audio")?(r=this.localPeer)==null?void 0:r.audioTrack:(s=this.localPeer)==null?void 0:s.videoTrack;(n=this.errorListener)==null||n.onError(e.error),[f.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,f.TracksErrors.DEVICE_IN_USE,f.TracksErrors.DEVICE_NOT_AVAILABLE].includes(e.error.code)&&l&&(l.setEnabled(!1),(d=this.listener)==null||d.onTrackUpdate(D.TRACK_MUTED,l,this.localPeer))}};this.handleAudioPluginError=e=>{var t;o.e(this.TAG,"Audio Plugin Error event",e),(t=this.errorListener)==null||t.onError(e)};this.handleLocalRoleUpdate=i=>c(this,[i],function*({oldRole:e,newRole:t}){var r;yield this.transport.handleLocalRoleUpdate({oldRole:e,newRole:t}),yield(r=this.roleChangeManager)==null?void 0:r.handleLocalPeerRoleUpdate({oldRole:e,newRole:t})});this.sendAudioPresenceFailed=()=>{let e=m.TracksErrors.NoAudioDetected(p.PREVIEW);o.w(this.TAG,"Audio Presence Failure",this.transportState,e)};this.sendJoinAnalyticsEvent=(e=!1,t)=>{this.eventBus.analytics.publish(H.join(L(v({error:t},this.analyticsTimer.getTimes()),{time:this.analyticsTimer.getTimeTaken(M.JOIN),is_preview_called:e})))};this.sendPreviewAnalyticsEvent=e=>{this.eventBus.analytics.publish(H.preview(L(v({error:e},this.analyticsTimer.getTimes(M.ROOM_STATE)),{time:this.analyticsTimer.getTimeTaken(M.PREVIEW)})))};this.sendAnalyticsEvent=e=>{this.analyticsEventsService.queue(e).flush()}}initStoreAndManagers(){if(this.sdkState.isInitialised){this.notificationManager.setListener(this.listener),this.audioSinkManager.setListener(this.listener);return}this.sdkState.isInitialised=!0,this.store=new pt,this.eventBus=new Wt,this.networkTestManager=new Vt(this.eventBus,this.listener),this.playlistManager=new Et(this,this.eventBus),this.notificationManager=new vt(this.store,this.eventBus,this.listener,this.audioListener),this.deviceManager=new gt(this.store,this.eventBus),this.audioSinkManager=new mt(this.store,this.deviceManager,this.eventBus),this.audioOutput=new St(this.deviceManager,this.audioSinkManager),this.audioSinkManager.setListener(this.listener),this.eventBus.autoplayError.subscribe(this.handleAutoplayError),this.localTrackManager=new ge(this.store,this.observer,this.deviceManager,this.eventBus,this.analyticsTimer),this.analyticsEventsService=new $t(this.store),this.transport=new It(this.observer,this.deviceManager,this.store,this.eventBus,this.analyticsEventsService,this.analyticsTimer),this.eventBus.analytics.subscribe(this.sendAnalyticsEvent),this.eventBus.deviceChange.subscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.subscribe(this.handleAudioPluginError)}validateJoined(e){if(!this.localPeer)throw m.GenericErrors.NotConnected(p.VALIDATION,`Not connected - ${e}`)}refreshDevices(){return c(this,null,function*(){this.validateJoined("refreshDevices"),yield this.deviceManager.init(!0)})}getWebrtcInternals(){var e;return(e=this.transport)==null?void 0:e.getWebrtcInternals()}getPlaylistManager(){return this.playlistManager}getRecordingState(){var e;return(e=this.store.getRoom())==null?void 0:e.recording}getRTMPState(){var e;return(e=this.store.getRoom())==null?void 0:e.rtmp}getHLSState(){var e;return(e=this.store.getRoom())==null?void 0:e.hls}get localPeer(){var e;return(e=this.store)==null?void 0:e.getLocalPeer()}preview(e,t){return c(this,null,function*(){if(di(),ci(),this.sdkState.isPreviewInProgress)return Promise.reject(m.GenericErrors.PreviewAlreadyInProgress(p.PREVIEW,"Preview already called"));this.analyticsTimer.start(M.PREVIEW),this.setUpPreview(e,t),e.alwaysRequestPermissions&&this.localTrackManager.requestPermissions().then(()=>c(this,null,function*(){yield this.initDeviceManagers()}));let i=!1,r=!1,s=setTimeout(()=>{var n,d;(!i||!r)&&((d=(n=this.listener)==null?void 0:n.onNetworkQuality)==null||d.call(n,-1))},3e3);return new Promise((n,d)=>{let l=()=>c(this,null,function*(){var S;if(this.localPeer){let g=e.asRole&&this.store.getPolicyForRole(e.asRole);this.localPeer.asRole=g||this.localPeer.role}let u=yield this.localTrackManager.getTracksToPublish(e.settings||hr);u.forEach(g=>this.setLocalPeerTrack(g)),((S=this.localPeer)==null?void 0:S.audioTrack)&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),this.sdkState.isPreviewInProgress=!1,this.analyticsTimer.end(M.PREVIEW),t.onPreview(this.store.getRoom(),u),this.sendPreviewAnalyticsEvent(),n()}),h=u=>{var S;this.analyticsTimer.end(M.PREVIEW),u&&((S=this.errorListener)==null||S.onError(u)),this.sendPreviewAnalyticsEvent(u),this.sdkState.isPreviewInProgress=!1,d(u)};this.eventBus.policyChange.subscribeOnce(l),this.eventBus.leave.subscribeOnce(h),this.transport.preview(e.authToken,e.initEndpoint,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.autoVideoSubscribe).then(u=>{var S;i=!0,clearTimeout(s),u&&e.captureNetworkQualityInPreview&&this.networkTestManager.start((S=u.config)==null?void 0:S.networkHealth).then(()=>{r=!0})}).catch(h)})})}join(e,t){return c(this,null,function*(){var l,h,u,S,g,E;if(di(),ci(),this.sdkState.isPreviewInProgress)throw m.GenericErrors.NotReady(p.JOIN,"Preview is in progress, can't join");this.analyticsTimer.start(M.JOIN),this.sdkState.isJoinInProgress=!0;let i=this.transportState===R.Preview,{roomId:r,userId:s,role:n}=bt(e.authToken),d=((h=(l=this.localPeer)==null?void 0:l.asRole)==null?void 0:h.name)||((S=(u=this.localPeer)==null?void 0:u.role)==null?void 0:S.name);(g=this.networkTestManager)==null||g.stop(),this.listener=t,this.commonSetup(e,r,t),this.removeDevicesFromConfig(e),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),ne.resumeContext(),this.localPeer?(this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(n),this.localPeer.customerUserId=s,this.localPeer.metadata=e.metaData,delete this.localPeer.asRole):this.createAndAddLocalPeerToStore(e,n,s),this.roleChangeManager=new ht(this.store,this.transport,this.getAndPublishTracks.bind(this),this.removeTrack.bind(this),this.listener),this.eventBus.localRoleUpdate.subscribe(this.handleLocalRoleUpdate),o.d(this.TAG,"SDK Store",this.store),o.d(this.TAG,`\u23F3 Joining room ${r}`),o.time(`join-room-${r}`);try{yield this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData},e.initEndpoint,e.autoVideoSubscribe),o.d(this.TAG,`\u2705 Joined room ${r}`),this.analyticsTimer.start(M.PEER_LIST),yield this.notifyJoin(),this.sdkState.isJoinInProgress=!1,this.sendJoinAnalyticsEvent(i),yield this.publish(e.settings||hr,d)}catch(N){throw this.analyticsTimer.end(M.JOIN),this.sdkState.isJoinInProgress=!1,(E=this.listener)==null||E.onError(N),this.sendJoinAnalyticsEvent(i,N),o.e(this.TAG,"Unable to join room",N),N}o.timeEnd(`join-room-${r}`)})}stringifyMetadata(e){e.metaData&&typeof e.metaData!="string"?e.metaData=JSON.stringify(e.metaData):e.metaData||(e.metaData="")}cleanUp(){var e,t;this.cleanDeviceManagers(),this.eventBus.analytics.unsubscribe(this.sendAnalyticsEvent),this.analyticsTimer.cleanUp(),Y.cleanup(),this.playlistManager.cleanup(),o.cleanUp(),this.sdkState=v({},pr),this.localPeer&&((e=this.localPeer.audioTrack)==null||e.cleanup(),this.localPeer.audioTrack=void 0,(t=this.localPeer.videoTrack)==null||t.cleanup(),this.localPeer.videoTrack=void 0),this.store.cleanUp(),this.listener=void 0,this.roleChangeManager&&this.eventBus.localRoleUpdate.unsubscribe(this.handleLocalRoleUpdate)}leave(e){return this.internalLeave(e)}internalLeave(e=!0,t){return c(this,null,function*(){var r,s;let i=this.store.getRoom();if(i){let n=i.id;(r=this.networkTestManager)==null||r.stop(),this.eventBus.leave.publish(t),o.d(this.TAG,`\u23F3 Leaving room ${n}`),yield(s=this.transport)==null?void 0:s.leave(e),this.cleanUp(),o.d(this.TAG,`\u2705 Left room ${n}`)}})}getLocalPeer(){return this.store.getLocalPeer()}getPeers(){let e=this.store.getPeers();return e.length<50&&o.d(this.TAG,`Got peers(${e.length})`,e.toString()),e}getAudioOutput(){return this.audioOutput}sendMessage(e,t){this.sendMessageInternal({message:t,type:e})}sendBroadcastMessage(e,t){return c(this,null,function*(){return yield this.sendMessageInternal({message:e,type:t})})}sendGroupMessage(e,t,i){return c(this,null,function*(){let r=this.store.getKnownRoles();if((t.filter(n=>r[n.name])||[]).length===0)throw m.GenericErrors.ValidationFailed("No valid role is present",t);return yield this.sendMessageInternal({message:e,recipientRoles:t,type:i})})}sendDirectMessage(e,t,i){return c(this,null,function*(){var s;if(!this.store.getPeerById(t.peerId))throw m.GenericErrors.ValidationFailed("Invalid peer - peer not present in the room",t);if(((s=this.localPeer)==null?void 0:s.peerId)===t.peerId)throw m.GenericErrors.ValidationFailed("Cannot send message to self");return yield this.sendMessageInternal({message:e,recipientPeer:t,type:i})})}sendMessageInternal(s){return c(this,arguments,function*({recipientRoles:e,recipientPeer:t,type:i="chat",message:r}){if(r.replace(/\u200b/g," ").trim()==="")throw o.w(this.TAG,"sendMessage","Ignoring empty message send"),m.GenericErrors.ValidationFailed("Empty message not allowed");let n=new Me({sender:this.localPeer,type:i,message:r,recipientPeer:t,recipientRoles:e,time:new Date});o.d(this.TAG,"Sending Message: ",n);let d=yield this.transport.sendMessage(n);return n.time=new Date(d.timestamp),n})}startScreenShare(e,t){return c(this,null,function*(){var d,l,h;let i=this.store.getPublishParams();if(!i)return;let{allowed:r}=i;if(!(r&&r.includes("screen"))){o.e(this.TAG,`Role ${(d=this.localPeer)==null?void 0:d.role} cannot share screen`);return}if((h=(l=this.localPeer)==null?void 0:l.auxiliaryTracks)==null?void 0:h.find(u=>u.source==="screen"))throw Error("Cannot share multiple screens");let n=yield this.getScreenshareTracks(e,t);if(!this.localPeer){o.d(this.TAG,"Screenshared when not connected"),n.forEach(u=>{u.cleanup()});return}yield this.transport.publish(n),n.forEach(u=>{var S,g,E;u.peerId=(S=this.localPeer)==null?void 0:S.peerId,(g=this.localPeer)==null||g.auxiliaryTracks.push(u),(E=this.listener)==null||E.onTrackUpdate(D.TRACK_ADDED,u,this.localPeer)})})}stopEndedScreenshare(e){return c(this,null,function*(){o.d(this.TAG,"\u2705 Screenshare ended natively"),yield this.stopScreenShare(),e()})}stopScreenShare(){return c(this,null,function*(){var t;o.d(this.TAG,"\u2705 Screenshare ended from app");let e=(t=this.localPeer)==null?void 0:t.auxiliaryTracks.filter(i=>i.source==="screen");if(e)for(let i of e)yield this.removeTrack(i.trackId)})}addTrack(e,t="regular"){return c(this,null,function*(){var h,u,S,g;if(!e){o.w(this.TAG,"Please pass a valid MediaStreamTrack");return}if(!this.localPeer)throw m.GenericErrors.NotConnected(p.VALIDATION,"No local peer present, cannot addTrack");if(this.localPeer.auxiliaryTracks.find(E=>E.trackId===e.id))return;let r=e.kind,s=new MediaStream([e]),n=new ke(s),d=r==="audio"?fe:z,l=new d(n,e,t,this.eventBus);this.setPlaylistSettings({track:e,hmsTrack:l,source:t}),yield(h=this.transport)==null?void 0:h.publish([l]),l.peerId=(u=this.localPeer)==null?void 0:u.peerId,(S=this.localPeer)==null||S.auxiliaryTracks.push(l),(g=this.listener)==null||g.onTrackUpdate(D.TRACK_ADDED,l,this.localPeer)})}removeTrack(e,t=!1){return c(this,null,function*(){var r;if(!this.localPeer)throw m.GenericErrors.NotConnected(p.VALIDATION,"No local peer present, cannot removeTrack");let i=this.localPeer.auxiliaryTracks.findIndex(s=>s.trackId===e);if(i>-1){let s=this.localPeer.auxiliaryTracks[i];s.isPublished?yield this.transport.unpublish([s]):yield s.cleanup(),t||this.stopPlaylist(s),this.localPeer.auxiliaryTracks.splice(i,1),(r=this.listener)==null||r.onTrackUpdate(D.TRACK_REMOVED,s,this.localPeer)}else o.w(this.TAG,`No track found for ${e}`)})}setAnalyticsLevel(e){this.analyticsEventsService.level=e}setLogLevel(e){o.level=e}addAudioListener(e){this.audioListener=e,this.notificationManager.setAudioListener(e)}addConnectionQualityListener(e){this.notificationManager.setConnectionQualityListener(e)}changeRole(e,t,i=!1){return c(this,null,function*(){var r;!e.role||e.role.name===t||(yield(r=this.transport)==null?void 0:r.changeRoleOfPeer(e,t,i))})}changeRoleOfPeer(e,t,i=!1){return c(this,null,function*(){var r;!e.role||e.role.name===t||(yield(r=this.transport)==null?void 0:r.changeRoleOfPeer(e,t,i))})}changeRoleOfPeersWithRoles(e,t){return c(this,null,function*(){var i;e.length<=0||!t||(yield(i=this.transport)==null?void 0:i.changeRoleOfPeersWithRoles(e,t))})}acceptChangeRole(e){return c(this,null,function*(){var t;yield(t=this.transport)==null?void 0:t.acceptRoleChange(e)})}endRoom(e,t){return c(this,null,function*(){var i;if(!this.localPeer)throw m.GenericErrors.NotConnected(p.VALIDATION,"No local peer present, cannot end room");yield(i=this.transport)==null?void 0:i.endRoom(e,t),yield this.leave()})}removePeer(e,t){return c(this,null,function*(){var i;if(!this.localPeer)throw m.GenericErrors.NotConnected(p.VALIDATION,"No local peer present, cannot remove peer");if(!this.store.getPeerById(e.peerId))throw m.GenericErrors.ValidationFailed("Invalid peer, given peer not present in room",e);yield(i=this.transport)==null?void 0:i.removePeer(e.peerId,t)})}startRTMPOrRecording(e){return c(this,null,function*(){var t;if(!this.localPeer)throw m.GenericErrors.NotConnected(p.VALIDATION,"No local peer present, cannot start streaming or recording");yield(t=this.transport)==null?void 0:t.startRTMPOrRecording(e)})}stopRTMPAndRecording(){return c(this,null,function*(){var e;if(!this.localPeer)throw m.GenericErrors.NotConnected(p.VALIDATION,"No local peer present, cannot stop streaming or recording");yield(e=this.transport)==null?void 0:e.stopRTMPOrRecording()})}startHLSStreaming(e){return c(this,null,function*(){var t;if(!this.localPeer)throw m.GenericErrors.NotConnected(p.VALIDATION,"No local peer present, cannot start HLS streaming");yield(t=this.transport)==null?void 0:t.startHLSStreaming(e)})}stopHLSStreaming(e){return c(this,null,function*(){var t;if(!this.localPeer)throw m.GenericErrors.NotConnected(p.VALIDATION,"No local peer present, cannot stop HLS streaming");yield(t=this.transport)==null?void 0:t.stopHLSStreaming(e)})}sendHLSTimedMetadata(e){return c(this,null,function*(){var t;this.validateJoined("sendHLSTimedMetadata"),yield(t=this.transport)==null?void 0:t.sendHLSTimedMetadata(e)})}changeName(e){return c(this,null,function*(){var t;this.validateJoined("changeName"),yield(t=this.transport)==null?void 0:t.changeName(e),this.notificationManager.updateLocalPeer({name:e})})}changeMetadata(e){return c(this,null,function*(){var t;this.validateJoined("changeMetadata"),yield(t=this.transport)==null?void 0:t.changeMetadata(e),this.notificationManager.updateLocalPeer({metadata:e})})}setSessionMetadata(e){return c(this,null,function*(){yield this.transport.setSessionMetadata(e)})}getSessionMetadata(){return c(this,null,function*(){return(yield this.transport.getSessionMetadata()).data})}getRoles(){return Object.values(this.store.getKnownRoles())}changeTrackState(e,t){return c(this,null,function*(){var r;if(e.type===F.VIDEO&&e.source!=="regular"){o.w(this.TAG,"Muting non-regular video tracks is currently not supported");return}if(e.enabled===t){o.w(this.TAG,`Aborting change track state, track already has enabled - ${t}`,e);return}if(!this.store.getTrackById(e.trackId))throw m.GenericErrors.ValidationFailed("No track found for change track state",e);let i=this.store.getPeerByTrackId(e.trackId);if(!i)throw m.GenericErrors.ValidationFailed("No peer found for change track state",e);yield(r=this.transport)==null?void 0:r.changeTrackState({requested_for:i.peerId,track_id:e.trackId,stream_id:e.stream.id,mute:!t})})}changeMultiTrackState(e){return c(this,null,function*(){var n;if(typeof e.enabled!="boolean")throw m.GenericErrors.ValidationFailed("Pass a boolean for enabled");let{enabled:t,roles:i,type:r,source:s}=e;yield(n=this.transport)==null?void 0:n.changeMultiTrackState({value:!t,type:r,source:s,roles:i==null?void 0:i.map(d=>d==null?void 0:d.name)})})}setFrameworkInfo(e){this.frameworkInfo=e}publish(e,t){return c(this,null,function*(){var i,r,s;if([this.store.getPublishParams(),!this.sdkState.published,!ue].every(n=>!!n)){let n=t&&t!==((r=(i=this.localPeer)==null?void 0:i.role)==null?void 0:r.name)?()=>{var d;return(d=this.roleChangeManager)==null?void 0:d.diffRolesAndPublishTracks({oldRole:this.store.getPolicyForRole(t),newRole:this.localPeer.role})}:()=>this.getAndPublishTracks(e);yield(s=n==null?void 0:n())==null?void 0:s.catch(d=>{var l;o.e(this.TAG,"Error in publish",d),(l=this.listener)==null||l.onError(d)})}})}getAndPublishTracks(e){return c(this,null,function*(){var i,r;let t=yield this.localTrackManager.getTracksToPublish(e);yield this.setAndPublishTracks(t),(r=(i=this.localPeer)==null?void 0:i.audioTrack)==null||r.initAudioLevelMonitor(),this.sdkState.published=!0})}setAndPublishTracks(e){return c(this,null,function*(){var t;for(let i of e)yield this.transport.publish([i]),this.setLocalPeerTrack(i),(t=this.listener)==null||t.onTrackUpdate(D.TRACK_ADDED,i,this.localPeer);yield this.initDeviceManagers()})}setLocalPeerTrack(e){var t;switch(e.peerId=(t=this.localPeer)==null?void 0:t.peerId,e.type){case F.AUDIO:this.localPeer.audioTrack=e;break;case F.VIDEO:this.localPeer.videoTrack=e;break}}initDeviceManagers(){return c(this,null,function*(){var e,t,i,r,s;this.sdkState.deviceManagersInitialised||(this.sdkState.deviceManagersInitialised=!0,yield this.deviceManager.init(),(yield this.deviceManager.updateOutputDevice((t=(e=this.store.getConfig())==null?void 0:e.settings)==null?void 0:t.audioOutputDeviceId))||(yield this.deviceManager.updateOutputDevice((r=(i=Y.getSelection())==null?void 0:i.audioOutput)==null?void 0:r.deviceId)),this.audioSinkManager.init((s=this.store.getConfig())==null?void 0:s.audioSinkElementId))})}cleanDeviceManagers(){this.eventBus.deviceChange.unsubscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.unsubscribe(this.handleAudioPluginError),this.eventBus.autoplayError.unsubscribe(this.handleAutoplayError),this.deviceManager.cleanUp(),this.audioSinkManager.cleanUp()}initPreviewTrackAudioLevelMonitor(){var t;let e=(t=this.localPeer)==null?void 0:t.audioTrack;e==null||e.initAudioLevelMonitor(),this.eventBus.trackAudioLevelUpdate.subscribe(i=>{var s;let r=i&&i.track.trackId===(e==null?void 0:e.trackId)?[{audioLevel:i.audioLevel,peer:this.localPeer,track:e}]:[];this.store.updateSpeakers(r),(s=this.audioListener)==null||s.onAudioLevelUpdate(r)}),this.eventBus.localAudioSilence.subscribe(this.sendAudioPresenceFailed)}notifyJoin(){var i;let e=this.store.getLocalPeer(),t=this.store.getRoom();if(t.joinedAt=new Date,e&&(e.joinedAt=t.joinedAt),e==null?void 0:e.role){this.analyticsTimer.end(M.JOIN),(i=this.listener)==null||i.onJoin(t);return}return new Promise((r,s)=>{this.eventBus.policyChange.subscribeOnce(()=>{var n;this.analyticsTimer.end(M.JOIN),(n=this.listener)==null||n.onJoin(t),r()}),this.eventBus.leave.subscribeOnce(n=>{s(n)})})}setUpPreview(e,t){this.listener=t,this.sdkState.isPreviewInProgress=!0;let{roomId:i,userId:r,role:s}=bt(e.authToken);this.commonSetup(e,i,t),this.store.setConfig(e),this.store.createAndSetUserAgent(this.frameworkInfo),this.createAndAddLocalPeerToStore(e,s,r,e.asRole),o.d(this.TAG,"SDK Store",this.store)}setPlaylistSettings(r){return c(this,arguments,function*({track:e,hmsTrack:t,source:i}){if(i==="videoplaylist"){let s={};if(e.kind==="audio")s.maxBitrate=64;else{s.maxBitrate=1e3;let{width:n,height:d}=e.getSettings();s.width=n,s.height=d}yield t.setSettings(s)}else i==="audioplaylist"&&(yield t.setSettings({maxBitrate:64}))})}createAndAddLocalPeerToStore(e,t,i,r){let s=this.store.getPolicyForRole(t),n=r?this.store.getPolicyForRole(r):void 0,d=new Ze({name:e.userName||"",customerUserId:i,metadata:e.metaData||"",role:s,asRole:n||s});this.store.addPeer(d)}commonSetup(e,t,i){this.stringifyMetadata(e),e.initEndpoint||(e.initEndpoint="https://prod-init.100ms.live"),this.errorListener=i,this.deviceChangeListener=i,this.initStoreAndManagers(),this.store.setErrorListener(this.errorListener),this.store.getRoom()||this.store.setRoom(new ze(t,this.store))}removeDevicesFromConfig(e){this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId)}getScreenshareTracks(e,t){return c(this,null,function*(){let[i,r]=yield this.localTrackManager.getLocalScreen(t),s=()=>{this.stopEndedScreenshare(e)},n=[];if(t==null?void 0:t.audioOnly){if(i.nativeTrack.stop(),!r)throw m.TracksErrors.NothingToReturn(p.TRACK,"Select share audio when sharing screen","No audio found");n.push(r),r.nativeTrack.onended=s}else n.push(i),i.nativeTrack.onended=s,r&&n.push(r);return n})}stopPlaylist(e){e.source==="audioplaylist"?this.playlistManager.stop(b.audio):e.source==="videoplaylist"&&this.playlistManager.stop(b.video)}};function Kr(){return c(this,null,function*(){let a=new Q().build(),e=new ee().build();try{(yield at(e)).stop()}catch(i){if(qr(i))throw(yield Ft({audio:!1,video:!0})).getTracks().forEach(s=>s.stop()),i}return(yield nt(a)).stop(),!1})}function qr(a){return a instanceof T&&a.action===p.TRACK}o.i("adapter",`${vi.default.browserDetails.browser} v${vi.default.browserDetails.version}`);
//# sourceMappingURL=index.cjs.js.map
